<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CreateMode - Goalio Skin</title>
    
    <!-- Using Font Awesome from goalio.html and GLPLv6.html -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" href="./icon-192x192.png" type="image/png">
    <link rel="shortcut icon" href="./icon-192x192.png" type="image/png">
    <link rel="apple-touch-icon" href="./icon-192x192.png">
    <link rel="manifest" href="./manifest.webmanifest">
    
    <style>
        /* --- GLOBAL STYLES & VARIABLES (Inspired by goalio.html) --- */
        :root {
            --primary-color: #0f172a; /* goalio: Dark Blue/Slate */
            --primary-hover: #1e293b; /* goalio: Darker Slate */
            --warning-color: #ef4444; /* goalio: Red */
            --warning-hover: #d03838;
            --info-color: #3b82f6; /* goalio: Blue */
            --star-important-color: #facc15; /* goalio: Yellow */
            --success-color: #22c55e; /* goalio: Green */
            
            --bg-color: #f8fafc; /* goalio: Light Gray */
            --text-color: #0f172a; /* goalio: Dark Blue/Slate */
            --text-light: #64748b; /* goalio: Lighter Slate */
            --card-bg: #ffffff; /* goalio: White */
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --border-color: #e2e8f0; /* goalio: Light Gray Border */
            --input-bg: #ffffff;
            
            --quest-done-bg: #eef2ff; /* goalio: Light Blue/Indigo for done */
            --quest-done-text: var(--primary-color);
            --quest-overdue-border: var(--warning-color); 
            --disabled-opacity: 0.6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; } 

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            font-size: 15px;
            /* Padding will be on .app-container-wrapper instead of body directly */
        }
        
        /* --- APP HEADER (Styling from GLPLv6.html, colors from goalio.html theme) --- */
        .app-header {
            background-color: var(--card-bg); /* Match card background for header */
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000; 
            box-shadow: var(--shadow);
        }
        .app-header-title {
            font-size: 1.5em; 
            font-weight: 600;
            color: var(--primary-color);
            text-align: center;
            flex-grow: 1;
        }
        .app-header-actions button {
            background: transparent; border: none; color: var(--primary-color);
            padding: 0.5rem; border-radius: 50%; cursor: pointer;
            font-size: 1.1rem; width: 2.5rem; height: 2.5rem;
            display: flex; align-items: center; justify-content: center;
            transition: background-color 0.2s ease-in-out;
        }
        .app-header-actions button:hover { background-color: #f1f5f9; } /* Light gray hover */
        .app-header-actions .left-action { margin-right: auto; }
        .app-header-actions .right-action { margin-left: auto; }

        .app-container-wrapper { 
            max-width: 900px; /* Consistent with GLPLv6 */
            margin: 1rem auto;
            padding: 0 1rem; /* Padding for content area */
        }
        
        h2, h3, h4 {
            color: var(--text-color);
            margin-bottom: 10px;
            font-weight: 600;
        }
        /* Styling for section headers to be like goalio.html's .goal-section-header > h3 */
        .quest-list-section > h2, 
        .quest-list-section .quest-list-section-header > span { /* For Completed/Archived title span */
            font-size: 1.25rem; 
            color: var(--primary-color);
            display: flex; 
            align-items: center; 
            gap: 0.5rem;
            margin-bottom: 1rem; 
            padding-bottom: 0.75rem; 
            border-bottom: 2px solid var(--primary-color); 
        }
        .quest-list-section > h2 { /* For Active Quests H2 */
             justify-content: center; /* Center if it's just text */
        }
        .app-container-wrapper > .quest-list-section:first-of-type > h2,
        .app-container-wrapper > .dashboard:first-of-type + .quest-list-section > h2 {
            margin-top: 0;
        }
         h3 { font-size: 1.1em; } /* For modal titles etc. */
         h4 { font-size: 1em; }


        button, .button {
            cursor: pointer;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem; /* goalio modal buttons */
            border: 1px solid var(--border-color); /* Default border */
            font-weight: 500;
            font-size: 0.875rem; /* goalio modal buttons */
            transition: background-color 0.2s ease, border-color 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem; /* goalio modal buttons */
            background-color: #e2e8f0; /* goalio cancel-btn style as default */
            color: var(--text-light); /* goalio cancel-btn style */
        }
        button:hover, .button:hover {
            background-color: #cbd5e1; /* goalio cancel-btn hover */
            color: var(--text-color);
        }
        button:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible {
            outline: 2px solid var(--info-color);
            outline-offset: 1px;
        }

        .btn-primary { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .btn-primary:hover { background: var(--primary-hover); border-color: var(--primary-hover); }
        
        .btn-danger { background-color: var(--warning-color); color: white; border-color: var(--warning-color); }
        .btn-danger:hover { background-color: var(--warning-hover); border-color: var(--warning-hover); }

        .btn-icon-text { /* For "Add Main Task", "New Template" */
            /* Use general button style, or define specific if needed */
        }
        
        .btn-icon-only { /* General style for icon buttons in cards */
            background: transparent; border: 1px solid transparent; 
            color: var(--text-light); 
            padding: 0.4rem; border-radius: 0.3rem; /* goalio goal-action-btn */
            font-size: 0.9rem; transition: background-color 0.2s, color 0.2s;
            width: 2rem; height: 2rem; 
            display: inline-flex; align-items: center; justify-content: center;
        }
        .btn-icon-only:hover:not(:disabled) { background-color: #e5e7eb; color: var(--text-color); }
        .btn-icon-only.danger:hover { color: var(--warning-color); }


        input[type="text"], input[type="date"], input[type="number"], select, textarea {
            width: 100%; padding: 0.75rem; margin: 0.25rem 0 1rem 0; /* goalio modal inputs */
            border: 1px solid var(--border-color); border-radius: 0.5rem; font-size: 0.9rem;
            background-color: var(--input-bg); color: var(--text-color);
        }
        input[type="checkbox"] {
            width: auto; margin-right: 8px; transform: scale(1.2);
            accent-color: var(--primary-color); /* Match primary theme */
            cursor: pointer;
        }
        textarea { min-height: 70px; resize: vertical; }
        input:disabled, textarea:disabled, select:disabled, input[type="checkbox"]:disabled {
             opacity: var(--disabled-opacity); cursor: not-allowed;
        }


        /* --- DASHBOARD (Top Info Area from GLPLv6, styled like goalio.html's notice-area) --- */
        .dashboard { /* Was .top-info-area */
            border-radius: 1rem; padding: 1rem; margin-bottom: 1.5rem;
            border: 2px solid var(--primary-color); /* goalio notice-area border */
            background-color: var(--card-bg);
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 1rem;
        }
        @media (min-width: 650px) { /* goalio notice-grid responsive */
            .dashboard { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        }

        .dashboard-metric { /* Applied to GLPLv6's .dashboard-metric-item and .info-item */
            padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1.5px solid var(--border-color);
            background-color: var(--card-bg); /* goalio notice-item */
            display: flex; flex-direction: column; justify-content: center; min-height: 70px; /* Adjusted height */
        }
        .dashboard-metric .metric-title { /* goalio notice-item h4 */
            font-size: 0.8rem; font-weight: 600; margin-bottom: 0.25rem; color: var(--text-light);
        }
        .dashboard-metric .metric-value { /* goalio notice-item p */
            color: var(--text-color); font-size: 0.95rem; font-weight: 500; /* Adjusted size */
        }

        /* Calendar Styling (adapting GLPLv6 calendar to goalio theme) */
        .week-calendar-container { /* goalio calendar-container */
            padding: 0.75rem; border: 1.5px solid var(--border-color); 
            border-radius: 0.5rem; background-color: var(--card-bg);
        }
        .week-calendar-header { /* goalio calendar-header */
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1rem; padding: 0 0.1rem;
        }
        .week-calendar-header button { /* goalio calendar-header button */
            background: transparent; border: none; color: var(--primary-color);
            padding: 0.4rem; border-radius: 50%; cursor: pointer;
            font-size: 0.9rem; width: 2rem; height: 2rem;
            display: flex; align-items: center; justify-content: center;
            transition: background-color 0.2s ease-in-out;
        }
        .week-calendar-header button:hover { background-color: #f1f5f9; }
        .week-calendar-month-year { font-size: 1.1rem; font-weight: 600; color: var(--primary-color); }
        .week-calendar-grid, .week-calendar-day-name-row { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .week-calendar-day-name-row { margin-bottom: 0.5rem;}
        .week-calendar-day, .week-calendar-day-name {
            text-align: center; padding: 0.5rem 0.2rem; font-size: 0.85rem;
            border-radius: 0.375rem; 
        }
        .week-calendar-day-name { font-weight: 500; color: var(--text-light); }
        .week-calendar-day {
            cursor: default; border: 1px solid transparent; 
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            min-height: 2.2rem; display: flex; align-items: center; justify-content: center;
        }
        .week-calendar-day.other-month-display { color: #cbd5e1; font-weight: 300; } 
        .week-calendar-day.current-day {
            background-color: var(--primary-color); color: white; font-weight: bold;
            border-color: var(--primary-hover);
        }
        .week-calendar-day:not(.other-month-display):not(.current-day):hover { background-color: #f8fafc; border-color: var(--border-color); }

        #clearDataNotification { /* GLPLv6 styling, fits okay */
            grid-column: 1 / -1; background-color: #fffbeb; color: #b45309; 
            padding: 0.75rem 1rem; border: 1.5px solid #fef3c7;
            border-radius: 0.5rem; font-size: 0.9em;
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 10px;
        }
        #clearDataNotification i { color: #d97706; margin-right: 0.5rem; }
        #clearDataNotification button {
            font-size: 0.85em; background-color: var(--star-important-color);
            color: var(--text-color); border: 1px solid #f59e0b;
            padding: 0.4rem 0.8rem; border-radius: 0.3rem; cursor: pointer;
        }
        #clearDataNotification button:hover { background-color: #f59e0b; }


        /* --- QUEST LIST & CARDS (Structure to mimic goalio.html's goal-card) --- */
        .quest-list-section {
             margin-bottom: 2rem; /* goalio.html goal-section */
        }
        .quest-list-section#activeQuestsSection { margin-bottom: 1.5rem; }

        .quests-list { display: flex; flex-direction: column; gap: 1rem; /* goalio.html goals-list */ }

        .quest-card { /* Based on goalio.html .goal-card */
            border: 1px solid var(--border-color); border-radius: 0.75rem;
            padding: 1.25rem; box-shadow: var(--shadow); 
            display: flex; flex-direction: column; background-color: var(--card-bg); 
            position: relative;
        }
        .quest-card.completed-quest { /* goalio.html .status-done */
            background-color: var(--quest-done-bg); transition: background-color 0.3s ease-in-out;
        }
        .quest-card.completed-quest .quest-title-text { 
            color: var(--quest-done-text); text-decoration: line-through; opacity: 0.7;
        }
        .quest-card.archived-quest { border-left: 4px solid var(--text-light); opacity: 0.7; }
        .quest-card.is-overdue:not(.completed-quest):not(.archived-quest) { 
            border-left: 4px solid var(--quest-overdue-border); 
        }

        /* Star button styling like goalio.html's .star-btn */
        .priority-button-wrapper { /* New wrapper for absolute positioning */
            position: absolute; top: 0.75rem; right: 0.75rem; z-index: 5;
        }
        .priority-button-wrapper .priority-button {
            background: transparent; border: none; color: var(--text-light); 
            font-size: 1.1rem; padding: 0.25rem; cursor: pointer;
            transition: color 0.2s ease-in-out;
        }
        .priority-button-wrapper .priority-button:hover { color: var(--star-important-color); }
        .priority-button-wrapper .priority-button.prioritized i { color: var(--star-important-color); }


        .quest-card-header { /* Contains checkbox and title */
            display: flex; align-items: flex-start; margin-bottom: 0.6rem; gap: 0.5rem;
        }
        .quest-card-header .quest-complete-checkbox { margin-top: 0.2rem; /* Align with title */ }
        .quest-title-text {
            font-size: 1.15rem; font-weight: 600; color: var(--text-color); 
            margin-right: 2.5rem; /* Space for absolutely positioned star and other actions if they were there */
            flex-grow: 1; cursor: pointer;
        }
        .quest-title-text:hover { color: var(--primary-hover); }
        
        /* Description part from GLPLv6, styled like goalio.html .goal-description */
        .quest-description { 
            font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.85rem; 
            max-height: 40px; overflow-y: auto; /* Limit height */
            scrollbar-width: thin; scrollbar-color: var(--border-color) transparent;
        }
        .quest-description::-webkit-scrollbar { width: 5px; }
        .quest-description::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 3px; }


        .quest-card-meta { /* For deadline and value, similar to goalio.html .goal-meta */
            font-size: 0.8rem; color: var(--text-light); 
            margin-bottom: 0.85rem; display: flex; flex-wrap: wrap; 
            gap: 0.5rem 1rem; /* row-gap column-gap */
            align-items: center; 
        }
        .quest-deadline-details { display: flex; align-items: center; gap: 0.5rem; }
        .quest-deadline-details .fa-calendar-alt { font-size: 0.8rem; }
        .quest-deadline-text { font-weight: 500; }
        .quest-countdown { font-weight: 500; display: flex; align-items: center; gap: 0.2rem; }
        .quest-countdown .fa-hourglass-half { font-size: 0.8rem; }
        .quest-countdown-text { font-size: 0.8rem; }
        .quest-countdown.overdue .quest-countdown-text { color: var(--warning-color); font-weight: 600; }
        .quest-countdown.today .quest-countdown-text { color: var(--info-color); font-weight: 600; }
        .quest-value-display { font-weight: 500; font-size: 0.8rem; display: flex; align-items: center; gap: 0.2rem; }
        .quest-value-display .fa-coins { font-size: 0.8rem; color: var(--star-important-color); }


        .quest-progress-wrapper { /* From GLPLv6, fits well */
            display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0 0.85rem 0;
        }
        .quest-progress-bar-container {
            flex-grow: 1; height: 8px; background-color: var(--border-color);
            border-radius: 4px; overflow: hidden;
        }
        .quest-progress-fill {
            height: 100%; background-color: var(--info-color); 
            border-radius: 4px; transition: width 0.3s ease;
        }
        .quest-progress-value-text { font-size: 0.8rem; color: var(--text-light); font-weight: 500; white-space: nowrap; flex-shrink: 0; }

        .quest-card-actions-footer { /* New container for footer actions, like goalio.html .goal-actions */
            display: flex; gap: 0.5rem; margin-top: auto; padding-top: 0.75rem; 
            border-top: 1px solid var(--border-color); 
        }
        /* .quest-card-actions-footer .btn-icon-only is already styled */
        /* Specific button like "Toggle Tasks" if it moves here */
        .quest-card-actions-footer .toggle-tasks-button { /* if it moves to footer */
            /* Similar to goalio's .toggle-done if it becomes a main action */
            flex-grow: 1; background-color: #f8fafc; border: 1px solid var(--border-color);
            color: var(--primary-color); width: auto; gap: 0.3rem; padding: 0.4rem 0.75rem;
        }
         .quest-card-actions-footer .toggle-tasks-button:hover { background-color: var(--primary-color); color: white; }


        .tasks-container { /* From GLPLv6 */
            padding-left: 0; max-height: 0; overflow-y: auto;
            transition: max-height 0.3s ease-out, padding-top 0.3s ease-out, margin-top 0.3s ease-out;
            margin-top: 0; padding-top: 0;
            scrollbar-width: thin; scrollbar-color: var(--border-color) transparent;
        }
        .tasks-container::-webkit-scrollbar { width: 5px; }
        .tasks-container::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 3px; }
        .tasks-container.expanded {
            max-height: 350px; margin-top: 1rem;
            padding-top: 0.75rem; border-top: 1px solid var(--border-color); 
        }
        .task-item, .subtask-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0.25rem; border-bottom: 1px solid #f1f5f9; }
        .task-item:last-child, .subtask-item:last-child { border-bottom: none; }
        .subtask-item { margin-left: 2rem; } 
        .task-description { flex-grow: 1; font-size: 0.9rem; }
        .task-item .task-description { font-weight: 500; } 
        .task-value-chip { /* Only for main tasks without subtasks */
            font-size: 0.75rem; font-weight: 600; color: var(--success-color);
            background-color: #dcfce7; padding: 0.15rem 0.4rem; border-radius: 10px;
            white-space: nowrap; margin-left: auto; margin-right: 0.25rem;
        }
        .task-item.completed .task-description, .subtask-item.completed .task-description {
            text-decoration: line-through; color: var(--text-light); opacity: 0.7;
        }

        /* --- COLLAPSIBLE SECTION CONTROLS (Completed, Archived) --- */
        .inactive-sections-toggle-container { /* Master Toggle Button GLPLv6 */
            text-align: center; margin: 2rem 0 1.5rem 0;
        }
        #toggleInactiveSectionsBtn { /* GLPLv6 button, styled with goalio button style */
            /* Inherits .button styles */
            background: var(--primary-color); color: white;
        }
        #toggleInactiveSectionsBtn:hover { background: var(--primary-hover); }

        .quest-list-section .quest-list-section-header { /* Generalize GLPLv6's style for section titles */
            font-size: 1.25rem; color: var(--primary-color);
            display: flex; align-items: center; justify-content: center; /* Centered title */
            gap: 0.5rem; margin-bottom: 1rem; padding-bottom: 0.75rem; 
            border-bottom: 2px solid var(--primary-color); 
        }
        .quest-list-section .quest-list-section-header .toggle-section-button { /* Chevron for section expand/collapse */
            background: transparent; border: none; color: var(--text-light);
            padding: 0.4rem; border-radius: 50%; cursor: pointer;
            font-size: 0.9rem; width: 2rem; height: 2rem;
            display: flex; align-items: center; justify-content: center;
            transition: color 0.2s ease-in-out; margin-left: auto; /* Pushes button to the right */
        }
        .quest-list-section .quest-list-section-header .toggle-section-button:hover { color: var(--primary-color); }

        .collapsible-list-wrapper { /* GLPLv6 */
            max-height: 0; overflow: hidden;
            transition: max-height 0.3s ease-out, margin-top 0.3s ease-out;
        }
        .collapsible-list-wrapper.expanded { max-height: 1500px; margin-top: 1rem; overflow-y: auto; }

        .empty-list-message { /* GLPLv6 */
           text-align: center; padding: 2rem; color: var(--text-light); 
           font-style: italic; font-size: 0.95em;
           border: 2px dashed var(--border-color);
           border-radius: 0.75rem; margin-top: 1rem;
           background-color: #fdfdfe; /* Slightly off-white */
        }
        
        /* --- MODALS (Styled like goalio.html modals) --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(4px);
            justify-content: center; align-items: center; /* goalio modal alignment */
            z-index: 1050; padding: 1rem; overflow-y: auto; 
        }
        .modal-content {
            background: var(--card-bg); padding: 1.5rem; border-radius: 1rem; width: 100%;
            max-width: 500px; /* Adjusted from goalio's 450px for CreateMode content */
            box-shadow: var(--shadow); margin: 2rem auto; 
        }
        .modal-header { /* GLPLv6 header structure, goalio modal title style */
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .modal-header h2, .modal-content h3#questModalTitle, .modal-content h3#settingsModalTitle { /* goalio modal h3 */
            margin-bottom: 0; font-size: 1.25rem; color: var(--primary-color); border-bottom: none; text-align: left; margin-top:0;
        }
        .close-modal-button { /* From GLPLv6, styled */
            background: transparent; border: none; color: var(--text-light);
            padding: 0.4rem; border-radius: 50%; cursor: pointer;
            font-size: 1.1rem; width: 2.2rem; height: 2.2rem; 
            display: flex; align-items: center; justify-content: center;
            transition: background-color 0.2s, color 0.2s;
        }
        .close-modal-button:hover { background-color: #e5e7eb; color: var(--text-color); }

        .modal-body label { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500; }
        .modal-body h3, .modal-body h4 { margin: 1.5rem 0 0.75rem 0; color: var(--primary-color); border-bottom: none; text-align: left; }
        .modal-body h3 { font-size: 1.1em; } .modal-body h4 { font-size: 1em; }

        .task-editor-item { /* GLPLv6 */
            border: 1px solid var(--border-color); padding: 0.75rem; margin-bottom: 0.75rem;
            border-radius: 0.5rem; background-color: #f9fafb; 
        }
        .task-editor-header { display: flex; gap: 0.5rem; align-items: center; }
        .task-editor-header input[type="text"] { flex-grow: 1; margin-bottom: 0; }
        /* .task-editor-header .btn-icon-only already styled */
        .subtask-editor-item { margin-left: 1.25rem; margin-top: 0.5rem; display: flex; gap: 0.5rem; align-items: center; }
        .subtask-editor-item input[type="text"] { flex-grow: 1; margin-bottom: 0; }
        
        .modal-footer { /* GLPLv6 footer structure, goalio modal button styles */
            display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem; 
            padding-top: 1rem; border-top: 1px solid var(--border-color); 
        }
        /* Buttons in footer use general .button, .btn-primary, .btn-danger */


        /* --- SETTINGS MODAL --- */
        #settingsModal .modal-content { max-width: 700px; } /* GLPLv6 */
        .settings-section { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px dashed var(--border-color); }
        .settings-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        #templateList .template-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 1rem; border: 1px solid var(--border-color);
            border-radius: 0.5rem; margin-bottom: 0.5rem; background-color: var(--input-bg);
        }
        #templateList .template-item.default-template { border-left: 3px solid var(--star-important-color); font-weight: 500; background-color: #fffbeb; }
        #templateList .template-item span { flex-grow: 1; }
        #templateList .template-item .template-actions { display: flex; gap: 0.3rem; }
        #templateList .template-item .template-actions button { /* These are .btn-icon-text or .btn-icon-only */
            font-size: 0.8em; padding: 0.4rem 0.6rem;
        }
        /* Settings modal save/new/clear buttons are styled by .btn-primary, general .button, .btn-danger */


        /* --- TOAST NOTIFICATIONS (GLPLv6, fits goalio theme well) --- */
        #toastContainer {
            position: fixed; bottom: 20px; right: 20px; z-index: 2000; 
            display: flex; flex-direction: column-reverse; gap: 10px; max-width: 350px;
        }
        .toast-message {
            padding: 1rem 1.25rem; border-radius: 0.5rem; color: white; font-size: 0.95em;
            box-shadow: var(--shadow); opacity: 0; word-wrap: break-word;
            animation-name: toastFadeIn, toastFadeOut; animation-duration: 0.3s, 0.3s; 
            animation-fill-mode: forwards, forwards; animation-timing-function: ease-out, ease-in;
            animation-delay: 0s, var(--toast-visible-duration, 3000ms); 
            display: flex; align-items: center; gap: 0.75rem;
        }
        .toast-message i { font-size: 1.2em; } 
        .toast-message.success { background-color: var(--success-color); }
        .toast-message.info { background-color: var(--info-color); }
        .toast-message.warning { background-color: var(--star-important-color); color: var(--text-color); }
        .toast-message.error { background-color: var(--warning-color); }
        @keyframes toastFadeIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes toastFadeOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
        
        /* Animation for exiting quest card (GLPLv6) */
        .quest-card.exiting { animation: fadeOutCollapseQuest 0.35s ease-out forwards; }
        @keyframes fadeOutCollapseQuest { 
            0% { opacity: 1; transform: translateX(0) scale(1); max-height: 400px; padding: 1.25rem; margin-bottom: 1rem; border-width: 1px; }
            to { opacity: 0; transform: translateX(-50px) scale(0.9); max-height: 0; padding-top: 0; padding-bottom: 0; margin-bottom: 0; border-width: 0; overflow: hidden; }
        }
        .quest-card.entering { opacity: 0; transform: translateY(20px) scale(0.95); }

        /* --- RESPONSIVE ADJUSTMENTS --- */
        @media (max-width: 768px) {
            body { font-size: 14px; }
            .app-header-title { font-size: 1.3em; }
            .app-container-wrapper { padding: 0 0.75rem; }
            .dashboard-metric .metric-value { font-size: 1rem; }
            .quest-title-text { font-size: 1.05em; }
            .modal-content { margin: 5% auto; width: 95%; padding: 1.25rem; }
            .modal-header h2, .modal-content h3#questModalTitle, .modal-content h3#settingsModalTitle { font-size: 1.15rem; }
            #toastContainer { right: 10px; bottom: 10px; max-width: calc(100% - 20px); }
        }

        @media (max-width: 480px) {
            .app-header { padding: 0.5rem 0.75rem; }
            .app-header-actions button { width: 2.2rem; height: 2.2rem; font-size: 1rem;}
            .app-container-wrapper { padding: 0 5px; } /* Minimal padding for mobile */

            .quest-card { margin-left:0; margin-right:0; /* Full width feel */ }
            .quests-list { gap: 10px; }

            .quest-card-header { flex-wrap: wrap; } /* Allow checkbox and title to wrap */
            .quest-card-meta { flex-direction: column; align-items: flex-start; gap: 0.3rem; }
            .quest-value-display, .quest-deadline-details { width: 100%; justify-content: flex-start;}
            .priority-button-wrapper { top: 0.5rem; right: 0.5rem; /* Adjust star position */ }
            .quest-card-actions-footer { flex-wrap: wrap; } /* Allow footer buttons to wrap */

            .subtask-item { margin-left: 1.25rem; }
        }
    </style>
</head>
<body>
    <!-- Header from GLPLv6 -->
    <header class="app-header">
        <div class="app-header-actions left-action"><button id="addQuestHeaderBtn" title="Start New Quest" aria-label="Start New Quest"><i class="fas fa-plus-circle"></i></button></div>
        <h1 class="app-header-title">CreateMode</h1>
        <div class="app-header-actions right-action"><button id="settingsHeaderBtn" title="Settings" aria-label="Settings"><i class="fas fa-cog"></i></button></div>
    </header>

    <div class="app-container-wrapper">
        <!-- Dashboard area from GLPLv6, styled like goalio notice-area -->
        <div class="dashboard">
            <div class="dashboard-metric"><div class="metric-title">Earnings Today</div><p class="metric-value" id="valueToday">$0</p></div>
            <div class="dashboard-metric"><div class="metric-title">Earnings This Month</div><p class="metric-value" id="valueMonth">$0</p></div>
            <div class="dashboard-metric"><div class="metric-title">Upcoming Value</div><p class="metric-value" id="upcomingValue">$0</p></div>
            
            <div class="week-calendar-container" id="weekCalendarContainer"></div> {/* Calendar from GLPLv6 */}
            
            <div class="dashboard-metric"><div class="metric-title">Weeks Left (Month)</div><p class="metric-value" id="weeksLeftMonth">-</p></div>
            <div class="dashboard-metric"><div class="metric-title">Months Left (Year)</div><p class="metric-value" id="monthsLeftYear">-</p></div>
            
            <div id="clearDataNotification" style="display: none;">
                <span><i class="fas fa-info-circle"></i> Keep things lean! Old project data can be cleared in Settings.</span>
                <button id="goToSettingsFromNotification" aria-label="Go to Settings to clear data">Go to Settings</button>
            </div>
        </div>

        <div class="quest-list-section" id="activeQuestsSection">
             <h2><i class="fas fa-rocket" style="margin-right: 0.5rem;"></i> Active Quests</h2>
            <div id="activeQuestsList" class="quests-list"></div>
        </div>

        <div class="inactive-sections-toggle-container">
            <button id="toggleInactiveSectionsBtn" class="button" aria-label="Toggle visibility of completed and archived sections">
                <i class="fas fa-chevron-down" id="inactiveSectionsToggleIcon"></i>
                <span id="inactiveSectionsToggleText">Show Completed & Archived</span>
            </button>
        </div>
        
        <div class="quest-list-section" id="completedSectionContainer" style="display:none;">
            <h2 class="quest-list-section-header">
                <span><i class="fas fa-check-circle" style="margin-right: 0.5rem; color: var(--success-color);"></i>Completed (This Month)</span>
                <button id="toggleCompletedListBtn" class="btn-icon-only toggle-section-button" title="Toggle Completed Quests View"><i class="fas fa-chevron-down"></i></button>
            </h2>
            <div id="completedQuestsListWrapper" class="collapsible-list-wrapper"><div id="completedQuestsList" class="quests-list"></div></div>
        </div>
        
        <div class="quest-list-section" id="archivedSectionContainer" style="display:none;">
            <h2 class="quest-list-section-header">
                <span><i class="fas fa-archive" style="margin-right: 0.5rem; color: var(--text-light);"></i>Archived</span>
                <button id="toggleArchivedListBtn" class="btn-icon-only toggle-section-button" title="Toggle Archived Quests View"><i class="fas fa-chevron-down"></i></button>
            </h2>
            <div id="archivedQuestsListWrapper" class="collapsible-list-wrapper"><div id="archivedQuestsList" class="quests-list"></div></div>
        </div>
    </div>

    <!-- Modals (Quest, Settings, Confirm) - Structure from GLPLv6, styling from goalio -->
    <div id="questModal" class="modal" aria-modal="true" aria-labelledby="questModalTitle">
        <div class="modal-content">
            <div class="modal-header"><h2 id="questModalTitle">Start New Quest</h2><button class="close-modal-button" id="closeQuestModal" title="Close Quest Modal"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <input type="hidden" id="questId">
                <div class="form-group"><label for="questTitle">Quest Title:</label><input type="text" id="questTitle" placeholder="E.g., My Awesome Cat Video"></div>
                <div class="form-group"><label for="questDeadline">Deadline:</label><input type="date" id="questDeadline"></div>
                <div class="form-group"><label for="questValueInput">Total Value for this Quest ($):</label><input type="number" id="questValueInput" placeholder="E.g., 100" min="0"></div>
                <div class="form-group"><label for="questTemplateSelect">Use Template:</label><select id="questTemplateSelect"></select></div>
                <h3><i class="fas fa-tasks" style="margin-right: 0.5rem;"></i>Tasks for this Quest:</h3>
                <div id="modalTasksContainer"></div>
                <button id="addModalMainTaskBtn" class="button btn-icon-text" style="margin-top:10px;">
                    <i class="fas fa-plus-circle"></i> Add Main Task
                </button>
            </div>
            <div class="modal-footer">
                <button type="button" class="button" id="cancelQuestModalBtn">Cancel</button>
                <button id="saveQuestBtn" class="btn-primary">
                    <i class="fas fa-save"></i> Save Quest
                </button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal" aria-modal="true" aria-labelledby="settingsModalTitle">
        <div class="modal-content">
            <div class="modal-header"><h2 id="settingsModalTitle"><i class="fas fa-cog" style="margin-right: 0.5rem;"></i>Settings</h2><button class="close-modal-button" id="closeSettingsModal" title="Close Settings Modal"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <div class="settings-section">
                    <h3><i class="fas fa-clipboard-list" style="margin-right: 0.5rem;"></i>Quest Templates</h3>
                    <div id="templateEditor">
                        <input type="hidden" id="templateId">
                        <div class="form-group"><label for="templateName">Template Name:</label><input type="text" id="templateName" placeholder="E.g., Standard Video, Quick Vlog"></div>
                        <h4><i class="fas fa-tasks" style="margin-right: 0.5rem;"></i>Tasks for this Template:</h4>
                        <div id="templateTasksContainer"></div>
                        <button id="addTemplateMainTaskBtn" class="button btn-icon-text" style="margin-top:10px;">
                            <i class="fas fa-plus-circle"></i> Add Main Task
                        </button>
                        <div style="margin-top: 20px; display:flex; gap: 10px;">
                            <button id="saveTemplateBtn" class="btn-primary">
                                <i class="fas fa-save"></i> Save Template
                            </button>
                            <button id="newTemplateBtn" class="button btn-icon-text" style="margin-left: auto;">
                                <i class="fas fa-file-alt"></i> New Template
                            </button>
                        </div>
                    </div>
                    <h4 style="margin-top: 1.5rem;"><i class="fas fa-list-alt" style="margin-right: 0.5rem;"></i>Existing Templates:</h4>
                    <div id="templateList"></div>
                </div>
                <div class="settings-section">
                    <h3><i class="fas fa-database" style="margin-right: 0.5rem;"></i>Data Management</h3>
                    <p>Permanently delete all project data (titles, tasks, value) for quests completed <strong>before the current month</strong>. This action cannot be undone.</p>
                    <button id="clearOldDataBtn" class="btn-danger" style="margin-top:15px;">
                        <i class="fas fa-trash-alt"></i> Clear Old Project Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="customConfirmModal" class="modal" aria-modal="true" aria-labelledby="customConfirmModalTitle">
        <div class="modal-content" style="max-width: 480px;">
            <div class="modal-header"><h2 id="customConfirmModalTitle"><i class="fas fa-exclamation-triangle" style="margin-right:0.5rem; color: var(--warning-color);"></i>Confirm Action</h2></div>
            <div class="modal-body"><p id="customConfirmModalMessage" style="line-height: 1.6; font-size: 0.95rem;">Are you sure?</p></div>
            <div class="modal-footer">
                <button id="customConfirmModalCancelBtn" class="button">Cancel</button>
                <button id="customConfirmModalConfirmBtn" class="btn-danger">Confirm</button>
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script>
        // --- App State & Constants (from GLPLv6, adapted KEY name) ---
        let appData = { projects: [], templates: [] };
        const APP_DATA_KEY = 'creatorQuestLogData_vGoalioSkin'; 
        let inactiveSectionsVisible = false;
        const INACTIVE_SECTIONS_VISIBILITY_KEY = 'creatorQuestLog_inactiveSectionsVisibility_vGoalioSkin';
        let currentCalendarDate = new Date(); 

        // --- DOM Element References (Copied from GLPLv6, ensure they still exist or adapt) ---
        const weekCalendarContainer = document.getElementById('weekCalendarContainer');
        const weeksLeftMonthEl = document.getElementById('weeksLeftMonth');
        const monthsLeftYearEl = document.getElementById('monthsLeftYear');
        const valueTodayEl = document.getElementById('valueToday');
        const valueMonthEl = document.getElementById('valueMonth');
        const upcomingValueEl = document.getElementById('upcomingValue');
        const clearDataNotificationDiv = document.getElementById('clearDataNotification');
        const goToSettingsFromNotificationBtn = document.getElementById('goToSettingsFromNotification');
        const activeQuestsListEl = document.getElementById('activeQuestsList');
        const completedQuestsListEl = document.getElementById('completedQuestsList');
        const archivedQuestsListEl = document.getElementById('archivedQuestsList');
        const activeQuestsSectionEl = document.getElementById('activeQuestsSection');
        const toggleInactiveSectionsBtn = document.getElementById('toggleInactiveSectionsBtn');
        const inactiveSectionsToggleIcon = document.getElementById('inactiveSectionsToggleIcon'); // This is an <i> in GLPLv6
        const inactiveSectionsToggleText = document.getElementById('inactiveSectionsToggleText');
        const completedSectionContainer = document.getElementById('completedSectionContainer');
        const archivedSectionContainer = document.getElementById('archivedSectionContainer');
        const toggleCompletedListBtn = document.getElementById('toggleCompletedListBtn');
        const completedQuestsListWrapper = document.getElementById('completedQuestsListWrapper');
        const toggleArchivedListBtn = document.getElementById('toggleArchivedListBtn');
        const archivedQuestsListWrapper = document.getElementById('archivedQuestsListWrapper');
        const questModal = document.getElementById('questModal');
        const closeQuestModalBtn = document.getElementById('closeQuestModal');
        const cancelQuestModalBtn = document.getElementById('cancelQuestModalBtn');
        const addQuestHeaderBtn = document.getElementById('addQuestHeaderBtn');
        const saveQuestBtn = document.getElementById('saveQuestBtn');
        const questModalTitleEl = document.getElementById('questModalTitle');
        const questIdInput = document.getElementById('questId');
        const questTitleInput = document.getElementById('questTitle');
        const questDeadlineInput = document.getElementById('questDeadline');
        const questValueInput = document.getElementById('questValueInput');
        const questTemplateSelect = document.getElementById('questTemplateSelect');
        const modalTasksContainer = document.getElementById('modalTasksContainer');
        const addModalMainTaskBtn = document.getElementById('addModalMainTaskBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModalBtn = document.getElementById('closeSettingsModal');
        const settingsHeaderBtn = document.getElementById('settingsHeaderBtn');
        const templateIdInput = document.getElementById('templateId');
        const templateNameInput = document.getElementById('templateName');
        const templateTasksContainer = document.getElementById('templateTasksContainer');
        const addTemplateMainTaskBtn = document.getElementById('addTemplateMainTaskBtn');
        const saveTemplateBtn = document.getElementById('saveTemplateBtn');
        const newTemplateBtn = document.getElementById('newTemplateBtn');
        const templateListDiv = document.getElementById('templateList');
        const clearOldDataBtn = document.getElementById('clearOldDataBtn');
        const customConfirmModal = document.getElementById('customConfirmModal');
        const customConfirmModalTitleEl = document.getElementById('customConfirmModalTitle');
        const customConfirmModalMessageEl = document.getElementById('customConfirmModalMessage');
        let customConfirmModalConfirmBtn = document.getElementById('customConfirmModalConfirmBtn');
        let customConfirmModalCancelBtn = document.getElementById('customConfirmModalCancelBtn');
        let currentConfirmCallback = null;
        let currentCancelCallback = null;
        const toastContainer = document.getElementById('toastContainer');

        // --- Utility Functions (from GLPLv6) ---
        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 9); }
        function getTodayString() { 
            const today = new Date();
            const offset = today.getTimezoneOffset();
            const adjustedToday = new Date(today.getTime() - (offset*60*1000));
            return adjustedToday.toISOString().split('T')[0];
        }

        // --- Toast Notification System (from GLPLv6) ---
        function showToast(message, type = 'info', durationVisible = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast-message ${type}`; 
            let iconClass = 'fas fa-info-circle'; // Default icon
            if (type === 'success') iconClass = 'fas fa-check-circle'; 
            else if (type === 'warning') iconClass = 'fas fa-exclamation-triangle'; 
            else if (type === 'error') iconClass = 'fas fa-times-circle';
            toast.innerHTML = `<i class="${iconClass}"></i> <span class="toast-text-content">${message}</span>`; 
            toast.style.setProperty('--toast-visible-duration', `${durationVisible}ms`);
            toastContainer.appendChild(toast); 
            setTimeout(() => { if (toast.parentNode) { toast.remove(); } }, durationVisible + 700);
        }

        // --- Custom Confirm Modal Logic (from GLPLv6) ---
        function showCustomConfirm(message, title = "Confirm Action", onConfirm, onCancel = null) { 
            customConfirmModalMessageEl.innerHTML = message; 
            customConfirmModalTitleEl.innerHTML = `<i class="fas fa-exclamation-triangle" style="margin-right:0.5rem; color: var(--warning-color);"></i>${title}`;
            currentConfirmCallback = onConfirm; currentCancelCallback = onCancel;
            const newConfirmBtn = customConfirmModalConfirmBtn.cloneNode(true); 
            customConfirmModalConfirmBtn.parentNode.replaceChild(newConfirmBtn, customConfirmModalConfirmBtn);
            customConfirmModalConfirmBtn = newConfirmBtn; 
            const newCancelBtn = customConfirmModalCancelBtn.cloneNode(true);
            customConfirmModalCancelBtn.parentNode.replaceChild(newCancelBtn, customConfirmModalCancelBtn);
            customConfirmModalCancelBtn = newCancelBtn;
            customConfirmModalConfirmBtn.onclick = () => { customConfirmModal.style.display = 'none'; if (currentConfirmCallback) currentConfirmCallback(); };
            customConfirmModalCancelBtn.onclick = () => { customConfirmModal.style.display = 'none'; if (currentCancelCallback) currentCancelCallback(); };
            customConfirmModal.style.display = 'block'; 
            customConfirmModalCancelBtn.focus();
        }
        
        // --- Calendar & Notices (from GLPLv6) ---
        function calculateQuestDaysLeft(deadlineString) {
            if (!deadlineString) return { deadlineFormatted: 'No Deadline', countdownText: '', days: Infinity, isOverdue: false, isToday: false };
            const deadlineDate = new Date(deadlineString + 'T00:00:00Z');
            const deadlineFormatted = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', timeZone: 'UTC' });
            const now = new Date();
            const today = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
            const diffTime = deadlineDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            let countdownText = "", isOverdue = false, isToday = false;
            if (diffDays < 0) { countdownText = `${Math.abs(diffDays)} day${Math.abs(diffDays) !== 1 ? 's' : ''} overdue`; isOverdue = true; } 
            else if (diffDays === 0) { countdownText = "Due Today"; isToday = true; } 
            else { countdownText = `${diffDays} day${diffDays !== 1 ? 's' : ''} left`; }
            return { deadlineFormatted, countdownText, days: diffDays, isOverdue, isToday };
        }
        function renderWeekCalendar(dateToDisplay) {
             weekCalendarContainer.innerHTML = ''; 
            const year = dateToDisplay.getFullYear(), month = dateToDisplay.getMonth(), day = dateToDisplay.getDate();
            const header = document.createElement('div'); header.className = 'week-calendar-header';
            const prevButton = document.createElement('button');
            prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>'; 
            prevButton.title = "Previous Week";
            prevButton.onclick = () => { currentCalendarDate.setDate(currentCalendarDate.getDate() - 7); renderWeekCalendar(currentCalendarDate); };
            const monthYearText = document.createElement('span'); monthYearText.className = 'week-calendar-month-year';
            const firstDayOfWeek = new Date(dateToDisplay); firstDayOfWeek.setDate(day - dateToDisplay.getDay()); 
            const lastDayOfWeek = new Date(firstDayOfWeek); lastDayOfWeek.setDate(firstDayOfWeek.getDate() + 6);
            if (firstDayOfWeek.getMonth() === lastDayOfWeek.getMonth()) monthYearText.textContent = `${firstDayOfWeek.toLocaleDateString('en-US', { month: 'long' })} ${year}`;
            else monthYearText.textContent = `${firstDayOfWeek.toLocaleDateString('en-US', { month: 'short' })} - ${lastDayOfWeek.toLocaleDateString('en-US', { month: 'short' })} ${year}`;
            const nextButton = document.createElement('button');
            nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextButton.title = "Next Week";
            nextButton.onclick = () => { currentCalendarDate.setDate(currentCalendarDate.getDate() + 7); renderWeekCalendar(currentCalendarDate); };
            header.append(prevButton, monthYearText, nextButton); weekCalendarContainer.appendChild(header);
            const dayNameRow = document.createElement('div'); dayNameRow.className = 'week-calendar-day-name-row';
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(name => {
                const dayNameCell = document.createElement('div'); dayNameCell.className = 'week-calendar-day-name';
                dayNameCell.textContent = name; dayNameRow.appendChild(dayNameCell);
            });
            weekCalendarContainer.appendChild(dayNameRow);
            const grid = document.createElement('div'); grid.className = 'week-calendar-grid';
            const today = new Date();
            const currentWeekStart = new Date(dateToDisplay); currentWeekStart.setDate(dateToDisplay.getDate() - dateToDisplay.getDay());
            for (let i = 0; i < 7; i++) {
                const dayCellDate = new Date(currentWeekStart); dayCellDate.setDate(currentWeekStart.getDate() + i);
                const dayCell = document.createElement('div'); dayCell.className = 'week-calendar-day';
                dayCell.textContent = dayCellDate.getDate();
                if (dayCellDate.getFullYear() === today.getFullYear() && dayCellDate.getMonth() === today.getMonth() && dayCellDate.getDate() === today.getDate()) dayCell.classList.add('current-day');
                if (dayCellDate.getMonth() !== dateToDisplay.getMonth()) dayCell.classList.add('other-month-display');
                grid.appendChild(dayCell);
            }
            weekCalendarContainer.appendChild(grid);
        }
        function updateNotices() {
            const now = new Date(); const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            const daysLeftInMonth = lastDayOfMonth.getDate() - now.getDate(); let weeksLeftText = "";
            if (daysLeftInMonth < 0) weeksLeftText = "Month ended";
            else if (daysLeftInMonth === 0) weeksLeftText = "Today is last day!";
            else {
                const fullWeeks = Math.floor(daysLeftInMonth / 7); const remainingDays = daysLeftInMonth % 7;
                if (fullWeeks > 0) weeksLeftText += `${fullWeeks} week${fullWeeks !== 1 ? 's' : ''}`;
                if (remainingDays > 0) weeksLeftText += `${fullWeeks > 0 ? ', ' : ''}${remainingDays} day${remainingDays !== 1 ? 's' : ''}`;
                if (weeksLeftText === "") weeksLeftText = (daysLeftInMonth < 7) ? `${daysLeftInMonth} day${daysLeftInMonth !== 1 ? 's' : ''}` : "Final week";
            }
            weeksLeftMonthEl.textContent = weeksLeftText || "0 days";
            monthsLeftYearEl.textContent = `${11 - now.getMonth()} month${(11 - now.getMonth()) !== 1 ? 's' : ''}`;
        }

        // --- Data Handling (from GLPLv6, robust version) ---
        function initializeDefaultAppState() { /* ... same as GLPLv6 ... */ 
            appData = { projects: [], templates: [{
                    id: 'default-' + Date.now(), name: 'Default Video Workflow', isDefault: true,
                    tasks: [
                        { id: 'dt1-' + generateId(), description: 'Ideation & Research', subtasks: [] }, { id: 'dt2-' + generateId(), description: 'Scripting/Outlining', subtasks: [] },
                        { id: 'dt3-' + generateId(), description: 'Filming/Recording', subtasks: [] },
                        { id: 'dt4-' + generateId(), description: 'Editing', subtasks: [{id: 'dts1-' + generateId(), description: 'Rough Cut'}, {id: 'dts2-' + generateId(), description: 'Final Polish'}] },
                        { id: 'dt5-' + generateId(), description: 'Thumbnail & SEO', subtasks: [] }, { id: 'dt6-' + generateId(), description: 'Upload & Publish', subtasks: [] },
                    ].map(task => ({...task, isCompleted: false, completionTimestamp: null, taskValue: 0, subtasks: task.subtasks.map(st => ({...st, isCompleted:false, completionTimestamp: null, subtaskValue: 0}))}))
                }] 
            };
             appData.projects.forEach(p => distributeValueToTasks(p));
        }
        function loadData() { /* ... same as GLPLv6 ... */ 
            const storedData = localStorage.getItem(APP_DATA_KEY);
            if (storedData) {
                try {
                    appData = JSON.parse(storedData); 
                    appData.projects = appData.projects || []; 
                    appData.templates = appData.templates || [];
                    
                    appData.projects.forEach(p => { 
                        p.ui_isExpanded = p.ui_isExpanded ?? false; 
                        p.ui_scrollPosition = p.ui_scrollPosition ?? 0; 
                        p.totalValue = parseFloat(p.totalValue) || 0;
                        p.valueEarned = parseFloat(p.valueEarned) || 0;
                        p.isArchived = p.isArchived ?? false; 
                        p.creationTimestamp = p.creationTimestamp || Date.now();
                        p.completionTimestamp = p.completionTimestamp ? new Date(p.completionTimestamp).getTime() : null;
                        if(isNaN(p.completionTimestamp)) p.completionTimestamp = null;
                        p.tasks = p.tasks || [];
                        p.tasks.forEach(t => {
                             t.subtasks = t.subtasks || []; 
                             t.taskValue = parseFloat(t.taskValue) || 0; 
                             t.isCompleted = t.isCompleted ?? false;
                             t.completionTimestamp = t.completionTimestamp ? new Date(t.completionTimestamp).getTime() : null;
                             if(isNaN(t.completionTimestamp)) t.completionTimestamp = null;
                             t.subtasks.forEach(st => { 
                                st.subtaskValue = parseFloat(st.subtaskValue) || 0; 
                                st.isCompleted = st.isCompleted ?? false;
                                st.completionTimestamp = st.completionTimestamp ? new Date(st.completionTimestamp).getTime() : null;
                                if(isNaN(st.completionTimestamp)) st.completionTimestamp = null;
                            });
                        });
                        distributeValueToTasks(p); 
                        let currentEarned = 0;
                        p.tasks.forEach(task => {
                            if (task.subtasks.length > 0) {
                                task.subtasks.forEach(sub => { if (sub.isCompleted) currentEarned += sub.subtaskValue; });
                            } else { if (task.isCompleted) currentEarned += task.taskValue; }
                        });
                        p.valueEarned = Math.min(currentEarned, p.totalValue);
                    });
                    if (appData.templates.length === 0 || !appData.templates.some(t => t.isDefault)) {
                       const defaultTemplate = { id: 'default-fallback-' + Date.now(), name: 'Default Video Workflow', isDefault: true, tasks: [
                                { id: 'dtf1-' + generateId(), description: 'Ideation & Research', subtasks: [] }, { id: 'dtf2-' + generateId(), description: 'Scripting/Outlining', subtasks: [] },
                                { id: 'dtf3-' + generateId(), description: 'Filming/Recording', subtasks: [] },
                                { id: 'dtf4-' + generateId(), description: 'Editing', subtasks: [{id: 'dtfs1-' + generateId(), description: 'Rough Cut'}, {id: 'dtfs2-' + generateId(), description: 'Final Polish'}] },
                                { id: 'dtf5-' + generateId(), description: 'Thumbnail & SEO', subtasks: [] }, { id: 'dtf6-' + generateId(), description: 'Upload & Publish', subtasks: [] },
                            ].map(task => ({...task, subtasks: task.subtasks.map(st => ({...st}))}))
                        };
                        if (appData.templates.length === 0) appData.templates.push(defaultTemplate); 
                        else if (appData.templates.length > 0) appData.templates[0].isDefault = true;
                    }
                } catch (error) {
                    console.error("Error parsing data from localStorage:", error); showToast("Data load error. Resetting to defaults.", 'error', 6000);
                    localStorage.removeItem(APP_DATA_KEY); initializeDefaultAppState();
                }
            } else { initializeDefaultAppState(); }
        }
        function saveData() { /* ... same as GLPLv6 ... */ 
            try { localStorage.setItem(APP_DATA_KEY, JSON.stringify(appData)); } 
            catch (error) { console.error("Error saving data:", error); showToast("Save error.", 'error', 7000); } 
        }

        // --- Dashboard Update (from GLPLv6) ---
        function updateDashboard() { /* ... same as GLPLv6 ... */ 
            let valueToday = 0, valueMonth = 0, upcomingValueTotal = 0;
            const todayD = new Date(); todayD.setHours(0, 0, 0, 0); const todayTime = todayD.getTime();
            const firstDayOfMonth = new Date(todayD.getFullYear(), todayD.getMonth(), 1).getTime();
            appData.projects.forEach(project => {
                if (project.isArchived) return; 
                const totalVal = parseFloat(project.totalValue) || 0;
                let earnedValProject = 0;
                (project.tasks || []).forEach(task => {
                    const checkCompletion = (item, value) => {
                        if (item.isCompleted && item.completionTimestamp) {
                            const completionDate = new Date(item.completionTimestamp); completionDate.setHours(0,0,0,0);
                            const itemVal = parseFloat(value) || 0;
                            earnedValProject += itemVal;
                            if (completionDate.getTime() === todayTime) valueToday += itemVal;
                            if (completionDate.getTime() >= firstDayOfMonth) valueMonth += itemVal;
                        }
                    };
                    if ((task.subtasks || []).length > 0) task.subtasks.forEach(sub => checkCompletion(sub, sub.subtaskValue));
                    else checkCompletion(task, task.taskValue);
                });
                project.valueEarned = Math.min(earnedValProject, totalVal);
                if (!project.isCompleted) { upcomingValueTotal += Math.max(0, totalVal - project.valueEarned); }
            });
            valueTodayEl.textContent = `$${valueToday.toFixed(0)}`;
            valueMonthEl.textContent = `$${valueMonth.toFixed(0)}`;
            upcomingValueEl.textContent = `$${upcomingValueTotal.toFixed(0)}`;
            checkClearDataNotification();
        }

        // --- Project Rendering & Card Creation (ADAPTED for Goalio Card Style) ---
        function renderProjects() { /* ... same as GLPLv6 for list handling and FLIP ... */ 
            const lists = { active: activeQuestsListEl, completed: completedQuestsListEl, archived: archivedQuestsListEl };
            const firstPassPositions = new Map();
            Object.values(lists).forEach(listEl => {
                if (listEl) { 
                    Array.from(listEl.children).forEach(card => { if (card.dataset.id && !card.classList.contains('exiting')) firstPassPositions.set(card.dataset.id, card.getBoundingClientRect()); });
                    listEl.innerHTML = '';
                }
            });
            const firstDayOfCurrentMonth = new Date(); firstDayOfCurrentMonth.setDate(1); firstDayOfCurrentMonth.setHours(0, 0, 0, 0);
            const sorted = { active: [], completed: [], archived: [] };
            appData.projects.forEach(p => {
                if (p.isArchived) sorted.archived.push(p);
                else if (p.isCompleted) { if (!p.completionTimestamp || new Date(p.completionTimestamp) >= firstDayOfCurrentMonth) sorted.completed.push(p); }
                else sorted.active.push(p);
            });
            sorted.active.sort((a, b) => (a.priority !== b.priority) ? (a.priority ? -1 : 1) : (calculateQuestDaysLeft(a.deadline).days - calculateQuestDaysLeft(b.deadline).days) || ((b.creationTimestamp || 0) - (a.creationTimestamp || 0)));
            sorted.completed.sort((a, b) => (b.completionTimestamp || 0) - (a.completionTimestamp || 0));
            sorted.archived.sort((a,b) => ((b.completionTimestamp || b.creationTimestamp || 0)) - (a.completionTimestamp || a.creationTimestamp || 0));
            
            Object.keys(sorted).forEach(key => {
                const listEl = lists[key];
                if (listEl) {
                    if (sorted[key].length === 0 && (key === 'active' || (inactiveSectionsVisible && document.getElementById(`${key}QuestsListWrapper`)?.classList.contains('expanded')))) {
                        const messages = { active: "No active quests. Time to start a new one!", completed: "No quests completed this month yet.", archived: "No archived quests." };
                        listEl.innerHTML = `<p class="empty-list-message">${messages[key]}</p>`;
                    } else { sorted[key].forEach(project => listEl.appendChild(createProjectCard(project))); }
                }
            });
            // FLIP Animation logic (from GLPLv6)
            Object.values(lists).forEach(listEl => {
                if (listEl) {
                    Array.from(listEl.children).forEach(card => {
                        const projectId = card.dataset.id; if (!projectId) return;
                        const oldRect = firstPassPositions.get(projectId);
                        if (!oldRect) { 
                            card.classList.add('entering');
                            requestAnimationFrame(() => { card.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out'; card.classList.remove('entering'); card.addEventListener('transitionend', () => card.style.transition = '', { once: true }); });
                        } else { 
                            const newRect = card.getBoundingClientRect(); const deltaX = oldRect.left - newRect.left, deltaY = oldRect.top - newRect.top;
                            if (deltaX !== 0 || deltaY !== 0) {
                                card.style.transform = `translate(${deltaX}px, ${deltaY}px)`; card.style.transition = 'none'; 
                                requestAnimationFrame(() => { card.style.transition = 'transform 0.35s cubic-bezier(0.25, 0.8, 0.25, 1)'; card.style.transform = 'translate(0, 0)'; card.addEventListener('transitionend', () => { card.style.transform = ''; card.style.transition = ''; }, { once: true }); });
                            }
                        }
                    });
                }
            });
            updateDashboard();
            appData.projects.forEach(p => { 
                if (p.ui_isExpanded) { 
                    const cardEl = document.querySelector(`.quest-card[data-id="${p.id}"] .tasks-container.expanded`); 
                    if (cardEl) setTimeout(() => { cardEl.scrollTop = p.ui_scrollPosition || 0; }, 50);
                } 
            });
        }
        
        function createProjectCard(project) { // MODIFIED for Goalio card structure
            const card = document.createElement('div');
            card.className = 'quest-card'; card.dataset.id = project.id;
            if (project.isCompleted) card.classList.add('completed-quest');
            if (project.isArchived) card.classList.add('archived-quest');
            
            const totalVal = parseFloat(project.totalValue) || 0;
            let earnedVal = 0;
             (project.tasks || []).forEach(task => {
                if ((task.subtasks || []).length > 0) { (task.subtasks || []).forEach(sub => { if (sub.isCompleted) earnedVal += (parseFloat(sub.subtaskValue) || 0); }); }
                else { if (task.isCompleted) earnedVal += (parseFloat(task.taskValue) || 0); }
            });
            earnedVal = Math.min(earnedVal, totalVal); project.valueEarned = earnedVal;
            let progressPercent = totalVal > 0 ? (earnedVal / totalVal) * 100 : ((project.isCompleted) ? 100 : 0);
            
            const deadlineInfo = calculateQuestDaysLeft(project.deadline);
            if (deadlineInfo.isOverdue && !project.isCompleted && !project.isArchived) card.classList.add('is-overdue');
            
            const starIconClass = project.priority ? 'fas fa-star' : 'far fa-star'; // Assuming Font Awesome classes

            let deadlineHtmlPart = '';
            if (project.deadline) {
                deadlineHtmlPart = `
                    <span class="quest-deadline-details">
                        <i class="fas fa-calendar-alt"></i> <span class="quest-deadline-text">${deadlineInfo.deadlineFormatted}</span>
                    </span>`;
                if (deadlineInfo.countdownText && !project.isCompleted && !project.isArchived) {
                    deadlineHtmlPart += `
                        <span class="quest-countdown ${deadlineInfo.isOverdue ? 'overdue' : ''} ${deadlineInfo.isToday ? 'today' : ''}">
                            &bull; <i class="fas fa-hourglass-half"></i> <span class="quest-countdown-text">${deadlineInfo.countdownText}</span>
                        </span>`;
                }
            }

            // Description is optional in GLPLv6 data model, goalio.html shows it. Let's assume project.description exists or is empty.
            // For now, task toggle is in footer, actions (edit/delete) in dropdown.
            card.innerHTML = `
                <div class="priority-button-wrapper">
                    <button class="priority-button btn-icon-only ${project.priority ? 'prioritized' : ''}" title="${project.priority ? 'Remove Priority' : 'Set Priority'}" ${project.isArchived || project.isCompleted ? 'disabled' : ''}>
                        <i class="${starIconClass}"></i>
                    </button>
                </div>
                <div class="quest-card-header">
                    <input type="checkbox" class="quest-complete-checkbox" ${project.isCompleted ? 'checked' : ''} title="Mark Quest ${project.isCompleted ? 'Active' : 'Complete'}" ${project.isArchived ? 'disabled' : ''}>
                    <p class="quest-title-text" title="Edit Quest: ${project.title}">${project.title}</p>
                    {/* Actions like Edit/Delete are in dropdown, not directly in header in goalio style */}
                </div>
                ${project.description ? `<p class="quest-description">${project.description.replace(/\n/g, '<br>')}</p>` : ''}
                <div class="quest-card-meta">
                    ${deadlineHtmlPart}
                    <span class="quest-value-display" style="${!project.deadline ? 'margin-left: 0;' : 'margin-left: auto;'}"> {/* Pushes to right if deadline is present */}
                        <i class="fas fa-coins"></i> $${earnedVal.toFixed(0)} / $${totalVal.toFixed(0)}
                    </span>
                </div>
                <div class="quest-progress-wrapper">
                    <div class="quest-progress-bar-container" title="Progress: ${progressPercent.toFixed(0)}%">
                        <div class="quest-progress-fill" style="width: ${Math.min(100, progressPercent).toFixed(0)}%;"></div>
                    </div>
                    <span class="quest-progress-value-text">${progressPercent.toFixed(0)}%</span>
                </div>
                
                <div class="tasks-container ${project.ui_isExpanded ? 'expanded' : ''}">
                    ${(project.tasks || []).length > 0 ? (project.tasks || []).map(task => createTaskElement(task, project.id, project.isArchived || project.isCompleted)).join('') : '<p style="font-size:0.85em; color: var(--text-light); text-align:center; padding:0.5rem 0;">No tasks defined.</p>'}
                </div>

                <div class="quest-card-actions-footer">
                     <button class="toggle-tasks-button btn-icon-text" title="Toggle Tasks View">
                        <i class="fas fa-chevron-${project.ui_isExpanded ? 'up' : 'down'}"></i>
                        <span>${project.ui_isExpanded ? 'Hide' : 'Show'} Tasks</span>
                    </button>
                    <div class="quest-more-actions-container" style="margin-left:auto;"> {/* Dropdown pushed to right */}
                        <button class="more-actions-button btn-icon-only" title="More Actions"><i class="fas fa-ellipsis-v"></i></button>
                        <div class="actions-dropdown">
                            <button class="action-edit-quest" data-id="${project.id}"><i class="fas fa-edit"></i> Edit</button>
                            ${project.isArchived ? `<button class="action-unarchive-quest" data-id="${project.id}"><i class="fas fa-folder-open"></i> Unarchive</button>` : `<button class="action-archive-quest" data-id="${project.id}" ${project.isCompleted ? '' : ''}><i class="fas fa-archive"></i> Archive</button>`}
                            <button class="action-delete-quest danger" data-id="${project.id}"><i class="fas fa-trash-alt"></i> Delete</button>
                        </div>
                    </div>
                </div>
            `;

            // Event Listeners (from GLPLv6, adapted for new structure if needed)
            const tasksContainerEl = card.querySelector('.tasks-container');
            card.querySelector('.toggle-tasks-button').addEventListener('click', e => { 
                e.stopPropagation(); 
                const p = appData.projects.find(proj => proj.id === project.id); 
                if (p) { 
                    if (tasksContainerEl.classList.contains('expanded')) p.ui_scrollPosition = tasksContainerEl.scrollTop;
                    p.ui_isExpanded = !p.ui_isExpanded; 
                    saveData(); renderProjects();
                } 
            });
            card.querySelector('.quest-complete-checkbox').addEventListener('change', e => toggleProjectComplete(project.id, e.target.checked));
            card.querySelector('.priority-button-wrapper .priority-button').addEventListener('click', e => { e.stopPropagation(); if (!e.currentTarget.disabled) toggleProjectPriority(project.id); });
            card.querySelector('.quest-title-text').addEventListener('click', () => openQuestModal(project.id));
            card.querySelectorAll('.task-checkbox').forEach(cb => cb.addEventListener('change', e => toggleTaskComplete(project.id, e.target.dataset.taskId, e.target.checked)));
            card.querySelectorAll('.subtask-checkbox').forEach(cb => cb.addEventListener('change', e => toggleSubtaskComplete(project.id, e.target.dataset.mainTaskId, e.target.dataset.subtaskId, e.target.checked)));
            const moreActionsBtn = card.querySelector('.more-actions-button');
            const dropdown = card.querySelector('.actions-dropdown');
            moreActionsBtn.addEventListener('click', e => { 
                e.stopPropagation(); 
                document.querySelectorAll('.actions-dropdown').forEach(dd => { if (dd !== dropdown) dd.style.display = 'none'; });
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none'; 
            });
            card.querySelector('.action-edit-quest').addEventListener('click', () => { openQuestModal(project.id); dropdown.style.display = 'none'; });
            const archiveBtn = card.querySelector('.action-archive-quest');
            if(archiveBtn) archiveBtn.addEventListener('click', e => { if (!e.currentTarget.disabled) { archiveProject(project.id); dropdown.style.display = 'none'; } });
            card.querySelector('.action-unarchive-quest')?.addEventListener('click', () => { unarchiveProject(project.id); dropdown.style.display = 'none'; });
            card.querySelector('.action-delete-quest').addEventListener('click', () => { deleteProjectWithAnimation(project.id); dropdown.style.display = 'none'; });
            
            return card;
        }

        function createTaskElement(task, projectId, isProjectInactive) { /* ... same as your previous corrected version (no chip on subtask)... */ 
            let valueDisplay = ''; 
            if (task.taskValue > 0 && (task.subtasks || []).length === 0) {
                valueDisplay = `<span class="task-value-chip">$${(parseFloat(task.taskValue) || 0).toFixed(0)}</span>`;
            }
            return `<div class="task-item ${task.isCompleted ? 'completed' : ''}" data-task-id="${task.id}">
                    <input type="checkbox" class="task-checkbox" data-task-id="${task.id}" ${task.isCompleted ? 'checked' : ''} ${isProjectInactive ? 'disabled' : ''}>
                    <span class="task-description">${task.description}</span>${valueDisplay}</div>
                    ${(task.subtasks || []).map(subtask => createSubtaskElement(subtask, task.id, isProjectInactive)).join('')}`;
        }
        function createSubtaskElement(subtask, mainTaskId, isProjectInactive) { /* ... same as your previous corrected version ... */ 
            return `<div class="subtask-item ${subtask.isCompleted ? 'completed' : ''}" data-subtask-id="${subtask.id}" data-main-task-id="${mainTaskId}">
                    <input type="checkbox" class="subtask-checkbox" data-main-task-id="${mainTaskId}" data-subtask-id="${subtask.id}" ${subtask.isCompleted ? 'checked' : ''} ${isProjectInactive ? 'disabled' : ''}>
                    <span class="task-description">${subtask.description}</span></div>`;
        }
        function distributeValueToTasks(project) { /* ... same as GLPLv6 ... */ 
            const totalProjectValue = parseFloat(project.totalValue) || 0; 
            let valueUnits = 0;
            (project.tasks || []).forEach(task => { valueUnits += (task.subtasks || []).length > 0 ? (task.subtasks || []).length : 1; });
            const valuePerUnit = totalProjectValue > 0 && valueUnits > 0 ? totalProjectValue / valueUnits : 0;
            (project.tasks || []).forEach(task => {
                task.taskValue = 0;
                if ((task.subtasks || []).length > 0) { (task.subtasks || []).forEach(sub => { sub.subtaskValue = valuePerUnit; }); }
                else { task.taskValue = valuePerUnit; }
            });
        }

        // --- Project Actions (from GLPLv6) ---
        function toggleProjectComplete(projectId, isBeingMarkedCompleted) { /* ... same as GLPLv6 ... */ 
            const project = appData.projects.find(p => p.id === projectId); if (!project || project.isArchived) return;
            const oldCompletedState = project.isCompleted; 
            project.isCompleted = isBeingMarkedCompleted;
            if (isBeingMarkedCompleted) {
                project.completionTimestamp = project.completionTimestamp || Date.now();
                (project.tasks || []).forEach(t => { 
                    t.isCompleted = true; t.completionTimestamp = t.completionTimestamp || Date.now(); 
                    (t.subtasks || []).forEach(s => { s.isCompleted = true; s.completionTimestamp = s.completionTimestamp || Date.now(); }); 
                });
                if (!oldCompletedState) showToast(`Quest "<strong>${project.title}</strong>" completed!`, 'success', 4000);
            } else { 
                project.completionTimestamp = null;
                if (oldCompletedState) showToast(`Quest "<strong>${project.title}</strong>" reactivated.`, 'info');
            }
            let currentEarned = 0;
            (project.tasks || []).forEach(task => {
                if ((task.subtasks || []).length > 0) { (task.subtasks || []).forEach(sub => { if (sub.isCompleted) currentEarned += (parseFloat(sub.subtaskValue) || 0); }); }
                else { if (task.isCompleted) currentEarned += (parseFloat(task.taskValue) || 0); }
            });
            project.valueEarned = Math.min(currentEarned, (parseFloat(project.totalValue) || 0));
            saveData(); renderProjects();
        }
        function toggleTaskComplete(projectId, taskId, isCompleted) { /* ... same as GLPLv6 ... */ 
            const project = appData.projects.find(p => p.id === projectId); if (!project || project.isArchived || project.isCompleted) return;
            const task = (project.tasks || []).find(t => t.id === taskId); if (!task) return;
            const wasTaskCompleted = task.isCompleted;
            task.isCompleted = isCompleted;
            if (isCompleted) task.completionTimestamp = task.completionTimestamp || Date.now(); else task.completionTimestamp = null;
            (task.subtasks || []).forEach(sub => { 
                sub.isCompleted = isCompleted; 
                if (isCompleted) sub.completionTimestamp = sub.completionTimestamp || Date.now(); else sub.completionTimestamp = null; 
            });
            const allTasksDone = project.tasks.every(t => t.isCompleted && ((t.subtasks || []).length === 0 || (t.subtasks || []).every(st => st.isCompleted)));
            if(allTasksDone && !project.isCompleted) { project.isCompleted = true; project.completionTimestamp = project.completionTimestamp || Date.now(); showToast(`Quest "<strong>${project.title}</strong>" auto-completed!`, 'success'); }
            else if (!allTasksDone && project.isCompleted) { project.isCompleted = false; project.completionTimestamp = null; showToast(`Quest "<strong>${project.title}</strong>" reactivated.`, 'info');}
            let currentEarned = 0;
            (project.tasks || []).forEach(t_calc => {
                if ((t_calc.subtasks || []).length > 0) { (t_calc.subtasks || []).forEach(s_calc => { if (s_calc.isCompleted) currentEarned += (parseFloat(s_calc.subtaskValue) || 0); }); }
                else { if (t_calc.isCompleted) currentEarned += (parseFloat(t_calc.taskValue) || 0); }
            });
            project.valueEarned = Math.min(currentEarned, (parseFloat(project.totalValue) || 0));
            saveData(); renderProjects();
            if (isCompleted && !wasTaskCompleted) showToast(`Task "${task.description}" marked complete.`, 'info', 2000);
            else if (!isCompleted && wasTaskCompleted) showToast(`Task "${task.description}" marked incomplete.`, 'info', 2000);
        }
        function toggleSubtaskComplete(projectId, mainTaskId, subtaskId, isCompleted) { /* ... same as GLPLv6 ... */ 
            const project = appData.projects.find(p => p.id === projectId); if (!project || project.isArchived || project.isCompleted) return;
            const mainTask = (project.tasks || []).find(t => t.id === mainTaskId); if (!mainTask) return;
            const subtask = (mainTask.subtasks || []).find(s => s.id === subtaskId); if (!subtask) return;
            const wasSubtaskCompleted = subtask.isCompleted;
            subtask.isCompleted = isCompleted;
            if (isCompleted) subtask.completionTimestamp = subtask.completionTimestamp || Date.now(); else subtask.completionTimestamp = null;
            const allSubtasksOfMainTaskDone = (mainTask.subtasks || []).every(s => s.isCompleted);
            if (allSubtasksOfMainTaskDone && !mainTask.isCompleted) { mainTask.isCompleted = true; mainTask.completionTimestamp = mainTask.completionTimestamp || Date.now(); }
            else if (!allSubtasksOfMainTaskDone && mainTask.isCompleted) { mainTask.isCompleted = false; mainTask.completionTimestamp = null; }
            const allTasksDone = project.tasks.every(t => t.isCompleted && ((t.subtasks || []).length === 0 || (t.subtasks || []).every(st => st.isCompleted)));
            if(allTasksDone && !project.isCompleted) { project.isCompleted = true; project.completionTimestamp = project.completionTimestamp || Date.now(); showToast(`Quest "<strong>${project.title}</strong>" auto-completed!`, 'success'); }
            else if (!allTasksDone && project.isCompleted) { project.isCompleted = false; project.completionTimestamp = null; showToast(`Quest "<strong>${project.title}</strong>" reactivated.`, 'info'); }
            let currentEarned = 0;
            (project.tasks || []).forEach(t_calc => {
                if ((t_calc.subtasks || []).length > 0) { (t_calc.subtasks || []).forEach(s_calc => { if (s_calc.isCompleted) currentEarned += (parseFloat(s_calc.subtaskValue) || 0); }); }
                else { if (t_calc.isCompleted) currentEarned += (parseFloat(t_calc.taskValue) || 0); }
            });
            project.valueEarned = Math.min(currentEarned, (parseFloat(project.totalValue) || 0));
            saveData(); renderProjects();
            if (isCompleted && !wasSubtaskCompleted) showToast(`Subtask "${subtask.description}" marked complete.`, 'info', 2000);
            else if (!isCompleted && wasSubtaskCompleted) showToast(`Subtask "${subtask.description}" marked incomplete.`, 'info', 2000);
        }
        function toggleProjectPriority(projectId) { /* ... same as GLPLv6 ... */ 
             const p = appData.projects.find(proj => proj.id === projectId); if (!p || p.isArchived || p.isCompleted) return; 
            p.priority = !p.priority; saveData(); renderProjects(); 
            showToast(`Quest "<strong>${p.title}</strong>" ${p.priority ? 'prioritized' : 'unprioritized'}.`, 'info'); 
        }
        function animateThenRemoveQuest(projectId) { /* ... same as GLPLv6 ... */ 
            const cardElement = document.querySelector(`.quest-card[data-id="${projectId}"]`);
            if (cardElement) { cardElement.classList.add('exiting'); cardElement.addEventListener('animationend', () => { appData.projects = appData.projects.filter(p => p.id !== projectId); saveData(); renderProjects(); }, { once: true }); } 
            else { appData.projects = appData.projects.filter(p => p.id !== projectId); saveData(); renderProjects(); }
        }
        function deleteProjectWithAnimation(projectId) { /* ... same as GLPLv6 ... */ 
            const p = appData.projects.find(proj => proj.id === projectId); if (!p) return;
            showCustomConfirm(`Are you sure you want to PERMANENTLY DELETE the quest "<strong>${p.title}</strong>"?`, "Delete Quest", () => { animateThenRemoveQuest(projectId); showToast(`Quest "<strong>${p.title}</strong>" deleted.`, 'info'); });
        }
        function archiveProject(projectId) { /* ... same as GLPLv6 ... */ 
            const p = appData.projects.find(proj => proj.id === projectId); if (!p) return;
            p.isArchived = true; p.priority = false; saveData(); renderProjects(); showToast(`Quest "<strong>${p.title}</strong>" archived.`, 'info');
        }
        function unarchiveProject(projectId) { /* ... same as GLPLv6 ... */ 
             const p = appData.projects.find(proj => proj.id === projectId); if (!p) return;
            p.isArchived = false; saveData(); renderProjects(); showToast(`Quest "<strong>${p.title}</strong>" unarchived.`, 'info');
        }

        // --- Modal Logic (from GLPLv6, adapted) ---
        function openQuestModal(projectId = null) { /* ... adapted from GLPLv6 for goalio modal styles ... */ 
            populateTemplateSelect(questTemplateSelect); modalTasksContainer.innerHTML = ''; 
            if (projectId) {
                const p = appData.projects.find(proj => proj.id === projectId);
                if (!p) { console.error("Project not found for editing:", projectId); return; }
                questModalTitleEl.innerHTML = `<i class="fas fa-edit" style="margin-right:0.5rem;"></i>Edit Quest`;
                questIdInput.value = p.id; questTitleInput.value = p.title; 
                questDeadlineInput.value = p.deadline || ''; 
                questValueInput.value = p.totalValue;
                (p.tasks || []).forEach(t => addModalTaskEditor(t));
            } else {
                questModalTitleEl.innerHTML = `<i class="fas fa-plus-circle" style="margin-right:0.5rem;"></i>Start New Quest`;
                questIdInput.value = ''; questTitleInput.value = ''; questDeadlineInput.value = getTodayString(); questValueInput.value = '100'; 
                const t = appData.templates.find(temp => temp.id === questTemplateSelect.value);
                if (t) { (t.tasks || []).forEach(task => addModalTaskEditor({ ...task, id: generateId(), isCompleted: false, completionTimestamp: null, taskValue: 0, subtasks: (task.subtasks || []).map(st => ({...st, id: generateId(), isCompleted: false, completionTimestamp: null, subtaskValue: 0})) })); }
                else { addModalTaskEditor(); }
            }
            questModal.style.display = 'block'; questTitleInput.focus(); // 'block' for standard modal, 'flex' for goalio like vertical centering
        }
        questTemplateSelect.addEventListener('change', () => { /* ... same as GLPLv6 ... */ 
             if (!questIdInput.value) { 
                modalTasksContainer.innerHTML = ''; 
                const t = appData.templates.find(temp => temp.id === questTemplateSelect.value); 
                if (t) { (t.tasks || []).forEach(task => addModalTaskEditor({ ...task, id: generateId(), isCompleted: false, completionTimestamp: null, taskValue: 0, subtasks: (task.subtasks || []).map(st => ({...st, id: generateId(), isCompleted: false, completionTimestamp: null, subtaskValue: 0})) })); }
                else { addModalTaskEditor(); }
            } 
        });
        function addModalTaskEditor(taskData = null) { /* ... adapted from GLPLv6 for icon usage ... */ 
            const taskDiv = document.createElement('div'); taskDiv.className = 'task-editor-item'; 
            taskDiv.dataset.taskId = taskData?.id || generateId(); 
            taskDiv.innerHTML = `<div class="task-editor-header"><input type="text" class="modal-task-desc" value="${taskData?.description || ''}" placeholder="Main Task Description"><button type="button" class="remove-modal-task-btn btn-icon-only danger" title="Remove Task"><i class="fas fa-trash-alt"></i></button><button type="button" class="add-modal-subtask-btn btn-icon-only" title="Add Subtask"><i class="fas fa-plus-circle"></i></button></div><div class="modal-subtasks-list" style="padding-top: 5px;"></div>`;
            modalTasksContainer.appendChild(taskDiv); 
            (taskData?.subtasks || []).forEach(s => addModalSubtaskEditor(taskDiv.querySelector('.modal-subtasks-list'), s));
            taskDiv.querySelector('.remove-modal-task-btn').onclick = () => taskDiv.remove(); 
            taskDiv.querySelector('.add-modal-subtask-btn').onclick = () => addModalSubtaskEditor(taskDiv.querySelector('.modal-subtasks-list'));
        }
        function addModalSubtaskEditor(parentList, subtaskData = null) { /* ... adapted from GLPLv6 for icon usage ... */ 
            const subtaskDiv = document.createElement('div'); subtaskDiv.className = 'subtask-editor-item'; 
            subtaskDiv.dataset.subtaskId = subtaskData?.id || generateId(); 
            subtaskDiv.innerHTML = `<input type="text" class="modal-subtask-desc" value="${subtaskData?.description || ''}" placeholder="Subtask Description"><button type="button" class="remove-modal-subtask-btn btn-icon-only danger" title="Remove Subtask"><i class="fas fa-trash-alt"></i></button>`;
            parentList.appendChild(subtaskDiv); 
            subtaskDiv.querySelector('.remove-modal-subtask-btn').onclick = () => subtaskDiv.remove();
        }
        addModalMainTaskBtn.addEventListener('click', () => addModalTaskEditor());
        [closeQuestModalBtn, cancelQuestModalBtn].forEach(btn => btn.addEventListener('click', () => questModal.style.display = 'none'));
        addQuestHeaderBtn.addEventListener('click', () => openQuestModal());
        saveQuestBtn.addEventListener('click', () => { /* ... same as GLPLv6 ... */ 
            const id = questIdInput.value || generateId(); const title = questTitleInput.value.trim();
            if (!title) { showToast('Quest Title is required.', 'warning'); questTitleInput.focus(); return; }
            const deadline = questDeadlineInput.value; const totalValue = parseFloat(questValueInput.value) || 0;
            const tasksFromModal = Array.from(document.querySelectorAll('#modalTasksContainer .task-editor-item')).map(taskDiv => {
                const taskDesc = taskDiv.querySelector('.modal-task-desc').value.trim(); if (!taskDesc) return null;
                return { id: taskDiv.dataset.taskId, description: taskDesc, isCompleted: false, completionTimestamp: null, taskValue: 0, 
                    subtasks: Array.from(taskDiv.querySelectorAll('.subtask-editor-item')).map(subDiv => { 
                        const subDesc = subDiv.querySelector('.modal-subtask-desc').value.trim(); 
                        return subDesc ? { id: subDiv.dataset.subtaskId, description: subDesc, isCompleted: false, completionTimestamp: null, subtaskValue: 0 } : null; 
                    }).filter(Boolean) 
                };
            }).filter(Boolean);
            const existing = appData.projects.find(p => p.id === id);
            if (existing) { 
                existing.title = title; existing.deadline = deadline; existing.totalValue = totalValue;
                const oldTasksMap = new Map((existing.tasks || []).map(t => [t.id, t]));
                existing.tasks = tasksFromModal.map(newTask => {
                    const oldTask = oldTasksMap.get(newTask.id); let mergedTask = { ...newTask };
                    if (oldTask) {
                        mergedTask.isCompleted = oldTask.isCompleted; mergedTask.completionTimestamp = oldTask.completionTimestamp;
                        const oldSubtasksMap = new Map((oldTask.subtasks || []).map(st => [st.id, st]));
                        mergedTask.subtasks = newTask.subtasks.map(newSub => {
                            const oldSub = oldSubtasksMap.get(newSub.id);
                            return oldSub ? {...newSub, isCompleted: oldSub.isCompleted, completionTimestamp: oldSub.completionTimestamp } : newSub;
                        });
                    } return mergedTask;
                });
                distributeValueToTasks(existing); 
                let currentEarned = 0;
                (existing.tasks || []).forEach(task => {
                    if ((task.subtasks || []).length > 0) { (task.subtasks || []).forEach(sub => { if (sub.isCompleted) currentEarned += sub.subtaskValue; });}
                    else { if (task.isCompleted) currentEarned += task.taskValue; }
                });
                existing.valueEarned = Math.min(currentEarned, existing.totalValue);
                showToast(`Quest "<strong>${existing.title}</strong>" updated.`, 'info');
            } else { 
                const newProject = { id, title, deadline, totalValue, tasks: tasksFromModal, valueEarned: 0, isCompleted: false, completionTimestamp: null, priority: false, ui_isExpanded: true, ui_scrollPosition: 0, isArchived: false, creationTimestamp: Date.now() }; 
                appData.projects.push(newProject); distributeValueToTasks(newProject);
                showToast(`Quest "<strong>${newProject.title}</strong>" started.`, 'success'); 
            }
            saveData(); renderProjects(); questModal.style.display = 'none';
        });

        // Settings Modal JS (from GLPLv6, adapted for icons)
        settingsHeaderBtn.addEventListener('click', () => { loadTemplateEditor(); renderTemplateList(); settingsModal.style.display = 'block'; templateNameInput.focus(); });
        closeSettingsModalBtn.addEventListener('click', () => settingsModal.style.display = 'none');
        goToSettingsFromNotificationBtn.addEventListener('click', () => { settingsModal.style.display = 'block'; loadTemplateEditor(); renderTemplateList(); templateNameInput.focus(); });
        function loadTemplateEditor(templateId = null) { /* ... adapted from GLPLv6 ... */ 
            templateTasksContainer.innerHTML = ''; 
            const t = templateId ? appData.templates.find(temp => temp.id === templateId) : null;
            templateIdInput.value = t?.id || ''; templateNameInput.value = t?.name || ''; 
            (t?.tasks || [null]).forEach(task => addTemplateTaskEditor(task));
            templateNameInput.focus();
        }
        function addTemplateTaskEditor(taskData = null) { /* ... adapted from GLPLv6 for icon usage ... */ 
            const taskDiv = document.createElement('div'); taskDiv.className = 'task-editor-item'; 
            taskDiv.innerHTML = `<div class="task-editor-header"><input type="text" class="template-task-desc" value="${taskData?.description || ''}" placeholder="Main Task Description"><button type="button" class="remove-template-task-btn btn-icon-only danger"><i class="fas fa-trash-alt"></i></button><button type="button" class="add-template-subtask-btn btn-icon-only"><i class="fas fa-plus-circle"></i></button></div><div class="template-subtasks-list" style="padding-top: 5px;"></div>`;
            templateTasksContainer.appendChild(taskDiv); 
            (taskData?.subtasks || []).forEach(s => addTemplateSubtaskEditor(taskDiv.querySelector('.template-subtasks-list'), s));
            taskDiv.querySelector('.remove-template-task-btn').onclick = () => taskDiv.remove(); 
            taskDiv.querySelector('.add-template-subtask-btn').onclick = () => addTemplateSubtaskEditor(taskDiv.querySelector('.template-subtasks-list'));
        }
        function addTemplateSubtaskEditor(parentList, subtaskData = null) { /* ... adapted from GLPLv6 for icon usage ... */ 
            const subtaskDiv = document.createElement('div'); subtaskDiv.className = 'subtask-editor-item'; 
            subtaskDiv.innerHTML = `<input type="text" class="template-subtask-desc" value="${subtaskData?.description || ''}" placeholder="Subtask Description"><button type="button" class="remove-template-subtask-btn btn-icon-only danger"><i class="fas fa-trash-alt"></i></button>`;
            parentList.appendChild(subtaskDiv); 
            subtaskDiv.querySelector('.remove-template-subtask-btn').onclick = () => subtaskDiv.remove();
        }
        addTemplateMainTaskBtn.addEventListener('click', () => addTemplateTaskEditor()); 
        newTemplateBtn.addEventListener('click', () => loadTemplateEditor()); 
        saveTemplateBtn.addEventListener('click', () => { /* ... same as GLPLv6 ... */ 
            const id = templateIdInput.value || generateId(); const name = templateNameInput.value.trim(); 
            if (!name) { showToast('Template Name is required.', 'warning'); templateNameInput.focus(); return; }
            const tasks = Array.from(document.querySelectorAll('#templateTasksContainer .task-editor-item')).map(div => { 
                const desc = div.querySelector('.template-task-desc').value.trim(); 
                return desc ? { description: desc, subtasks: Array.from(div.querySelectorAll('.template-subtask-desc')).map(sub => sub.value.trim()).filter(Boolean).map(d => ({description: d})) } : null 
            }).filter(Boolean);
            const existingIndex = appData.templates.findIndex(t => t.id === id);
            if (existingIndex > -1) { Object.assign(appData.templates[existingIndex], {name, tasks}); showToast(`Template "<strong>${name}</strong>" updated.`, 'success'); }
            else { appData.templates.push({ id, name, tasks, isDefault: appData.templates.length === 0 }); showToast(`Template "<strong>${name}</strong>" saved.`, 'success'); }
            saveData(); renderTemplateList(); loadTemplateEditor(id); 
        });
        function renderTemplateList() { /* ... adapted from GLPLv6 for icon usage ... */ 
            templateListDiv.innerHTML = appData.templates.length === 0 ? '<p style="color: var(--text-light); font-style: italic;">No templates. Create one!</p>' : '';
            appData.templates.forEach(t => {
                const item = document.createElement('div'); item.className = `template-item ${t.isDefault ? 'default-template' : ''}`;
                item.innerHTML = `<span>${t.name} ${t.isDefault ? '<strong style="color: var(--star-important-color);">(Default)</strong>' : ''}</span>
                    <div class="template-actions">
                        <button class="edit-template-btn button btn-icon-text" data-id="${t.id}"><i class="fas fa-edit"></i> Edit</button>
                        ${!t.isDefault ? `<button class="set-default-template-btn button btn-icon-text" data-id="${t.id}" style="background-color:var(--star-important-color);color:var(--text-color);border-color:#f59e0b;"><i class="fas fa-star"></i> Default</button>` : ''}
                        <button class="delete-template-btn btn-icon-only danger" data-id="${t.id}"><i class="fas fa-trash-alt"></i></button>
                    </div>`;
                templateListDiv.appendChild(item);
            });
            templateListDiv.querySelectorAll('.edit-template-btn').forEach(btn => btn.onclick = () => loadTemplateEditor(btn.dataset.id));
            templateListDiv.querySelectorAll('.delete-template-btn').forEach(btn => btn.onclick = () => deleteTemplate(btn.dataset.id));
            templateListDiv.querySelectorAll('.set-default-template-btn').forEach(btn => btn.onclick = () => setDefaultTemplate(btn.dataset.id));
        }
        function deleteTemplate(templateId) { /* ... same as GLPLv6 ... */ 
            const t = appData.templates.find(temp => temp.id === templateId); if (!t) return;
            if (t.isDefault) { showToast("Cannot delete the active default template. Set a new default first.", 'warning', 4000); return; }
            showCustomConfirm(`Are you sure you want to delete template "<strong>${t.name}</strong>"?`, "Delete Template", () => { appData.templates = appData.templates.filter(temp => temp.id !== templateId); saveData(); renderTemplateList(); loadTemplateEditor(); showToast(`Template "<strong>${t.name}</strong>" deleted.`, 'info'); });
        }
        function setDefaultTemplate(templateId) { /* ... same as GLPLv6 ... */ 
            let name = ''; appData.templates.forEach(t => { t.isDefault = (t.id === templateId); if (t.isDefault) name = t.name; }); 
            saveData(); renderTemplateList(); if (name) showToast(`Template "<strong>${name}</strong>" set as default.`, 'info'); 
        }
        function populateTemplateSelect(selectElement) { /* ... same as GLPLv6 ... */ 
            selectElement.innerHTML = '<option value="">-- No Template --</option>'; let defaultId = null;
            appData.templates.forEach(t => { const opt = document.createElement('option'); opt.value = t.id; opt.textContent = t.name; if (t.isDefault) { opt.selected = true; defaultId = t.id; } selectElement.appendChild(opt); });
            if (defaultId) selectElement.value = defaultId; return defaultId;
        }

        // Data Management (from GLPLv6)
        function checkClearDataNotification() { /* ... same as GLPLv6 ... */ 
             const today = new Date();
            if (today.getDate() > 7) { 
                const firstDayCurrentMonth = new Date(today.getFullYear(), today.getMonth(), 1); 
                const hasOld = appData.projects.some(p => p.isCompleted && p.completionTimestamp && new Date(p.completionTimestamp) < firstDayCurrentMonth); 
                clearDataNotificationDiv.style.display = hasOld ? 'flex' : 'none'; 
            } else { clearDataNotificationDiv.style.display = 'none'; }
        }
        clearOldDataBtn.addEventListener('click', () => { /* ... same as GLPLv6 ... */ 
            showCustomConfirm('Permanently DELETE old project data (completed BEFORE current month)? This action CANNOT BE UNDONE.', "Clear Old Project Data", () => { 
                const firstDayCurrentMonth = new Date(); firstDayCurrentMonth.setDate(1); firstDayCurrentMonth.setHours(0,0,0,0);
                const initialCount = appData.projects.length;
                appData.projects = appData.projects.filter(p => !(p.isCompleted && p.completionTimestamp && new Date(p.completionTimestamp) < firstDayCurrentMonth));
                saveData(); renderProjects(); showToast(`${initialCount - appData.projects.length} old project(s) cleared.`, 'success', 4000);
                checkClearDataNotification(); settingsModal.style.display = 'none'; 
            });
        });
        
        // --- Inactive Sections Toggle Logic (from GLPLv6) ---
        function applyInactiveSectionsVisibilityState() { 
            if (!completedSectionContainer || !archivedSectionContainer || !inactiveSectionsToggleIcon || !inactiveSectionsToggleText) return;
            if (inactiveSectionsVisible) {
                completedSectionContainer.style.display = 'block'; archivedSectionContainer.style.display = 'block';
                inactiveSectionsToggleIcon.className = 'fas fa-chevron-up'; 
                inactiveSectionsToggleText.textContent = 'Hide Completed & Archived';
            } else {
                completedSectionContainer.style.display = 'none'; archivedSectionContainer.style.display = 'none';
                inactiveSectionsToggleIcon.className = 'fas fa-chevron-down';
                inactiveSectionsToggleText.textContent = 'Show Completed & Archived';
            }
            renderProjects();
        }
        function initInactiveSectionsToggle() { /* ... same as GLPLv6 ... */ 
            const storedVisibility = localStorage.getItem(INACTIVE_SECTIONS_VISIBILITY_KEY);
            if (storedVisibility !== null) inactiveSectionsVisible = JSON.parse(storedVisibility);
            applyInactiveSectionsVisibilityState(); 
            if(toggleInactiveSectionsBtn) {
                toggleInactiveSectionsBtn.addEventListener('click', () => { 
                    inactiveSectionsVisible = !inactiveSectionsVisible; 
                    localStorage.setItem(INACTIVE_SECTIONS_VISIBILITY_KEY, JSON.stringify(inactiveSectionsVisible)); 
                    applyInactiveSectionsVisibilityState(); 
                });
            }
        }
        
        // --- Event Listeners & Initialization (from GLPLv6) ---
        window.addEventListener('DOMContentLoaded', () => {
            loadData(); 
            initInactiveSectionsToggle(); 
            updateNotices(); renderWeekCalendar(currentCalendarDate); 
            checkClearDataNotification(); 
            if(activeQuestsSectionEl) activeQuestsSectionEl.scrollIntoView({ behavior: 'auto', block: 'start' });

            document.addEventListener('click', e => {
                document.querySelectorAll('.actions-dropdown').forEach(dd => { if (!dd.contains(e.target) && !(dd.previousElementSibling && dd.previousElementSibling.contains(e.target))) dd.style.display = 'none'; });
                if (e.target.classList.contains('modal')) e.target.style.display = 'none';
            });
            document.addEventListener('keydown', e => { if (e.key === "Escape") { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); document.querySelectorAll('.actions-dropdown').forEach(dd => dd.style.display = 'none'); } });

            const setupSectionToggle = (btn, wrapper, listEl, emptyMsgKey) => {
                if (btn && wrapper && listEl) {
                    let isExpanded = false; 
                    wrapper.classList.remove('expanded'); 
                    const iconEl = btn.querySelector('i'); // Assuming Font Awesome icon
                    if(iconEl) iconEl.className = 'fas fa-chevron-down';
                    
                    btn.addEventListener('click', () => {
                        isExpanded = !isExpanded; 
                        wrapper.classList.toggle('expanded', isExpanded);
                        if(iconEl) iconEl.className = isExpanded ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
                        if (isExpanded && inactiveSectionsVisible && listEl.children.length === 0 && !listEl.querySelector('.empty-list-message')) {
                            const messages = { completed: "No quests completed this month yet.", archived: "No archived quests." };
                            listEl.innerHTML = `<p class="empty-list-message">${messages[emptyMsgKey]}</p>`;
                        } else if (!isExpanded && listEl.querySelector('.empty-list-message')) {
                            listEl.querySelector('.empty-list-message').remove();
                        } else if (isExpanded && listEl.querySelector('.empty-list-message') && listEl.children.length > 1) {
                            listEl.querySelector('.empty-list-message').remove();
                        }
                    });
                }
            };
            setupSectionToggle(toggleCompletedListBtn, completedQuestsListWrapper, completedQuestsListEl, 'completed');
            setupSectionToggle(toggleArchivedListBtn, archivedQuestsListWrapper, archivedQuestsListEl, 'archived');
        });

        window.addEventListener('beforeunload', () => { /* ... same as GLPLv6 ... */ 
            appData.projects.forEach(p => { 
                if (p.ui_isExpanded) { 
                    const el = document.querySelector(`.quest-card[data-id="${p.id}"] .tasks-container`); 
                    if (el) p.ui_scrollPosition = el.scrollTop; 
                } 
            });
            saveData(); 
        });
        
        if ('serviceWorker' in navigator) { /* ... same as GLPLv6 ... */ 
            window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').then(reg => console.log('Service Worker registered.', reg.scope)).catch(err => console.log('Service Worker registration failed:', err)); });
        }
    </script>
</body>
</html>
