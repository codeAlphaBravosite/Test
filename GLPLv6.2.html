<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CreateMode (Goalio Theme)</title>
    
    <link rel="icon" href="./icon-192x192.png" type="image/png">
    <link rel="shortcut icon" href="./icon-192x192.png" type="image/png">
    <link rel="apple-touch-icon" href="./icon-192x192.png">

    <link rel="manifest" href="./manifest.webmanifest">
    
    <style>
        /* --- GLOBAL STYLES & GOALIO THEME VARIABLES --- */
        :root {
            --primary-color: #0f172a; 
            --primary-hover: #1e293b; 
            --warning-color: #ef4444; 
            --warning-hover: #dc2626;
            --info-color: #3b82f6; 
            --star-important-color: #facc15; 
            --success-color: #22c55e; 
            --success-hover: #16a34a;

            --bg-color: #f8fafc; 
            --text-color: #0f172a; 
            --text-light: #64748b; 
            --text-on-accent: #ffffff;
            
            --card-bg: #ffffff;
            --input-bg: #ffffff;
            --border-color: #e2e8f0; 
            --border-color-strong: #cbd5e1;
            
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --border-radius: 0.5rem; 
            --border-radius-sm: 0.375rem;

            --disabled-opacity: 0.65;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;

            --goal-done-bg: #eef2ff; 
            --goal-done-text: var(--primary-color);
            --goal-overdue-border: var(--warning-color); 
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 0; 
            font-size: 15px; 
        }
        
        .icon {
            display: inline-block;
            width: 1.2em; 
            height: 1.2em;
            vertical-align: -0.2em; 
            fill: currentColor;
        }

        .app-header {
            background-color: var(--card-bg); 
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 1rem; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .app-header-title {
            font-size: 1.25rem; 
            font-weight: 600;
            color: var(--text-color);
            text-align: center;
            flex-grow: 1;
        }
        .app-header-actions button {
            background: transparent;
            border: none;
            color: var(--text-light);
            padding: 0.5rem; 
            cursor: pointer;
            transition: color 0.2s, background-color 0.2s;
            border-radius: 50%; 
            width: 2.5rem; 
            height: 2.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .app-header-actions button:hover {
            color: var(--primary-color);
            background-color: #f1f5f9; 
        }
        .app-header-actions button .icon {
            width: 1.25rem; height: 1.25rem; 
        }

        .app-container-wrapper { 
            padding: 1.25rem 1rem; 
            max-width: 1000px; 
            margin: 0 auto;
        }
        
        h2, h3 {
            color: var(--text-color);
            margin-bottom: 0.75rem; 
            font-weight: 600;
        }
        h2 { 
            font-size: 1.25rem; 
            padding-bottom: 0.5rem; 
            margin-top: 1.5rem; 
        }
        .app-container-wrapper > .quest-list-section:first-of-type > h2,
        .app-container-wrapper > .top-info-container:first-of-type + .quest-list-section > h2 {
             margin-top: 0; 
        }
        h3 { font-size: 1.1rem; } 

        button, .button {
            cursor: pointer;
            padding: 0.6rem 1.2rem; 
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            font-weight: 500;
            font-size: 0.9rem; 
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem; 
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        button:hover, .button:hover {
            border-color: var(--primary-color);
            background-color: #f8fafc; 
        }
        button:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible {
            outline: 2px solid var(--info-color);
            outline-offset: 2px;
            border-color: var(--info-color); 
        }

        .btn-primary { background-color: var(--primary-color); color: var(--text-on-accent); border-color: var(--primary-color); }
        .btn-primary:hover { background-color: var(--primary-hover); border-color: var(--primary-hover); }
        
        .btn-danger { background-color: var(--warning-color); color: var(--text-on-accent); border-color: var(--warning-color); }
        .btn-danger:hover { background-color: var(--warning-hover); border-color: var(--warning-hover); }

        .btn-icon-only { 
            padding: 0.5rem; 
            border: 1px solid transparent;
            background-color: transparent;
            line-height: 1; 
            border-radius: 50%; 
            width: 2.25rem; 
            height: 2.25rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
        }
        .btn-icon-only .icon { width: 1.1em; height: 1.1em; }
        .btn-icon-only:hover { 
            background-color: #eef2ff; 
            border-color: transparent;
            color: var(--primary-color);
        }
        .btn-icon-only.danger { color: var(--warning-color); }
        .btn-icon-only.danger:hover { background-color: #fee2e2; color: var(--warning-hover); } 

        input[type="text"], input[type="date"], input[type="number"], select, textarea {
            width: 100%;
            padding: 0.75rem; 
            margin-bottom: 1rem; 
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm); 
            font-family: var(--font-family);
            font-size: 0.95rem; 
            background-color: var(--input-bg);
            color: var(--text-color);
        }
        input[type="checkbox"] {
            width: 1.1rem; 
            height: 1.1rem;
            margin-right: 0.6rem; 
            accent-color: var(--primary-color); 
            vertical-align: middle;
            transform: scale(1.1);
        }
        textarea { min-height: 80px; resize: vertical; }

        .top-info-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.25rem; 
            margin-bottom: 2rem; 
            padding: 1.25rem;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }
        @media (min-width: 768px) {
            .top-info-container {
                grid-template-columns: repeat(2, 1fr); /* Two columns for dashboard/calendar and time-left */
            }
            .dashboard-metrics-grid { grid-column: 1 / -1; } /* Dashboard spans full width if only 1 item in its row */
            .calendar-container-weekly { grid-column: 1 / 2; }
            .time-left-grid { grid-column: 2 / 3; }
        }
         @media (min-width: 1024px) {
            .top-info-container {
                grid-template-columns: repeat(3, 1fr); /* Three columns on larger screens */
            }
             .dashboard-metrics-grid { grid-column: auto; }
             .calendar-container-weekly { grid-column: auto; }
             .time-left-grid { grid-column: auto; }
        }


        .dashboard-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem; 
        }
        .dashboard-metric {
            background-color: var(--bg-color); 
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            text-align: left; 
        }
        .dashboard-metric .metric-title {
            font-size: 0.8rem; 
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.25rem; 
        }
        .dashboard-metric .metric-value {
            font-size: 1.5rem; 
            font-weight: 600;
            color: var(--text-color);
        }

        .calendar-container-weekly {
            padding: 0.75rem;
            border: 1px solid var(--border-color); /* Match card border */
            border-radius: var(--border-radius-sm);
            background-color: var(--card-bg); 
            min-height: 150px; /* Ensure it has some height */
        }
        .calendar-header-weekly {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1rem; padding: 0 0.1rem;
        }
        .calendar-header-weekly button {
            background: transparent; border: none; color: var(--primary-color);
            padding: 0.4rem; border-radius: 50%; cursor: pointer;
            font-size: 0.9rem; width: 2rem; height: 2rem;
            display: flex; align-items: center; justify-content: center;
            transition: background-color 0.2s ease-in-out;
        }
        .calendar-header-weekly button:hover { background-color: #f1f5f9; }
        .calendar-month-year-weekly { font-size: 1.1rem; font-weight: 600; color: var(--primary-color); }
        
        .calendar-grid-weekly { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day-name-row-weekly { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 0.5rem;}

        .calendar-day-weekly, .calendar-day-name-weekly {
            text-align: center; padding: 0.5rem 0.2rem; font-size: 0.85rem;
            border-radius: var(--border-radius-sm); 
        }
        .calendar-day-name-weekly { font-weight: 500; color: var(--text-light); }
        .calendar-day-weekly {
            cursor: default; border: 1px solid transparent; 
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .calendar-day-weekly:not(.current-day-weekly):hover {
            background-color: #f8fafc; border-color: var(--border-color);
        }
        .calendar-day-weekly.current-day-weekly {
            background-color: var(--primary-color); color: white; font-weight: bold;
            border-color: var(--primary-hover);
        }

        .time-left-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            align-content: start; /* Align items to the start if grid has fewer items */
        }

        #clearDataNotification {
            grid-column: 1 / -1; 
            background-color: #fffbeb; 
            color: #78350f; 
            padding: 1rem;
            border: 1px solid #fef3c7; 
            border-radius: var(--border-radius);
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        #clearDataNotification .icon { width: 1.3em; height: 1.3em; color: #b45309; }
        #clearDataNotification button {
            font-size: 0.9em;
            background-color: var(--star-important-color);
            color: var(--text-color);
            border-color: var(--star-important-color);
        }
        #clearDataNotification button:hover { background-color: #f59e0b; border-color: #f59e0b; }

        .quest-list-section h2 { 
            text-align: left; 
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.75rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .quest-list-section h2 .icon { width: 1.4rem; height: 1.4rem; }

        .quest-card {
            background-color: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: var(--border-radius); margin-bottom: 1.5rem; 
            padding: 1.25rem; box-shadow: var(--shadow); position: relative;
        }
        .quest-card.completed-quest { 
            background-color: var(--goal-done-bg); opacity: 0.8; 
        }
        .quest-card.completed-quest .quest-title-text,
        .quest-card.completed-quest .quest-deadline-display,
        .quest-card.completed-quest .quest-value .value-earned {
            text-decoration: line-through; color: var(--goal-done-text); opacity: 0.7;
        }
        .quest-card.archived-quest { 
             border-left: 4px solid var(--text-light); opacity: 0.7;
        }
        .quest-card.is-overdue:not(.completed-quest):not(.archived-quest) { 
            border-left: 4px solid var(--goal-overdue-border); 
        }
        
        .quest-card-main-info {
            display: flex; align-items: center; 
            gap: 0.75rem; margin-bottom: 0.75rem; 
        }
        .quest-title-text {
            flex-grow: 1; font-size: 1.15rem; font-weight: 600;
            color: var(--text-color); cursor: pointer; line-height: 1.4;
        }
        .quest-title-text:hover { color: var(--primary-color); }
        
        /* Star button is handled by .priority-button and absolute positioning */
        .priority-button { 
            position: absolute; top: 0.75rem; right: 0.75rem;
            color: var(--text-light);
        }
        .priority-button.prioritized { color: var(--star-important-color); }
        .priority-button:hover:not(.prioritized) { color: var(--star-important-color); }

        .quest-more-actions-container { position: relative; }
        .actions-dropdown {
            display: none; position: absolute;
            right: 0; top: calc(100% + 5px); 
            background-color: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm); box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 10; min-width: 180px; padding: 0.5rem 0; 
        }
        .actions-dropdown button {
            display: flex; align-items: center; gap: 0.6rem; 
            width: 100%; padding: 0.6rem 1rem; 
            text-align: left; background: none; border: none;
            color: var(--text-color); font-size: 0.9rem; border-radius: 0;
        }
        .actions-dropdown button:hover { background-color: #f1f5f9; color: var(--primary-color); border-color: transparent; }
        .actions-dropdown button .icon { width: 1em; height: 1em; }
        .actions-dropdown button.danger { color: var(--warning-color); }
        .actions-dropdown button.danger:hover { background-color: #fee2e2; color: var(--warning-hover); }

        .quest-card-meta { 
            font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.85rem; 
            display: flex; flex-wrap: wrap; gap: 0.5rem 1rem; 
            align-items: center; padding-bottom: 0.75rem; 
            border-bottom: 1px solid var(--border-color); 
        }
        .quest-value, .quest-deadline-display {
            display: inline-flex; align-items: center; gap: 0.3rem; 
            padding: 0.25rem 0.5rem; 
            border-radius: var(--border-radius-sm); font-weight: 500;
        }
        .quest-value { background-color: #e0f2fe; color: #075985; }
        .quest-deadline-display .icon { font-size: 0.9em; }
        .quest-deadline-display.overdue .countdown-text { color: var(--warning-color); font-weight: 600; }
        .quest-deadline-display.today .countdown-text { color: var(--info-color); font-weight: 600; }
        
        .quest-progress-wrapper { 
            display: flex; align-items: center; gap: 0.75rem; 
            margin-top: 0.75rem; 
        }
        .quest-progress-bar-container {
            flex-grow: 1; height: 0.6rem; 
            background-color: var(--border-color);
            border-radius: 0.3rem; overflow: hidden;
        }
        .quest-progress-fill {
            height: 100%; background-color: var(--info-color); 
            border-radius: 0.3rem; transition: width 0.3s ease;
        }
        .quest-progress-value-text { 
            font-size: 0.85rem; color: var(--text-light);
            font-weight: 500; white-space: nowrap; flex-shrink: 0; 
        }

        .tasks-container {
            padding-left: 0; max-height: 0; overflow-y: auto;
            transition: max-height 0.3s ease-out, padding-top 0.3s ease-out, margin-top 0.3s ease-out;
            margin-top: 0; padding-top: 0;
        }
        .tasks-container.expanded {
            max-height: 350px; margin-top: 1rem; padding-top: 1rem;
            border-top: 1px dashed var(--border-color); 
        }
        .task-item, .subtask-item {
            display: flex; align-items: center; gap: 0.5rem; 
            padding: 0.5rem 0.25rem; border-bottom: 1px solid #f1f5f9; 
        }
        .task-item:last-child, .subtask-item:last-child { border-bottom: none; }
        .subtask-item { margin-left: 1.75rem; }
        .task-description { flex-grow: 1; font-size: 0.95rem; }
        .task-item .task-description { font-size: 1em; font-weight: 500; }
        .task-value-chip {
            font-size: 0.8rem; font-weight: 600; color: #15803d; 
            background-color: #dcfce7; padding: 0.15rem 0.4rem; 
            border-radius: 1rem; white-space: nowrap;
        }
        .task-item.completed .task-description,
        .subtask-item.completed .task-description {
            text-decoration: line-through; color: var(--text-light); opacity: var(--disabled-opacity);
        }

        .inactive-sections-toggle-container { 
            text-align: center; margin: 2rem 0; opacity: 1; 
        }
        #toggleInactiveSectionsBtn {
             background-color: var(--card-bg); border: 1px solid var(--border-color);
             color: var(--text-light); padding: 0.75rem 1.5rem;
        }
        #toggleInactiveSectionsBtn:hover {
            background-color: #f1f5f9; border-color: var(--border-color-strong); color: var(--text-color);
        }
        .quest-list-section h2 .toggle-section-button {
            margin-left: auto; background: transparent; border: none; color: var(--text-light);
        }
        .quest-list-section h2 .toggle-section-button:hover { color: var(--primary-color); background-color: transparent; }

        .collapsible-list-wrapper {
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;
        }
        .collapsible-list-wrapper.expanded { max-height: 1500px; overflow-y: auto; }
        
        .empty-list-message {
           text-align: center; color: var(--text-light); font-style: italic;
           font-size: 0.95em; background-color: var(--bg-color); 
           border: 1px dashed var(--border-color); border-radius: var(--border-radius);
           margin-top: 0; margin-bottom: 1.5rem; min-height: 150px; 
           display: flex; flex-direction: column; 
           justify-content: center; align-items: center; padding: 2rem; 
        }
        
        .modal {
            display: none; position: fixed; z-index: 1001; 
            left: 0; top: 0; width: 100%; height: 100%; overflow: auto; 
            background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(4px);
            justify-content: center; align-items: center; padding: 1rem;
            animation: fadeInModalBg 0.3s ease;
        }
        @keyframes fadeInModalBg { from { opacity: 0; } to { opacity: 1; } }
        .modal-content {
            background-color: var(--card-bg); margin: 5% auto; 
            padding: 1.5rem; border: 1px solid var(--border-color); 
            border-radius: var(--border-radius); width: 90%; max-width: 600px; 
            box-shadow: var(--shadow); animation: slideInModal 0.3s ease-out;
        }
        @keyframes slideInModal { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; padding-bottom: 1rem; 
            border-bottom: 1px solid var(--border-color);
        }
        .modal-header h2 { margin-bottom: 0; font-size: 1.25rem; color:var(--text-color); }
        .close-modal-button { 
            background: none; border: none; padding: 0.25rem; color: var(--text-light);
            cursor: pointer; border-radius: 50%; width: 2rem; height: 2rem;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .close-modal-button:hover { color: var(--text-color); background-color: #f1f5f9; }
        .close-modal-button .icon { width: 1.25rem; height: 1.25rem; }

        .modal-body .form-group { margin-bottom: 1rem; }
        .modal-body label { display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.875rem; }
        .task-editor-item {
            border: 1px solid var(--border-color); padding: 0.75rem; margin-bottom: 0.75rem; 
            border-radius: var(--border-radius-sm); background-color: var(--bg-color); 
        }
        .task-editor-header { display: flex; gap: 0.5rem; align-items: center; }
        .task-editor-header input[type="text"] { flex-grow: 1; margin-bottom: 0; }
        .task-editor-header .btn-icon-only { flex-shrink: 0; width: 2rem; height: 2rem; }
        .subtask-editor-item {
            margin-left: 1.5rem; margin-top: 0.5rem; display: flex; gap: 0.5rem; align-items: center;
        }
        .subtask-editor-item input[type="text"] { flex-grow: 1; margin-bottom: 0; }
        .subtask-editor-item .btn-icon-only { width: 2rem; height: 2rem; }
        .modal-footer {
            text-align: right; margin-top: 1.5rem; 
            padding-top: 1rem; border-top: 1px solid var(--border-color);
            display: flex; justify-content: flex-end; gap: 0.75rem; 
        }

        #settingsModal .modal-content { max-width: 750px; }
        .settings-section {
            margin-bottom: 1.5rem; padding-bottom: 1.5rem;
            border-bottom: 1px dashed var(--border-color);
        }
        .settings-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        #templateList .template-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem; border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm); margin-bottom: 0.5rem;
            background-color: var(--input-bg);
        }
        #templateList .template-item.default-template { 
            border-left: 3px solid var(--star-important-color); font-weight: 500; 
        }
        #templateList .template-item span { flex-grow: 1; }
        #templateList .template-item .template-actions { display: flex; gap: 0.3rem; }
        #templateList .template-item .template-actions button { font-size: 0.85em; padding: 0.4rem 0.6rem;}

        #toastContainer {
            position: fixed; bottom: 20px; right: 20px; z-index: 2000; 
            display: flex; flex-direction: column-reverse; gap: 10px; max-width: 350px; 
        }
        .toast-message {
            padding: 0.75rem 1.1rem; border-radius: var(--border-radius-sm); 
            color: var(--text-on-accent); font-size: 0.95em; box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            opacity: 0; word-wrap: break-word;
            animation-name: toastFadeIn, toastFadeOut; animation-duration: 0.3s, 0.3s; 
            animation-fill-mode: forwards, forwards; animation-timing-function: ease-out, ease-in;
            animation-delay: 0s, var(--toast-visible-duration, 3000ms); 
            display: flex; align-items: center; gap: 0.6rem; 
        }
        .toast-icon { width: 1.25rem; height: 1.25rem; flex-shrink: 0; fill: currentColor; }
        .toast-text-content { flex-grow: 1; }
        .toast-message strong { font-weight: 600; }
        .toast-message.success { background-color: var(--success-color); }
        .toast-message.info { background-color: var(--info-color); }
        .toast-message.warning { background-color: var(--star-important-color); color: var(--text-color); }
        .toast-message.warning .toast-icon { color: var(--text-color); }
        .toast-message.error { background-color: var(--warning-color); }
        @keyframes toastFadeIn { from { opacity: 0; transform: translateY(10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes toastFadeOut { from { opacity: 1; transform: translateY(0) scale(1); }  to { opacity: 0; transform: translateY(10px) scale(0.95); }  }

        @media (max-width: 768px) {
            body { font-size: 14px; }
            .app-header-title { font-size: 1.15rem; }
            .app-container-wrapper { padding: 1rem 0.75rem; }
            .dashboard-metrics-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
            .dashboard-metric .metric-value { font-size: 1.3rem; }
            .quest-card-meta { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .quest-title-text { font-size: 1.1rem; }
            .modal-content { margin: 5% auto; width: 95%; padding: 1.25rem; }
            .modal-header h2 { font-size: 1.15rem; }
            #templateList .template-item { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            #templateList .template-item .template-actions { width: 100%; justify-content: flex-end; }
            #toastContainer { right: 10px; bottom: 10px; max-width: calc(100% - 20px); }
        }
        @media (max-width: 480px) {
            .app-header { padding: 0.5rem 0.75rem; }
            .dashboard-metrics-grid, .time-left-grid { grid-template-columns: 1fr; } 
            .top-info-container { grid-template-columns: 1fr; }
            .quest-card-main-info { flex-wrap: wrap; } 
            .priority-button { top: 0.5rem; right: 0.5rem; }
            .task-item, .subtask-item { gap: 0.4rem; }
            .subtask-item { margin-left: 1.25rem; }
        }
    </style>
</head>
<body>
    <!-- SVG Icon Definitions -->
    <svg style="display: none;">
        <symbol id="icon-settings" viewBox="0 0 20 20" fill="currentColor"><path d="M19.4 7.63l-1.23-.88a1.2 1.2 0 00-1.24 0l-.4.28a1.2 1.2 0 00-.62 1.05v.17c0 .43.25.82.62 1.05l.4.28c.34.24.79.37 1.24.37s.9-.13 1.24-.37l1.23-.88c.34-.24.59-.63.59-1.05s-.25-.81-.6-1.05zm-4.52 9.4a1.2 1.2 0 00-1.24 0l-.4.28a1.2 1.2 0 00-.62 1.05v.17c0 .43.25.82.62 1.05l.4.28c.34.24.79.37 1.24.37s.9-.13 1.24-.37l1.23-.88c.34-.24.59-.63.59-1.05s-.25-.81-.6-1.05l-1.22-.88zM6.12 7.63L4.89 6.75a1.2 1.2 0 00-1.24 0l-.4.28a1.2 1.2 0 00-.62 1.05v.17c0 .43.25.82.62 1.05l.4.28c.34.24.79.37 1.24.37s.9-.13 1.24-.37l1.23-.88c.34-.24.59-.63.59-1.05s-.25-.81-.6-1.05zm9.4 4.52a1.2 1.2 0 000-1.24l-.28-.4a1.2 1.2 0 00-1.05-.62h-.17c-.43 0-.82.25-1.05.62l-.28.4c-.24.34-.37.79-.37 1.24s.13.9.37 1.24l.28.4c.23.37.62.62 1.05.62h.17c.43 0 .82-.25 1.05-.62l.28-.4c.24-.35.37-.8.37-1.24z"/><path fill-rule="evenodd" d="M10 3a7 7 0 100 14A7 7 0 0010 3zm0 12.5a5.5 5.5 0 110-11A5.5 5.5 0 0110 15.5z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M10 6.5a3.5 3.5 0 100 7A3.5 3.5 0 0010 6.5zm0 5.5a2 2 0 110-4A2 2 0 0110 12z" clip-rule="evenodd"/></symbol>
        <symbol id="icon-plus-circle" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></symbol>
        <symbol id="icon-trash" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></symbol>
        <symbol id="icon-pencil" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></symbol>
        <symbol id="icon-star" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></symbol>
        <symbol id="icon-chevron-down" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></symbol>
        <symbol id="icon-chevron-up" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></symbol>
        <symbol id="icon-chevron-left-calendar" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></symbol>
        <symbol id="icon-chevron-right-calendar" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></symbol>
        <symbol id="icon-save" viewBox="0 0 20 20" fill="currentColor"><path d="M17 3H5a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V7.414A2 2 0 0016.414 6L14 3.586A2 2 0 0012.586 3H12V2a1 1 0 00-1-1H9a1 1 0 00-1 1v1H5zm2 12a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h3v2a1 1 0 001 1h4a1 1 0 001-1V3.414L17.586 6H17V5a2 2 0 00-2-2h-1V2a1 1 0 00-1-1H9a1 1 0 00-1 1v1H5a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V7h-2v8zM9 6a1 1 0 011-1h2a1 1 0 010 2H10a1 1 0 01-1-1z"/></symbol>
        <symbol id="icon-close" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></symbol>
        <symbol id="icon-check-circle" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></symbol>
        <symbol id="icon-info-circle" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></symbol>
        <symbol id="icon-warning-triangle" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.216 3.031-1.742 3.031H4.42c-1.526 0-2.492-1.697-1.742-3.031l5.58-9.92zM10 6a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 6zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></symbol>
        <symbol id="icon-error-circle" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 101.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></symbol>
        <symbol id="icon-new-template" viewBox="0 0 20 20" fill="currentColor"><path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2V8.5H9.5A1.5 1.5 0 018 7V4H4zm5-2h-.086a1.992 1.992 0 00-1.406.586L4.586 5.5A1.992 1.992 0 004 6.914V8h4V2zM10.5 2H14a1 1 0 011 1v2.5h2.5a1 1 0 01.707 1.707L16.914 9H14V7.5A1.5 1.5 0 0012.5 6H10V2.5A.5.5 0 0110.5 2z"/><path d="M14 11h2v2a1 1 0 01-1 1h-1v1a1 1 0 01-2 0v-1h-1a1 1 0 010-2h1v-1a1 1 0 011-1z"/></symbol>
        <symbol id="icon-ellipsis-vertical" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" /></symbol>
        <symbol id="icon-archive" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 4.75A2.75 2.75 0 014.75 2h10.5A2.75 2.75 0 0118 4.75v4.643a.75.75 0 01-1.5 0V4.75a1.25 1.25 0 00-1.25-1.25H4.75A1.25 1.25 0 003.5 4.75v10.5c0 .056.004.11.012.164L3.5 15.25V8.75a.75.75 0 011.5 0v5.69l.07-.056a1.25 1.25 0 00-.07-.02V8.75a.75.75 0 011.5 0v5.883l.087.025A1.25 1.25 0 008 14.5h4a1.25 1.25 0 001.163-.833l.087-.25V8.75a.75.75 0 011.5 0v4.667l-.087.25A1.25 1.25 0 0012 14.5H8a1.25 1.25 0 00-1.163.833L6.75 15.583V8.75a.75.75 0 011.5 0v6.01a.248.248 0 00.017.092l.075.165A2.75 2.75 0 017.58 16H4.75A2.75 2.75 0 012 13.25V4.75zm6.5 5a.75.75 0 000-1.5H6a.75.75 0 000 1.5h2.5z" clip-rule="evenodd" /></symbol>
        <symbol id="icon-folder-open" viewBox="0 0 20 20" fill="currentColor"><path d="M2 4.5A1.5 1.5 0 013.5 3h4.542a1.5 1.5 0 011.238.606l.678.904A.5.5 0 0010.252 5H16.5A1.5 1.5 0 0118 6.5v.5H2V4.5z"/><path d="M1.5 8A1.5 1.5 0 000 9.5v6A1.5 1.5 0 001.5 17h17a1.5 1.5 0 001.5-1.5v-6A1.5 1.5 0 0018.5 8H1.5zm8.25 4a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5a.75.75 0 01.75-.75z"/></symbol>
        <symbol id="icon-calendar-days" viewBox="0 0 20 20" fill="currentColor"> <path fill-rule="evenodd" d="M5.75 2a.75.75 0 01.75.75V4h7V2.75a.75.75 0 011.5 0V4h.25A2.75 2.75 0 0118 6.75v8.5A2.75 2.75 0 0115.25 18H4.75A2.75 2.75 0 012 15.25v-8.5A2.75 2.75 0 014.75 4H5V2.75A.75.75 0 015.75 2zm-1 5.5c0-.138.112-.25.25-.25h10.5a.25.25 0 01.25.25v1.25h-11V7.5zm.25 2.5a.25.25 0 00-.25.25v4.5c0 .138.112.25.25.25h10.5a.25.25 0 00.25-.25v-4.5a.25.25 0 00-.25-.25h-10.5z" clip-rule="evenodd" /></symbol>
        <symbol id="icon-hourglass" viewBox="0 0 20 20" fill="currentColor"> <path fill-rule="evenodd" d="M2 5.25A3.25 3.25 0 015.25 2h9.5A3.25 3.25 0 0118 5.25c0 1.153-.527 2.206-1.375 2.897L12 12.016v2.484c0 .828-.27 1.503-.736 1.962A3.001 3.001 0 018.75 18H7.9A3.001 3.001 0 015.5 15.5c0-.85.228-1.558.618-2.14L10 8.163l-4.125-2.9C5.027 4.506 4.5 3.453 4.5 2.3v-.05A3.238 3.238 0 012 5.25zm1.5-.05c0-.44.195-.845.508-1.129N6.46 2.75H5.25A1.75 1.75 0 003.5 4.5v.7c0 .546.223 1.045.594 1.406L8.11 9.998 4.094 12.9A1.748 1.748 0 003.5 14.5v.05c0 1.432.86 2.607 2.062 2.95A1.5 1.5 0 007.9 16.5h.85a1.5 1.5 0 001.438-1.05 1.748 1.748 0 00.412-1.503v-2.484l4.625-3.866A3.238 3.238 0 0116.5 5.25v-.7A1.75 1.75 0 0014.75 3h-9.5c-.397 0-.756.143-.996.371A1.748 1.748 0 003.5 4.5v.7z" clip-rule="evenodd" /></symbol>
        <symbol id="icon-flame" viewBox="0 0 20 20" fill="currentColor"> <path fill-rule="evenodd" d="M11.326 2.066A9.04 9.04 0 006.942 3.01C4.48 3.93 2.5 6.25 2.5 9c0 2.457 1.436 4.568 3.515 5.567L2.613 16.89A.75.75 0 003.25 18h13.5a.75.75 0 00.637-1.11l-3.402-2.325C16.064 13.568 17.5 11.457 17.5 9c0-2.75-1.98-5.07-4.442-5.99A9.006 9.006 0 0011.326 2.066zM7.25 9a.75.75 0 01.75-.75h4a.75.75 0 010 1.5h-4A.75.75 0 017.25 9z" clip-rule="evenodd" /> </symbol>
        <symbol id="icon-check-badge" viewBox="0 0 20 20" fill="currentColor"> <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" /> </symbol>
        <symbol id="icon-archive-box" viewBox="0 0 20 20" fill="currentColor"> <path d="M2 3.5A1.5 1.5 0 013.5 2h13A1.5 1.5 0 0118 3.5v2.755a.75.75 0 01-1.5 0V4.25a.25.25 0 00-.25-.25H3.75a.25.25 0 00-.25.25v11.5c0 .138.112.25.25.25h12.5a.25.25 0 00.25-.25V13.75a.75.75 0 011.5 0v2.755A1.5 1.5 0 0116.5 18h-13A1.5 1.5 0 012 16.5v-13z" /> <path d="M5.055 7.06C5.16 6.64 5.534 6.25 6 6.25h8c.466 0 .84.39.945.81l.865 3.461a.5.5 0 01-.445.63H4.635a.5.5 0 01-.445-.63l.865-3.46zM6.5 8a.5.5 0 000 1h7a.5.5 0 000-1h-7z" /> </symbol>
    </svg>

    <header class="app-header">
        <div class="app-header-actions">
            <button id="addQuestHeaderBtn" title="Start New Quest" aria-label="Start New Quest">
                <svg class="icon"><use xlink:href="#icon-plus-circle"></use></svg>
            </button>
        </div>
        <h1 class="app-header-title">CreateMode</h1>
        <div class="app-header-actions">
            <button id="settingsHeaderBtn" title="Settings" aria-label="Settings">
                <svg class="icon"><use xlink:href="#icon-settings"></use></svg>
            </button>
        </div>
    </header>

    <div class="app-container-wrapper">
        <div class="top-info-container">
            <div class="dashboard-metrics-grid">
                <div class="dashboard-metric">
                    <div class="metric-title">Earnings Today</div>
                    <p class="metric-value" id="valueToday">$0</p>
                </div>
                <div class="dashboard-metric">
                    <div class="metric-title">Earnings This Month</div>
                    <p class="metric-value" id="valueMonth">$0</p>
                </div>
                <div class="dashboard-metric">
                    <div class="metric-title">Upcoming Value</div>
                    <p class="metric-value" id="upcomingValue">$0</p>
                </div>
            </div>
            <div class="calendar-container-weekly" id="weeklyCalendarContainer"></div>
            <div class="time-left-grid">
                <div class="dashboard-metric">
                    <div class="metric-title">Weeks Left (Month)</div>
                    <p class="metric-value" id="weeksLeftMonth">-</p>
                </div>
                <div class="dashboard-metric">
                    <div class="metric-title">Months Left (Year)</div>
                    <p class="metric-value" id="monthsLeftYear">-</p>
                </div>
            </div>
        </div>

        <div id="clearDataNotification" style="display: none;">
            <span><svg class="icon"><use xlink:href="#icon-info-circle"></use></svg> Keep things lean! Old project data from previous months can be cleared in Settings.</span>
            <button id="goToSettingsFromNotification" class="button" aria-label="Go to Settings to clear data">Go to Settings</button>
        </div>

        <div class="quest-list-section">
            <h2><svg class="icon"><use xlink:href="#icon-flame"></use></svg> Active Quests</h2>
            <div id="activeQuestsList"></div>
        </div>

        <div class="inactive-sections-toggle-container">
            <button id="toggleInactiveSectionsBtn" class="button" aria-label="Toggle visibility of completed and archived sections">
                <svg class="icon" id="inactiveSectionsToggleIcon"><use xlink:href="#icon-chevron-down"></use></svg>
                <span id="inactiveSectionsToggleText">Show Completed & Archived</span>
            </button>
        </div>

        <div class="quest-list-section" id="completedSectionContainer" style="display: none;">
             <h2>
                <svg class="icon"><use xlink:href="#icon-check-badge"></use></svg>
                <span class="completed-section-title-text">Completed (This Month)</span>
                <button id="toggleCompletedListBtn" class="btn-icon-only toggle-section-button" title="Toggle Completed Quests View" aria-label="Toggle Completed Quests View">
                    <svg class="icon"><use xlink:href="#icon-chevron-down"></use></svg>
                </button>
            </h2>
            <div id="completedQuestsListWrapper" class="collapsible-list-wrapper">
                <div id="completedQuestsList"></div>
            </div>
        </div>

        <div class="quest-list-section" id="archivedSectionContainer" style="display: none;">
            <h2>
                <svg class="icon"><use xlink:href="#icon-archive-box"></use></svg>
                <span class="archived-section-title-text">Archived</span>
                <button id="toggleArchivedListBtn" class="btn-icon-only toggle-section-button" title="Toggle Archived Quests View" aria-label="Toggle Archived Quests View">
                    <svg class="icon"><use xlink:href="#icon-chevron-down"></use></svg>
                </button>
            </h2>
            <div id="archivedQuestsListWrapper" class="collapsible-list-wrapper">
                <div id="archivedQuestsList"></div>
            </div>
        </div>
    </div>

    <div id="questModal" class="modal" aria-modal="true" aria-labelledby="questModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="questModalTitle">Start New Quest</h2>
                <button class="close-modal-button" id="closeQuestModal" title="Close Quest Modal" aria-label="Close Quest Modal">
                    <svg class="icon"><use xlink:href="#icon-close"></use></svg>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="questId">
                <div class="form-group"><label for="questTitle">Quest Title (Video Title):</label><input type="text" id="questTitle" placeholder="E.g., My Awesome Cat Video"></div>
                <div class="form-group"><label for="questDeadline">Deadline:</label><input type="date" id="questDeadline"></div>
                <div class="form-group"><label for="questValueInput">Total Value for this Quest ($):</label><input type="number" id="questValueInput" placeholder="E.g., 100" min="0"></div>
                <div class="form-group"><label for="questTemplateSelect">Use Template:</label><select id="questTemplateSelect"></select></div>
                <h3>Tasks for this Quest:</h3>
                <div id="modalTasksContainer"></div>
                <button id="addModalMainTaskBtn" class="button"><svg class="icon"><use xlink:href="#icon-plus-circle"></use></svg> Add Main Task</button>
            </div>
            <div class="modal-footer">
                <button id="cancelQuestModalBtn" class="button">Cancel</button>
                <button id="saveQuestBtn" class="btn-primary"><svg class="icon"><use xlink:href="#icon-save"></use></svg> Save Quest</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal" aria-modal="true" aria-labelledby="settingsModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="settingsModalTitle">Settings</h2>
                <button class="close-modal-button" id="closeSettingsModal" title="Close Settings Modal" aria-label="Close Settings Modal">
                    <svg class="icon"><use xlink:href="#icon-close"></use></svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h3>Quest Templates</h3>
                    <div id="templateEditor">
                        <input type="hidden" id="templateId">
                        <div class="form-group"><label for="templateName">Template Name:</label><input type="text" id="templateName" placeholder="E.g., Standard Video, Quick Vlog"></div>
                        <h4>Tasks for this Template:</h4>
                        <div id="templateTasksContainer"></div>
                        <button id="addTemplateMainTaskBtn" class="button" style="margin-top:10px;"><svg class="icon"><use xlink:href="#icon-plus-circle"></use></svg> Add Main Task</button>
                        <div style="margin-top: 20px; display:flex; gap: 10px;">
                            <button id="saveTemplateBtn" class="btn-primary"><svg class="icon"><use xlink:href="#icon-save"></use></svg> Save Template</button>
                            <button id="newTemplateBtn" class="button" style="margin-left: auto;"><svg class="icon"><use xlink:href="#icon-new-template"></use></svg> New Template</button>
                        </div>
                    </div>
                    <h3 style="margin-top: 30px;">Existing Templates:</h3>
                    <div id="templateList"></div>
                </div>
                <div class="settings-section">
                    <h3>Data Management</h3>
                    <p>Permanently delete all project data (titles, tasks, value) for quests completed <strong>before the current month</strong>. This action cannot be undone.</p>
                    <button id="clearOldDataBtn" class="btn-danger" style="margin-top:15px;"><svg class="icon"><use xlink:href="#icon-trash"></use></svg> Clear Old Project Data</button>
                </div>
            </div>
             <div class="modal-footer">
                <button id="doneSettingsModalBtn" class="btn-primary">Done</button>
            </div>
        </div>
    </div>
    
    <div id="customConfirmModal" class="modal" aria-modal="true" aria-labelledby="customConfirmModalTitle">
        <div class="modal-content" style="max-width: 480px;">
            <div class="modal-header"><h2 id="customConfirmModalTitle">Confirm Action</h2></div>
            <div class="modal-body"><p id="customConfirmModalMessage" style="line-height: 1.6;">Are you sure?</p></div>
            <div class="modal-footer">
                <button id="customConfirmModalCancelBtn" class="button">Cancel</button>
                <button id="customConfirmModalConfirmBtn" class="btn-danger">Confirm</button>
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script>
        // --- APP STATE & LOCAL STORAGE ---
        let appData = { projects: [], templates: [] };
        const APP_DATA_KEY = 'creatorQuestLogData_v3_goalio'; 
        let inactiveSectionsVisible = false; 
        const INACTIVE_SECTIONS_VISIBILITY_KEY = 'creatorQuestLog_inactiveSectionsVisibility_v1_goalio';
        let currentWeeklyCalendarDate = new Date(); 

        const weeklyCalendarContainer = document.getElementById('weeklyCalendarContainer');
        const weeksLeftMonthEl = document.getElementById('weeksLeftMonth');
        const monthsLeftYearEl = document.getElementById('monthsLeftYear');

        function initializeDefaultAppState() {
            appData = {
                projects: [],
                templates: [{
                    id: 'default-' + Date.now(), name: 'Default Video Workflow', isDefault: true,
                    tasks: [
                        { id: 'dt1-' + generateId(), description: 'Ideation & Research', subtasks: [] },
                        { id: 'dt2-' + generateId(), description: 'Scripting/Outlining', subtasks: [] },
                        { id: 'dt3-' + generateId(), description: 'Filming/Recording', subtasks: [] },
                        { id: 'dt4-' + generateId(), description: 'Editing', subtasks: [{id: 'dts1-' + generateId(), description: 'Rough Cut'}, {id: 'dts2-' + generateId(), description: 'Final Polish'}] },
                        { id: 'dt5-' + generateId(), description: 'Thumbnail & SEO', subtasks: [] },
                        { id: 'dt6-' + generateId(), description: 'Upload & Publish', subtasks: [] },
                    ]
                }]
            };
        }

        function loadData() {
            const storedData = localStorage.getItem(APP_DATA_KEY);
            if (storedData) {
                try {
                    appData = JSON.parse(storedData);
                    appData.projects = appData.projects || [];
                    appData.templates = appData.templates || [];
                    appData.projects.forEach(p => { 
                        p.tasks = p.tasks || [];
                        if (p.ui_isExpanded === undefined) p.ui_isExpanded = false;
                        if (p.ui_scrollPosition === undefined) p.ui_scrollPosition = 0; 
                        if (p.totalGoldValue !== undefined) { p.totalValue = p.totalGoldValue; delete p.totalGoldValue; }
                        if (p.goldEarned !== undefined) { p.valueEarned = p.goldEarned; delete p.goldEarned; }
                        p.totalValue = parseFloat(p.totalValue) || 0;
                        p.valueEarned = parseFloat(p.valueEarned) || 0;
                        if (p.isArchived === undefined) p.isArchived = false;
                        if (p.creationTimestamp === undefined) p.creationTimestamp = Date.now();
                        p.tasks.forEach(t => {
                             t.subtasks = t.subtasks || [];
                             if (t.goldValue !== undefined) { t.taskValue = t.goldValue; delete t.goldValue; }
                             t.taskValue = parseFloat(t.taskValue) || 0;
                             t.subtasks.forEach(st => {
                                 st.subtaskValue = parseFloat(st.subtaskValue) || 0;
                                 if (st.completionTimestamp && typeof st.completionTimestamp !== 'number') st.completionTimestamp = new Date(st.completionTimestamp).getTime();
                                 if (isNaN(st.completionTimestamp)) st.completionTimestamp = null;
                             });
                             if (t.completionTimestamp && typeof t.completionTimestamp !== 'number') t.completionTimestamp = new Date(t.completionTimestamp).getTime();
                             if (isNaN(t.completionTimestamp)) t.completionTimestamp = null;
                        });
                        distributeValueToTasks(p); 
                        let initialEarnedValue = 0;
                        p.tasks.forEach(task => {
                            if (task.subtasks.length > 0) { task.subtasks.forEach(subtask => { if (subtask.isCompleted) initialEarnedValue += (parseFloat(subtask.subtaskValue) || 0); });
                            } else { if (task.isCompleted) initialEarnedValue += (parseFloat(task.taskValue) || 0); }
                        });
                        p.valueEarned = Math.max(0, Math.min(initialEarnedValue, p.totalValue));
                         if (p.completionTimestamp && typeof p.completionTimestamp !== 'number') p.completionTimestamp = new Date(p.completionTimestamp).getTime();
                         if (isNaN(p.completionTimestamp)) p.completionTimestamp = null;
                    });
                    if (appData.templates.length === 0 || !appData.templates.some(t => t.name === 'Default Video Workflow')) {
                        const defaultTemplateExists = appData.templates.find(t => t.name === 'Default Video Workflow');
                        if (!defaultTemplateExists) {
                            appData.templates.push({ id: 'default-fallback-' + Date.now(), name: 'Default Video Workflow', isDefault: appData.templates.length === 0, tasks: [ { id: 'dtf1-' + generateId(), description: 'Ideation & Research', subtasks: [] }, { id: 'dtf2-' + generateId(), description: 'Scripting/Outlining', subtasks: [] }, { id: 'dtf3-' + generateId(), description: 'Filming/Recording', subtasks: [] }, { id: 'dtf4-' + generateId(), description: 'Editing', subtasks: [{id: 'dtfs1-' + generateId(), description: 'Rough Cut'}, {id: 'dtfs2-' + generateId(), description: 'Final Polish'}] }, { id: 'dtf5-' + generateId(), description: 'Thumbnail & SEO', subtasks: [] }, { id: 'dtf6-' + generateId(), description: 'Upload & Publish', subtasks: [] }] });
                        }
                    }
                    if (!appData.templates.some(t => t.isDefault)) {
                        const defaultTemplate = appData.templates.find(t => t.name === 'Default Video Workflow') || appData.templates[0];
                        if (defaultTemplate) defaultTemplate.isDefault = true;
                    }
                } catch (error) {
                    console.error("Error parsing data from localStorage:", error);
                    showToast("Data load error. Resetting to defaults.", 'error', 6000);
                    localStorage.removeItem(APP_DATA_KEY); 
                    initializeDefaultAppState(); 
                    appData.projects.forEach(p => distributeValueToTasks(p));
                }
            } else { 
                initializeDefaultAppState(); 
                appData.projects.forEach(p => distributeValueToTasks(p));
            }
        }

        function saveData() {
            try { localStorage.setItem(APP_DATA_KEY, JSON.stringify(appData)); } catch (error) {
                if (error.name === 'QuotaExceededError' || (error.code && (error.code === 22 || error.code === 1014))) { showToast("Storage full. Cannot save.", 'error', 7000);
                } else { showToast("Save error. Data not saved.", 'error', 5000); }
            }
        }

        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 9); }
        function getTodayString() { const today = new Date(); return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`; }

        function calculateDaysLeft(deadlineString) {
            if (!deadlineString) return { deadlineFormatted: 'No Deadline', countdownText: '', days: Infinity, weeks: 0, isOverdue: false, isToday: false };
            const [year, month, day] = deadlineString.split('-').map(Number);
            const deadlineDate = new Date(Date.UTC(year, month - 1, day));
            const deadlineFormatted = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', timeZone: 'UTC' });
            const now = new Date();
            const today = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
            const diffTime = deadlineDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            let countdownText = "", weeks = 0, isOverdue = false, isToday = false;
            if (diffDays < 0) { countdownText = `${Math.abs(diffDays)} day${Math.abs(diffDays) !== 1 ? 's' : ''} overdue`; isOverdue = true; }
            else if (diffDays === 0) { countdownText = "Due Today"; isToday = true; }
            else { countdownText = `${diffDays} day${diffDays !== 1 ? 's' : ''} left`; if (diffDays >= 7) { weeks = Math.floor(diffDays / 7); countdownText += ` (${weeks} wk${weeks !== 1 ? 's' : ''})`; } }
            return { deadlineFormatted, countdownText, days: diffDays, weeks, isOverdue, isToday };
        }

        function renderWeeklyCalendar(targetElement, dateToDisplay) {
            if (!targetElement) return;
            targetElement.innerHTML = ''; 
            const year = dateToDisplay.getFullYear(); const month = dateToDisplay.getMonth(); 
            const header = document.createElement('div'); header.className = 'calendar-header-weekly';
            const prevButton = document.createElement('button'); prevButton.innerHTML = '<svg class="icon"><use xlink:href="#icon-chevron-left-calendar"></use></svg>';
            prevButton.onclick = () => { currentWeeklyCalendarDate.setDate(currentWeeklyCalendarDate.getDate() - 7); renderWeeklyCalendar(targetElement, currentWeeklyCalendarDate); };
            const monthYearText = document.createElement('span'); monthYearText.className = 'calendar-month-year-weekly';
            const tempDate = new Date(dateToDisplay); tempDate.setDate(tempDate.getDate() - tempDate.getDay());
            monthYearText.textContent = `${tempDate.toLocaleDateString('en-US', { month: 'long' })} ${tempDate.getFullYear()}`;
            const nextButton = document.createElement('button'); nextButton.innerHTML = '<svg class="icon"><use xlink:href="#icon-chevron-right-calendar"></use></svg>';
            nextButton.onclick = () => { currentWeeklyCalendarDate.setDate(currentWeeklyCalendarDate.getDate() + 7); renderWeeklyCalendar(targetElement, currentWeeklyCalendarDate); };
            header.appendChild(prevButton); header.appendChild(monthYearText); header.appendChild(nextButton); targetElement.appendChild(header);
            const dayNameRow = document.createElement('div'); dayNameRow.className = 'calendar-day-name-row-weekly';
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(name => { const dayNameCell = document.createElement('div'); dayNameCell.className = 'calendar-day-name-weekly'; dayNameCell.textContent = name; dayNameRow.appendChild(dayNameCell); });
            targetElement.appendChild(dayNameRow);
            const grid = document.createElement('div'); grid.className = 'calendar-grid-weekly';
            const today = new Date(); today.setHours(0,0,0,0);
            let currentDayIterator = new Date(dateToDisplay); currentDayIterator.setDate(currentDayIterator.getDate() - currentDayIterator.getDay());
            for (let i = 0; i < 7; i++) {
                const dayCell = document.createElement('div'); dayCell.className = 'calendar-day-weekly'; dayCell.textContent = currentDayIterator.getDate();
                if (currentDayIterator.getTime() === today.getTime()) dayCell.classList.add('current-day-weekly');
                grid.appendChild(dayCell); currentDayIterator.setDate(currentDayIterator.getDate() + 1);
            }
            targetElement.appendChild(grid);
        }

        function updateTimeLeftNotices() {
            if (!weeksLeftMonthEl || !monthsLeftYearEl) return;
            const now = new Date(); const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            const daysLeftInMonth = lastDayOfMonth.getDate() - now.getDate(); let weeksLeftText = "";
            if (daysLeftInMonth < 0) { weeksLeftText = "Month ended"; } else if (daysLeftInMonth === 0) { weeksLeftText = "Last day!"; }
             else { const fullWeeks = Math.floor(daysLeftInMonth / 7); const remainingDays = daysLeftInMonth % 7;
                if (fullWeeks > 0) weeksLeftText += `${fullWeeks} week${fullWeeks !== 1 ? 's' : ''}`;
                if (remainingDays > 0) weeksLeftText += `${fullWeeks > 0 ? ', ' : ''}${remainingDays} day${remainingDays !== 1 ? 's' : ''}`;
                if (weeksLeftText === "") weeksLeftText = daysLeftInMonth === 1 ? "1 day" : `${daysLeftInMonth} days`;
            }
            weeksLeftMonthEl.textContent = weeksLeftText;
            monthsLeftYearEl.textContent = `${11 - now.getMonth()} month${(11 - now.getMonth()) !== 1 ? 's' : ''}`;
        }

        function showToast(message, type = 'info', durationVisible = 3000) {
            let toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div'); toast.className = `toast-message ${type}`;
            let iconType = 'info-circle';
            if (type === 'success') iconType = 'check-circle'; else if (type === 'warning') iconType = 'warning-triangle'; else if (type === 'error') iconType = 'error-circle';
            toast.innerHTML = `<svg class="icon toast-icon"><use xlink:href="#icon-${iconType}"></use></svg><span class="toast-text-content">${message}</span>`;
            toast.style.setProperty('--toast-visible-duration', `${durationVisible}ms`);
            toastContainer.appendChild(toast); 
            const totalAnimationTime = 300 + durationVisible + 300 + 100; 
            setTimeout(() => { if (toast.parentNode) { toast.remove(); } }, totalAnimationTime);
        }

        let customConfirmModal, customConfirmModalTitleEl, customConfirmModalMessageEl, customConfirmModalConfirmBtn, customConfirmModalCancelBtn, currentConfirmCallback, currentCancelCallback;
        function initCustomConfirmModal() {
            customConfirmModal = document.getElementById('customConfirmModal'); customConfirmModalTitleEl = document.getElementById('customConfirmModalTitle');
            customConfirmModalMessageEl = document.getElementById('customConfirmModalMessage'); customConfirmModalConfirmBtn = document.getElementById('customConfirmModalConfirmBtn');
            customConfirmModalCancelBtn = document.getElementById('customConfirmModalCancelBtn');
        }
        function showCustomConfirm(message, title = "Confirm Action", onConfirm, onCancel = null) {
            customConfirmModalMessageEl.innerHTML = message; customConfirmModalTitleEl.textContent = title;
            currentConfirmCallback = onConfirm; currentCancelCallback = onCancel;
            const newConfirmBtn = customConfirmModalConfirmBtn.cloneNode(true); customConfirmModalConfirmBtn.parentNode.replaceChild(newConfirmBtn, customConfirmModalConfirmBtn); customConfirmModalConfirmBtn = newConfirmBtn;
            const newCancelBtn = customConfirmModalCancelBtn.cloneNode(true); customConfirmModalCancelBtn.parentNode.replaceChild(newCancelBtn, customConfirmModalCancelBtn); customConfirmModalCancelBtn = newCancelBtn;
            customConfirmModalConfirmBtn.onclick = () => { customConfirmModal.style.display = 'none'; if (currentConfirmCallback) currentConfirmCallback(); };
            customConfirmModalCancelBtn.onclick = () => { customConfirmModal.style.display = 'none'; if (currentCancelCallback) currentCancelCallback(); };
            customConfirmModal.style.display = 'block'; customConfirmModalCancelBtn.focus();
        }
        
        let toggleInactiveSectionsBtn, inactiveSectionsToggleIcon, inactiveSectionsToggleText, completedSectionContainer, archivedSectionContainer;
        function applyInactiveSectionsVisibilityState() {
            if (!completedSectionContainer || !archivedSectionContainer || !inactiveSectionsToggleIcon || !inactiveSectionsToggleText) return;
            if (inactiveSectionsVisible) {
                completedSectionContainer.style.display = 'block'; archivedSectionContainer.style.display = 'block';
                inactiveSectionsToggleIcon.setAttribute('xlink:href', '#icon-chevron-up'); inactiveSectionsToggleText.textContent = 'Hide Completed & Archived';
            } else {
                completedSectionContainer.style.display = 'none'; archivedSectionContainer.style.display = 'none';
                inactiveSectionsToggleIcon.setAttribute('xlink:href', '#icon-chevron-down'); inactiveSectionsToggleText.textContent = 'Show Completed & Archived';
            }
            renderProjects(); 
        }
        function initInactiveSectionsToggle() {
            if (!toggleInactiveSectionsBtn || !inactiveSectionsToggleIcon || !inactiveSectionsToggleText || !completedSectionContainer || !archivedSectionContainer) return;
            const storedVisibility = localStorage.getItem(INACTIVE_SECTIONS_VISIBILITY_KEY);
            if (storedVisibility !== null) inactiveSectionsVisible = JSON.parse(storedVisibility);
            applyInactiveSectionsVisibilityState(); 
            toggleInactiveSectionsBtn.addEventListener('click', () => {
                inactiveSectionsVisible = !inactiveSectionsVisible;
                localStorage.setItem(INACTIVE_SECTIONS_VISIBILITY_KEY, JSON.stringify(inactiveSectionsVisible));
                applyInactiveSectionsVisibilityState(); 
            });
        }

        function updateDashboard() {
            let valueToday = 0, valueMonth = 0, upcomingValueTotal = 0;
            const todayDate = new Date(); todayDate.setHours(0, 0, 0, 0); 
            const firstDayOfMonth = new Date(todayDate.getFullYear(), todayDate.getMonth(), 1);
            appData.projects.forEach(project => {
                project.tasks = project.tasks || []; if (project.isArchived) return; 
                const totalVal = parseFloat(project.totalValue) || 0; const earnedVal = parseFloat(project.valueEarned) || 0;
                if (!project.isCompleted) upcomingValueTotal += (totalVal - earnedVal); 
                project.tasks.forEach(task => {
                    task.subtasks = task.subtasks || [];
                    if (task.subtasks.length > 0) {
                        task.subtasks.forEach(subtask => {
                            if (subtask.isCompleted && subtask.completionTimestamp) {
                                const subtaskCompletionDate = new Date(subtask.completionTimestamp); subtaskCompletionDate.setHours(0,0,0,0);
                                const subtaskVal = parseFloat(subtask.subtaskValue) || 0;
                                if (subtaskCompletionDate.getTime() === todayDate.getTime()) { valueToday += subtaskVal; }
                                if (subtaskCompletionDate >= firstDayOfMonth) { valueMonth += subtaskVal; }
                            }
                        });
                    } else { 
                        if (task.isCompleted && task.completionTimestamp) {
                            const taskCompletionDate = new Date(task.completionTimestamp); taskCompletionDate.setHours(0,0,0,0);
                            const taskVal = parseFloat(task.taskValue) || 0;
                            if (taskCompletionDate.getTime() === todayDate.getTime()) { valueToday += taskVal; }
                            if (taskCompletionDate >= firstDayOfMonth) { valueMonth += taskVal; }
                        }
                    }
                });
            });
            document.getElementById('valueToday').textContent = `$${valueToday.toFixed(0)}`;
            document.getElementById('valueMonth').textContent = `$${valueMonth.toFixed(0)}`;
            document.getElementById('upcomingValue').textContent = `$${upcomingValueTotal.toFixed(0)}`;
            updateTimeLeftNotices();
            checkClearDataNotification();
        }

        function renderProjects() {
            const activeQuestsList = document.getElementById('activeQuestsList');
            const completedQuestsList = document.getElementById('completedQuestsList');
            const archivedQuestsList = document.getElementById('archivedQuestsList');
            activeQuestsList.innerHTML = ''; completedQuestsList.innerHTML = ''; archivedQuestsList.innerHTML = '';
            const active = []; const completedThisMonth = []; const archived = [];
            const firstDayOfCurrentMonth = new Date(); firstDayOfCurrentMonth.setDate(1); firstDayOfCurrentMonth.setHours(0,0,0,0);
            appData.projects.forEach(project => {
                project.tasks = project.tasks || []; project.tasks.forEach(t => t.subtasks = t.subtasks || []); 
                if (project.isArchived === undefined) project.isArchived = false; if (project.creationTimestamp === undefined) project.creationTimestamp = Date.now();
                if (project.isArchived) { archived.push(project); } 
                else if (project.isCompleted) { if (!project.completionTimestamp || new Date(project.completionTimestamp) >= firstDayOfCurrentMonth) { completedThisMonth.push(project); } } 
                else { active.push(project); }
            });
            active.sort((a, b) => { if (a.priority !== b.priority) return a.priority ? -1 : 1; const aDeadline = a.deadline ? new Date(a.deadline) : null; const bDeadline = b.deadline ? new Date(b.deadline) : null; if (!aDeadline && bDeadline) return 1; if (aDeadline && !bDeadline) return -1; if (aDeadline && bDeadline) return aDeadline - bDeadline; return (b.creationTimestamp || 0) - (a.creationTimestamp || 0); });
            completedThisMonth.sort((a, b) => (b.completionTimestamp || 0) - (a.completionTimestamp || 0));
            archived.sort((a,b) => (b.completionTimestamp || b.creationTimestamp || 0) - (a.completionTimestamp || a.creationTimestamp || 0) );
            active.forEach(project => activeQuestsList.appendChild(createProjectCard(project)));
            completedThisMonth.forEach(project => completedQuestsList.appendChild(createProjectCard(project)));
            archived.forEach(project => archivedQuestsList.appendChild(createProjectCard(project)));
            updateDashboard();
            appData.projects.forEach(project => { if (project.ui_isExpanded) { const projectCard = document.querySelector(`.quest-card[data-id="${project.id}"]`); if (projectCard) { const tasksContainerEl = projectCard.querySelector('.tasks-container'); if (tasksContainerEl) { setTimeout(() => { tasksContainerEl.scrollTop = project.ui_scrollPosition || 0; }, 350); }}}});
            const completedWrapper = document.getElementById('completedQuestsListWrapper');
            const archivedWrapper = document.getElementById('archivedQuestsListWrapper');
            if (activeQuestsList.children.length === 0) activeQuestsList.innerHTML = '<p class="empty-list-message">No active quests. Time to start a new one!</p>';
            if (inactiveSectionsVisible) {
                if (completedQuestsList.children.length === 0 && completedWrapper.classList.contains('expanded')) completedQuestsList.innerHTML = '<p class="empty-list-message">No quests completed this month yet.</p>';
                else if (completedQuestsList.children.length > 0 && completedQuestsList.querySelector('.empty-list-message')) completedQuestsList.querySelector('.empty-list-message').remove();
                if (archivedQuestsList.children.length === 0 && archivedWrapper.classList.contains('expanded')) archivedQuestsList.innerHTML = '<p class="empty-list-message">No archived quests.</p>';
                else if (archivedQuestsList.children.length > 0 && archivedQuestsList.querySelector('.empty-list-message')) archivedQuestsList.querySelector('.empty-list-message').remove();
            } else { if (completedQuestsList.querySelector('.empty-list-message')) completedQuestsList.querySelector('.empty-list-message').remove(); if (archivedQuestsList.querySelector('.empty-list-message')) archivedQuestsList.querySelector('.empty-list-message').remove(); }
        }

        // createProjectCard is the one provided in the thought block, slightly adapted here
        function createProjectCard(project) {
            const card = document.createElement('div');
            card.className = 'quest-card';
            card.dataset.id = project.id;
            const deadlineInfo = calculateDaysLeft(project.deadline);
            if (!project.isCompleted && !project.isArchived && deadlineInfo.isOverdue) card.classList.add('is-overdue');
            if (project.isCompleted) card.classList.add('completed-quest');
            if (project.isArchived) card.classList.add('archived-quest');

            project.tasks = project.tasks || [];
            project.tasks.forEach(t => t.subtasks = t.subtasks || []);

            const totalVal = parseFloat(project.totalValue) || 0;
            const earnedVal = parseFloat(project.valueEarned) || 0;
            const progressPercent = totalVal > 0 ? (earnedVal / totalVal) * 100 : (project.isCompleted ? 100 : 0);

            let deadlineDisplayHtml = '';
            if (project.deadline) {
                deadlineDisplayHtml = `<span class="quest-deadline-display ${deadlineInfo.isOverdue ? 'overdue' : ''} ${deadlineInfo.isToday ? 'today' : ''}"><svg class="icon"><use xlink:href="#icon-calendar-days"></use></svg> <span>${deadlineInfo.deadlineFormatted}</span>${deadlineInfo.countdownText ? `<span>&bull; <svg class="icon"><use xlink:href="#icon-hourglass"></use></svg> <span class="countdown-text">${deadlineInfo.countdownText}</span></span>` : ''}</span>`;
            } else { deadlineDisplayHtml = `<span class="quest-deadline-display"><svg class="icon"><use xlink:href="#icon-calendar-days"></use></svg> No Deadline</span>`; }

            card.innerHTML = `
                <div class="quest-card-main-info">
                    <input type="checkbox" class="quest-complete-checkbox" ${project.isCompleted ? 'checked' : ''} title="Mark Quest Complete/Active" aria-label="Mark quest '${project.title}' as ${project.isCompleted ? 'active' : 'complete'}" ${project.isArchived ? 'disabled' : ''}>
                    <p class="quest-title-text" title="Edit Quest: ${project.title}">${project.title}</p>
                    <!-- Star/Priority button is absolutely positioned via CSS -->
                </div>
                <button class="priority-button btn-icon-only ${project.priority ? 'prioritized' : ''}" title="${project.priority ? 'Remove Priority' : 'Set Priority'}" aria-label="${project.priority ? 'Remove priority from' : 'Set priority for'} quest '${project.title}'" ${project.isArchived ? 'disabled' : ''}> <svg class="icon"><use xlink:href="#icon-star"></use></svg> </button>
                <div class="quest-card-meta"> <span class="quest-value"> <svg class="icon" style="width:1em; height:1em; vertical-align:-0.1em; color: var(--success-color);"><use xlink:href="#icon-check-circle"></use></svg> Value: <span class="value-earned">$${earnedVal.toFixed(0)}</span> / $${totalVal.toFixed(0)} </span> ${deadlineDisplayHtml} </div>
                <div class="quest-progress-wrapper"> <div class="quest-progress-bar-container" title="Progress: ${progressPercent.toFixed(0)}%"><div class="quest-progress-fill" style="width: ${Math.min(100, progressPercent).toFixed(0)}%;"></div></div> <span class="quest-progress-value-text">${progressPercent.toFixed(0)}%</span> </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color);">
                    <button class="toggle-tasks-button button btn-icon-only" style="gap: 0.3rem; width: auto; padding: 0.4rem 0.8rem; border-radius: var(--border-radius-sm);" title="Toggle Tasks View" aria-label="Toggle tasks for quest '${project.title}'"> <svg class="icon"><use xlink:href="#icon-chevron-${project.ui_isExpanded ? 'up' : 'down'}"></use></svg> Tasks </button>
                    <div class="quest-more-actions-container"> <button class="more-actions-button btn-icon-only" title="More Actions" aria-label="More actions for quest '${project.title}'"> <svg class="icon"><use xlink:href="#icon-ellipsis-vertical"></use></svg> </button>
                        <div class="actions-dropdown"> <button class="action-edit-quest" data-id="${project.id}"><svg class="icon"><use xlink:href="#icon-pencil"></use></svg> Edit</button> ${project.isArchived ? `<button class="action-unarchive-quest" data-id="${project.id}"><svg class="icon"><use xlink:href="#icon-folder-open"></use></svg> Unarchive</button>` : `<button class="action-archive-quest" data-id="${project.id}"><svg class="icon"><use xlink:href="#icon-archive"></use></svg> Archive</button>`} <button class="action-delete-quest danger" data-id="${project.id}"><svg class="icon"><use xlink:href="#icon-trash"></use></svg> Delete</button> </div>
                    </div>
                </div>
                <div class="tasks-container ${project.ui_isExpanded ? 'expanded' : ''}"> ${(project.tasks || []).map(task => createTaskElement(task, project.id, project.title, project.isArchived)).join('')} </div>`;
            
            card.querySelector('.toggle-tasks-button').addEventListener('click', (e) => { e.stopPropagation(); const projectToToggle = appData.projects.find(p => p.id === project.id); if (projectToToggle) { const tasksContainerEl = card.querySelector('.tasks-container'); const isCurrentlyExpanded = tasksContainerEl.classList.contains('expanded'); if (isCurrentlyExpanded) projectToToggle.ui_scrollPosition = tasksContainerEl.scrollTop; projectToToggle.ui_isExpanded = !projectToToggle.ui_isExpanded; tasksContainerEl.classList.toggle('expanded', projectToToggle.ui_isExpanded); e.currentTarget.querySelector('use').setAttribute('xlink:href', `#icon-chevron-${projectToToggle.ui_isExpanded ? 'up' : 'down'}`); if (projectToToggle.ui_isExpanded) { requestAnimationFrame(() => requestAnimationFrame(() => { tasksContainerEl.scrollTop = projectToToggle.ui_scrollPosition || 0; }));} saveData(); } });
            const completeCheckbox = card.querySelector('.quest-complete-checkbox'); if (completeCheckbox) completeCheckbox.addEventListener('change', (e) => toggleProjectComplete(project.id, e.target.checked));
            const priorityBtn = card.querySelector('.priority-button'); if (priorityBtn) priorityBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleProjectPriority(project.id); });
            card.querySelector('.quest-title-text').addEventListener('click', () => openQuestModal(project.id));
            card.querySelectorAll('.task-checkbox').forEach(cb => cb.addEventListener('change', (e) => toggleTaskComplete(project.id, e.target.dataset.taskId, e.target.checked, e.target)));
            card.querySelectorAll('.subtask-checkbox').forEach(cb => cb.addEventListener('change', (e) => toggleSubtaskComplete(project.id, e.target.dataset.mainTaskId, e.target.dataset.subtaskId, e.target.checked, e.target)));
            const moreActionsBtn = card.querySelector('.more-actions-button'); const actionsDropdown = card.querySelector('.actions-dropdown');
            moreActionsBtn.addEventListener('click', (e) => { e.stopPropagation(); document.querySelectorAll('.actions-dropdown').forEach(dd => { if (dd !== actionsDropdown) dd.style.display = 'none'; }); actionsDropdown.style.display = actionsDropdown.style.display === 'none' ? 'block' : 'none'; });
            card.querySelector('.action-edit-quest')?.addEventListener('click', () => { openQuestModal(project.id); actionsDropdown.style.display = 'none'; });
            card.querySelector('.action-archive-quest')?.addEventListener('click', () => { archiveProject(project.id); actionsDropdown.style.display = 'none'; });
            card.querySelector('.action-unarchive-quest')?.addEventListener('click', () => { unarchiveProject(project.id); actionsDropdown.style.display = 'none'; });
            card.querySelector('.action-delete-quest')?.addEventListener('click', () => { deleteProject(project.id); actionsDropdown.style.display = 'none'; });
            return card;
        }

        function createTaskElement(task, projectId, projectTitle, isProjectArchived) {
            task.subtasks = task.subtasks || []; let valueDisplay = '';
            if (task.taskValue !== undefined && task.taskValue > 0) valueDisplay = `<span class="task-value-chip">$${(parseFloat(task.taskValue) || 0).toFixed(0)}</span>`;
            return `<div class="task-item ${task.isCompleted ? 'completed' : ''}" data-task-id="${task.id}"><input type="checkbox" class="task-checkbox" data-task-id="${task.id}" ${task.isCompleted ? 'checked' : ''} title="Complete task: ${task.description}" aria-label="Mark task '${task.description}' of quest '${projectTitle}' as ${task.isCompleted ? 'incomplete' : 'complete'}" ${isProjectArchived ? 'disabled' : ''}><span class="task-description">${task.description}</span> ${valueDisplay}</div> ${(task.subtasks || []).map(subtask => createSubtaskElement(subtask, task.id, projectId, projectTitle, task.description, isProjectArchived)).join('')}`;
        }
        function createSubtaskElement(subtask, mainTaskId, projectId, projectTitle, mainTaskDescription, isProjectArchived) {
            return `<div class="subtask-item ${subtask.isCompleted ? 'completed' : ''}" data-subtask-id="${subtask.id}" data-main-task-id="${mainTaskId}"><input type="checkbox" class="subtask-checkbox" data-main-task-id="${mainTaskId}" data-subtask-id="${subtask.id}" ${subtask.isCompleted ? 'checked' : ''} title="Complete subtask: ${subtask.description}" aria-label="Mark subtask '${subtask.description}' of task '${mainTaskDescription}' as ${subtask.isCompleted ? 'incomplete' : 'complete'}" ${isProjectArchived ? 'disabled' : ''}><span class="task-description">${subtask.description}</span></div>`;
        }
        function distributeValueToTasks(project) {
            project.tasks = project.tasks || []; const mainTasks = project.tasks; const mainTaskCount = mainTasks.length; const totalVal = parseFloat(project.totalValue) || 0;
            if (mainTaskCount === 0 || totalVal === 0) { project.tasks.forEach(task => { task.taskValue = 0; task.subtasks = task.subtasks || []; task.subtasks.forEach(sub => sub.subtaskValue = 0); }); return; }
            const valuePerMainTask = totalVal / mainTaskCount;
            mainTasks.forEach(task => { task.taskValue = valuePerMainTask; task.subtasks = task.subtasks || []; if (task.subtasks.length > 0) { const valuePerSubtask = task.taskValue / task.subtasks.length; task.subtasks.forEach(sub => sub.subtaskValue = valuePerSubtask); } });
        }
        function toggleProjectComplete(projectId, isBeingMarkedCompleted) {
            const project = appData.projects.find(p => p.id === projectId); if (!project || project.isArchived) return;
            project.tasks = project.tasks || []; project.tasks.forEach(t => t.subtasks = t.subtasks || []);
            const oldCompletedState = project.isCompleted; project.isCompleted = isBeingMarkedCompleted;
            if (isBeingMarkedCompleted) { project.completionTimestamp = project.completionTimestamp || Date.now(); project.valueEarned = parseFloat(project.totalValue) || 0; project.tasks.forEach(task => { task.isCompleted = true; task.completionTimestamp = task.completionTimestamp || Date.now(); task.subtasks.forEach(sub => { sub.isCompleted = true; sub.completionTimestamp = sub.completionTimestamp || Date.now(); }); }); if (!oldCompletedState) { showToast(`Quest "<strong>${project.title}</strong>" completed! +$${project.valueEarned.toFixed(0)} earned.`, 'success', 4000); }} 
            else { project.completionTimestamp = null; if (oldCompletedState) { showToast(`Quest "<strong>${project.title}</strong>" reactivated.`, 'info'); } }
            updateProjectCardDOM(projectId, true);
        }
        function updateProjectCardDOM(projectId, forceRenderAll = false) {
            const project = appData.projects.find(p => p.id === projectId); if (!project) return;
            project.tasks = project.tasks || []; project.tasks.forEach(t => t.subtasks = t.subtasks || []);
            const projectCardElement = document.querySelector(`.quest-card[data-id="${projectId}"]`);
            let newEarnedValue = 0;
            project.tasks.forEach(task => { if (task.subtasks.length > 0) { task.subtasks.forEach(subtask => { if (subtask.isCompleted) newEarnedValue += (parseFloat(subtask.subtaskValue) || 0); }); } else { if (task.isCompleted) newEarnedValue += (parseFloat(task.taskValue) || 0); }});
            project.valueEarned = Math.max(0, Math.min(newEarnedValue, parseFloat(project.totalValue) || 0));
            if (projectCardElement) { const valueElement = projectCardElement.querySelector('.quest-value .value-earned'); if (valueElement) valueElement.textContent = `$${project.valueEarned.toFixed(0)}`; const totalValEl = projectCardElement.querySelector('.quest-value'); if(totalValEl) totalValEl.innerHTML = `<svg class="icon" style="width:1em; height:1em; vertical-align:-0.1em; color: var(--success-color);"><use xlink:href="#icon-check-circle"></use></svg> Value: <span class="value-earned">$${project.valueEarned.toFixed(0)}</span> / $${(parseFloat(project.totalValue) || 0).toFixed(0)}`; const totalValProgress = parseFloat(project.totalValue) || 0; const earnedValProgress = project.valueEarned; let progressPercent = totalValProgress > 0 ? (earnedValProgress / totalValProgress) * 100 : 0; if (project.isCompleted) progressPercent = 100; const progressFill = projectCardElement.querySelector('.quest-progress-fill'); const progressText = projectCardElement.querySelector('.quest-progress-value-text'); if (progressFill) progressFill.style.width = `${Math.min(100, progressPercent).toFixed(0)}%`; if (progressText) progressText.textContent = `${progressPercent.toFixed(0)}%`; if (progressFill && progressFill.parentElement) progressFill.parentElement.title = `Progress: ${progressPercent.toFixed(0)}%`; }
            const oldProjectCompletedState = project.isCompleted;
            const allTasksEffectivelyDone = project.tasks.length > 0 && project.tasks.every(task => { if (task.subtasks.length > 0) return task.subtasks.every(st => st.isCompleted); return task.isCompleted; });
            if (allTasksEffectivelyDone && !project.isCompleted && !project.isArchived) { project.isCompleted = true; project.completionTimestamp = project.completionTimestamp || Date.now(); project.valueEarned = parseFloat(project.totalValue); if (!oldProjectCompletedState) showToast(`Quest "<strong>${project.title}</strong>" auto-completed!`, 'success', 4000); } 
            else if (!allTasksEffectivelyDone && project.isCompleted && !project.isArchived) { project.isCompleted = false; project.completionTimestamp = null; if (oldProjectCompletedState) showToast(`Quest "<strong>${project.title}</strong>" reactivated (task incomplete).`, 'info'); }
            if (forceRenderAll || oldProjectCompletedState !== project.isCompleted) { saveData(); renderProjects(); } 
            else { if (projectCardElement) { const mainCheckbox = projectCardElement.querySelector('.quest-complete-checkbox'); if (mainCheckbox && mainCheckbox.checked !== project.isCompleted) { mainCheckbox.checked = project.isCompleted; mainCheckbox.setAttribute('aria-label', `Mark quest '${project.title}' as ${project.isCompleted ? 'active' : 'complete'}`); } projectCardElement.classList.toggle('completed-quest', project.isCompleted); } saveData(); updateDashboard(); }
        }
        function toggleProjectPriority(projectId) { const project = appData.projects.find(p => p.id === projectId); if (!project || project.isArchived) return; project.priority = !project.priority; saveData(); renderProjects(); if(project.priority) { showToast(`Quest "<strong>${project.title}</strong>" prioritized.`, 'info'); } else { showToast(`Quest "<strong>${project.title}</strong>" unprioritized.`, 'info'); }}
        function toggleTaskComplete(projectId, taskId, isCompleted, checkboxElement) { const project = appData.projects.find(p => p.id === projectId); if (!project || project.isArchived) return; project.tasks = project.tasks || []; const task = project.tasks.find(t => t.id === taskId); if (!task) return; task.subtasks = task.subtasks || []; const wasTaskPreviouslyCompleted = task.isCompleted; task.isCompleted = isCompleted; if (isCompleted && !wasTaskPreviouslyCompleted) task.completionTimestamp = task.completionTimestamp || Date.now(); else if (!isCompleted) task.completionTimestamp = null; const taskItemElement = checkboxElement.closest('.task-item'); if (taskItemElement) { taskItemElement.classList.toggle('completed', isCompleted); checkboxElement.setAttribute('aria-label', `Mark task '${task.description}' of quest '${project.title}' as ${isCompleted ? 'incomplete' : 'complete'}`);} let valueChangeForToast = 0; task.subtasks.forEach(sub => { const wasSubtaskPreviouslyCompleted = sub.isCompleted; sub.isCompleted = isCompleted; if (isCompleted && !wasSubtaskPreviouslyCompleted) { sub.completionTimestamp = sub.completionTimestamp || Date.now(); valueChangeForToast += (parseFloat(sub.subtaskValue) || 0); } else if (!isCompleted) sub.completionTimestamp = null; const subtaskItemElement = document.querySelector(`.subtask-item[data-subtask-id="${sub.id}"][data-main-task-id="${task.id}"]`); if (subtaskItemElement) { subtaskItemElement.classList.toggle('completed', isCompleted); const subtaskCheckbox = subtaskItemElement.querySelector('.subtask-checkbox'); if (subtaskCheckbox) { subtaskCheckbox.checked = isCompleted; subtaskCheckbox.setAttribute('aria-label', `Mark subtask '${sub.description}' of task '${task.description}' as ${isCompleted ? 'incomplete' : 'complete'}`);}}}); if (task.subtasks.length === 0 && isCompleted && !wasTaskPreviouslyCompleted) valueChangeForToast = parseFloat(task.taskValue) || 0; if (isCompleted && !wasTaskPreviouslyCompleted) { const message = valueChangeForToast > 0 ? `Task "<strong>${task.description}</strong>" completed! +$${valueChangeForToast.toFixed(0)}` : `Task "<strong>${task.description}</strong>" completed!`; showToast(message, 'success'); } else if (!isCompleted && wasTaskPreviouslyCompleted) { showToast(`Task "<strong>${task.description}</strong>" un-checked.`, 'info');} updateProjectCardDOM(projectId); }
        function toggleSubtaskComplete(projectId, mainTaskId, subtaskId, isCompleted, checkboxElement) { const project = appData.projects.find(p => p.id === projectId); if (!project || project.isArchived) return; project.tasks = project.tasks || []; const mainTask = project.tasks.find(t => t.id === mainTaskId); if (!mainTask) return; mainTask.subtasks = mainTask.subtasks || []; const subtask = mainTask.subtasks.find(s => s.id === subtaskId); if (!subtask) return; const wasSubtaskPreviouslyCompleted = subtask.isCompleted; subtask.isCompleted = isCompleted; if (isCompleted && !wasSubtaskPreviouslyCompleted) subtask.completionTimestamp = subtask.completionTimestamp || Date.now(); else if (!isCompleted) subtask.completionTimestamp = null; const subtaskItemElement = checkboxElement.closest('.subtask-item'); if (subtaskItemElement) { subtaskItemElement.classList.toggle('completed', isCompleted); checkboxElement.setAttribute('aria-label', `Mark subtask '${subtask.description}' of task '${mainTask.description}' as ${isCompleted ? 'incomplete' : 'complete'}`);} if (isCompleted && !wasSubtaskPreviouslyCompleted) { const subValue = parseFloat(subtask.subtaskValue) || 0; const message = subValue > 0 ? `Subtask "<strong>${subtask.description}</strong>" completed! +$${subValue.toFixed(0)}` : `Subtask "<strong>${subtask.description}</strong>" completed!`; showToast(message, 'success'); } else if (!isCompleted && wasSubtaskPreviouslyCompleted) { showToast(`Subtask "<strong>${subtask.description}</strong>" un-checked.`, 'info');} const wasMainTaskPreviouslyCompleted = mainTask.isCompleted; if (mainTask.subtasks.length > 0) { const allSubtasksDone = mainTask.subtasks.every(s => s.isCompleted); if (allSubtasksDone && !wasMainTaskPreviouslyCompleted) { mainTask.isCompleted = true; mainTask.completionTimestamp = mainTask.completionTimestamp || Date.now(); showToast(`Task "<strong>${mainTask.description}</strong>" completed! (All subtasks done)`, 'success'); } else if (!allSubtasksDone && wasMainTaskPreviouslyCompleted) { mainTask.isCompleted = false; mainTask.completionTimestamp = null; showToast(`Task "<strong>${mainTask.description}</strong>" reactivated (subtask un-checked).`, 'info'); } else { mainTask.isCompleted = allSubtasksDone; } const mainTaskItemElement = document.querySelector(`.task-item[data-task-id="${mainTask.id}"]`); if (mainTaskItemElement) { mainTaskItemElement.classList.toggle('completed', mainTask.isCompleted); const mainTaskCheckbox = mainTaskItemElement.querySelector('.task-checkbox'); if (mainTaskCheckbox) { mainTaskCheckbox.checked = mainTask.isCompleted; mainTaskCheckbox.setAttribute('aria-label', `Mark task '${mainTask.description}' of quest '${project.title}' as ${mainTask.isCompleted ? 'incomplete' : 'complete'}`);}}} updateProjectCardDOM(projectId); }
        function deleteProject(projectId) { const project = appData.projects.find(p => p.id === projectId); if (!project) return; showCustomConfirm(`Are you sure you want to PERMANENTLY DELETE the quest "<strong>${project.title}</strong>"? This cannot be undone.`, "Delete Quest", () => { appData.projects = appData.projects.filter(p => p.id !== projectId); saveData(); renderProjects(); showToast(`Quest "<strong>${project.title}</strong>" deleted.`, 'info'); });}
        function archiveProject(projectId) { const project = appData.projects.find(p => p.id === projectId); if (!project) return; project.isArchived = true; saveData(); renderProjects(); showToast(`Quest "<strong>${project.title}</strong>" archived.`, 'info');}
        function unarchiveProject(projectId) { const project = appData.projects.find(p => p.id === projectId); if (!project) return; project.isArchived = false; saveData(); renderProjects(); showToast(`Quest "<strong>${project.title}</strong>" unarchived.`, 'info');}

        const questModal = document.getElementById('questModal'); const closeQuestModalBtn = document.getElementById('closeQuestModal'); const cancelQuestModalBtn = document.getElementById('cancelQuestModalBtn'); const addQuestHeaderBtn = document.getElementById('addQuestHeaderBtn'); const saveQuestBtn = document.getElementById('saveQuestBtn'); const questModalTitleEl = document.getElementById('questModalTitle'); const questIdInput = document.getElementById('questId'); const questTitleInput = document.getElementById('questTitle'); const questDeadlineInput = document.getElementById('questDeadline'); const questValueInput = document.getElementById('questValueInput'); const questTemplateSelect = document.getElementById('questTemplateSelect'); const modalTasksContainer = document.getElementById('modalTasksContainer'); const addModalMainTaskBtn = document.getElementById('addModalMainTaskBtn');
        function openQuestModal(projectId = null) {
            populateTemplateSelect(questTemplateSelect); modalTasksContainer.innerHTML = ''; 
            if (projectId) { const project = appData.projects.find(p => p.id === projectId); project.tasks = project.tasks || []; questModalTitleEl.textContent = 'Edit Quest'; questIdInput.value = project.id; questTitleInput.value = project.title; questDeadlineInput.value = project.deadline || ''; questValueInput.value = project.totalValue; project.tasks.forEach(taskData => { taskData.subtasks = taskData.subtasks || []; addModalTaskEditor(taskData); });
            } else { questModalTitleEl.textContent = 'Start New Quest'; questIdInput.value = ''; questTitleInput.value = ''; questDeadlineInput.value = getTodayString(); questValueInput.value = '100'; const defaultTemplateId = questTemplateSelect.value; if (defaultTemplateId) { const template = appData.templates.find(t => t.id === defaultTemplateId); if (template) (template.tasks || []).forEach(taskData => addModalTaskEditor({ ...taskData, id: generateId(), isCompleted: false, completionTimestamp: null, subtasks: (taskData.subtasks || []).map(st => ({...st, id: generateId(), isCompleted: false, completionTimestamp: null, subtaskValue: 0})) })); } else { addModalTaskEditor(); } }
            questModal.style.display = 'block'; questTitleInput.focus();
        }
        questTemplateSelect.addEventListener('change', () => { if (!questIdInput.value) { modalTasksContainer.innerHTML = ''; const templateId = questTemplateSelect.value; if (templateId) { const template = appData.templates.find(t => t.id === templateId); if (template) (template.tasks || []).forEach(taskData => addModalTaskEditor({ ...taskData, id: generateId(), isCompleted: false, completionTimestamp: null, subtasks: (taskData.subtasks || []).map(st => ({...st, id: generateId(), isCompleted: false, completionTimestamp: null, subtaskValue: 0})) })); } else { addModalTaskEditor(); } }});
        function addModalTaskEditor(taskData = null) { const taskId = taskData ? taskData.id : generateId(); const taskDesc = taskData ? taskData.description : ''; const taskDiv = document.createElement('div'); taskDiv.className = 'task-editor-item'; taskDiv.dataset.taskId = taskId; taskDiv.innerHTML = `<div class="task-editor-header"><input type="text" class="modal-task-desc" value="${taskDesc}" placeholder="Main Task Description"><button type="button" class="remove-modal-task-btn btn-icon-only danger" title="Remove This Task" aria-label="Remove This Task"><svg class="icon"><use xlink:href="#icon-trash"></use></svg></button><button type="button" class="add-modal-subtask-btn btn-icon-only" title="Add Subtask to This Task" aria-label="Add Subtask to This Task"><svg class="icon"><use xlink:href="#icon-plus-circle"></use></svg></button></div><div class="modal-subtasks-list" style="padding-top: 5px;"></div>`; modalTasksContainer.appendChild(taskDiv); if (taskData && taskData.subtasks) { taskData.subtasks = taskData.subtasks || []; taskData.subtasks.forEach(subtaskData => addModalSubtaskEditor(taskDiv.querySelector('.modal-subtasks-list'), subtaskData)); } taskDiv.querySelector('.remove-modal-task-btn').onclick = () => taskDiv.remove(); taskDiv.querySelector('.add-modal-subtask-btn').onclick = () => addModalSubtaskEditor(taskDiv.querySelector('.modal-subtasks-list'));}
        function addModalSubtaskEditor(parentList, subtaskData = null) { const subtaskId = subtaskData ? subtaskData.id : generateId(); const subtaskDesc = subtaskData ? subtaskData.description : ''; const subtaskDiv = document.createElement('div'); subtaskDiv.className = 'subtask-editor-item'; subtaskDiv.dataset.subtaskId = subtaskId; subtaskDiv.innerHTML = `<input type="text" class="modal-subtask-desc" value="${subtaskDesc}" placeholder="Subtask Description"><button type="button" class="remove-modal-subtask-btn btn-icon-only danger" title="Remove This Subtask" aria-label="Remove This Subtask"><svg class="icon"><use xlink:href="#icon-trash"></use></svg></button>`; parentList.appendChild(subtaskDiv); subtaskDiv.querySelector('.remove-modal-subtask-btn').onclick = () => subtaskDiv.remove();}
        addModalMainTaskBtn.addEventListener('click', () => addModalTaskEditor());
        closeQuestModalBtn.addEventListener('click', () => questModal.style.display = 'none');
        cancelQuestModalBtn.addEventListener('click', () => questModal.style.display = 'none');
        addQuestHeaderBtn.addEventListener('click', () => openQuestModal());
        saveQuestBtn.addEventListener('click', () => { const id = questIdInput.value || generateId(); const title = questTitleInput.value.trim(); const deadline = questDeadlineInput.value; const totalValue = parseFloat(questValueInput.value) || 0; if (!title) { showToast('Quest Title is required.', 'warning'); questTitleInput.focus(); return; } const tasksFromModal = []; document.querySelectorAll('#modalTasksContainer .task-editor-item').forEach(taskDiv => { const taskDesc = taskDiv.querySelector('.modal-task-desc').value.trim(); if (taskDesc) { const mainTask = { id: taskDiv.dataset.taskId, description: taskDesc, isCompleted: false, completionTimestamp: null, taskValue: 0, subtasks: [] }; taskDiv.querySelectorAll('.subtask-editor-item').forEach(subtaskDiv => { const subtaskDesc = subtaskDiv.querySelector('.modal-subtask-desc').value.trim(); if (subtaskDesc) mainTask.subtasks.push({ id: subtaskDiv.dataset.subtaskId, description: subtaskDesc, isCompleted: false, completionTimestamp: null, subtaskValue: 0 }); }); tasksFromModal.push(mainTask); }}); const existingProject = appData.projects.find(p => p.id === id); if (existingProject) { existingProject.title = title; existingProject.deadline = deadline; existingProject.totalValue = totalValue; existingProject.tasks = existingProject.tasks || []; const oldTasksMap = new Map(existingProject.tasks.map(t => [t.id, t])); tasksFromModal.forEach(newTask => { newTask.subtasks = newTask.subtasks || []; const oldTask = oldTasksMap.get(newTask.id); if (oldTask) { oldTask.subtasks = oldTask.subtasks || []; newTask.isCompleted = oldTask.isCompleted; newTask.completionTimestamp = oldTask.completionTimestamp; const oldSubtasksMap = new Map(oldTask.subtasks.map(st => [st.id, st])); newTask.subtasks.forEach(newSubtask => { const oldSubtask = oldSubtasksMap.get(newSubtask.id); if(oldSubtask) { newSubtask.isCompleted = oldSubtask.isCompleted; newSubtask.completionTimestamp = oldSubtask.completionTimestamp; }}); }}); existingProject.tasks = tasksFromModal; distributeValueToTasks(existingProject); updateProjectCardDOM(existingProject.id, true); showToast(`Quest "<strong>${existingProject.title}</strong>" updated.`, 'info'); } else { const newProject = { id, title, deadline, totalValue, valueEarned: 0, isCompleted: false, completionTimestamp: null, priority: false, tasks: tasksFromModal, ui_isExpanded: true, ui_scrollPosition: 0, isArchived: false, creationTimestamp: Date.now() }; distributeValueToTasks(newProject); appData.projects.push(newProject); saveData(); renderProjects(); showToast(`Quest "<strong>${newProject.title}</strong>" started.`, 'success'); } questModal.style.display = 'none';});

        const settingsModal = document.getElementById('settingsModal'); const closeSettingsModalBtn = document.getElementById('closeSettingsModal'); const doneSettingsModalBtn = document.getElementById('doneSettingsModalBtn'); const settingsHeaderBtn = document.getElementById('settingsHeaderBtn'); const templateIdInput = document.getElementById('templateId'); const templateNameInput = document.getElementById('templateName'); const templateTasksContainer = document.getElementById('templateTasksContainer'); const addTemplateMainTaskBtn = document.getElementById('addTemplateMainTaskBtn'); const saveTemplateBtn = document.getElementById('saveTemplateBtn'); const newTemplateBtn = document.getElementById('newTemplateBtn'); const templateListDiv = document.getElementById('templateList'); const goToSettingsFromNotification = document.getElementById('goToSettingsFromNotification');
        settingsHeaderBtn.addEventListener('click', () => { loadTemplateEditor(); renderTemplateList(); settingsModal.style.display = 'block'; templateNameInput.focus(); });
        closeSettingsModalBtn.addEventListener('click', () => settingsModal.style.display = 'none');
        doneSettingsModalBtn.addEventListener('click', () => settingsModal.style.display = 'none');
        goToSettingsFromNotification.addEventListener('click', () => { settingsModal.style.display = 'block'; loadTemplateEditor(); renderTemplateList(); templateNameInput.focus(); });
        function loadTemplateEditor(templateId = null) { templateTasksContainer.innerHTML = ''; if (templateId) { const template = appData.templates.find(t => t.id === templateId); if (template) { template.tasks = template.tasks || []; templateIdInput.value = template.id; templateNameInput.value = template.name; template.tasks.forEach(taskData => { taskData.subtasks = taskData.subtasks || []; addTemplateTaskEditor(taskData); }); }} else { templateIdInput.value = ''; templateNameInput.value = ''; addTemplateTaskEditor(); } templateNameInput.focus();}
        function addTemplateTaskEditor(taskData = null) { const taskDesc = taskData ? taskData.description : ''; const taskDiv = document.createElement('div'); taskDiv.className = 'task-editor-item'; taskDiv.innerHTML = `<div class="task-editor-header"><input type="text" class="template-task-desc" value="${taskDesc}" placeholder="Main Task Description"><button type="button" class="remove-template-task-btn btn-icon-only danger" title="Remove This Task" aria-label="Remove This Task from template"><svg class="icon"><use xlink:href="#icon-trash"></use></svg></button><button type="button" class="add-template-subtask-btn btn-icon-only" title="Add Subtask to This Task" aria-label="Add Subtask to This Task in template"><svg class="icon"><use xlink:href="#icon-plus-circle"></use></svg></button></div><div class="template-subtasks-list" style="padding-top: 5px;"></div>`; templateTasksContainer.appendChild(taskDiv); if (taskData && taskData.subtasks) { taskData.subtasks = taskData.subtasks || []; taskData.subtasks.forEach(subtaskData => addTemplateSubtaskEditor(taskDiv.querySelector('.template-subtasks-list'), subtaskData)); } taskDiv.querySelector('.remove-template-task-btn').onclick = () => taskDiv.remove(); taskDiv.querySelector('.add-template-subtask-btn').onclick = () => addTemplateSubtaskEditor(taskDiv.querySelector('.template-subtasks-list'));}
        function addTemplateSubtaskEditor(parentList, subtaskData = null) { const subtaskDesc = subtaskData ? subtaskData.description : ''; const subtaskDiv = document.createElement('div'); subtaskDiv.className = 'subtask-editor-item'; subtaskDiv.innerHTML = `<input type="text" class="template-subtask-desc" value="${subtaskDesc}" placeholder="Subtask Description"><button type="button" class="remove-template-subtask-btn btn-icon-only danger" title="Remove This Subtask" aria-label="Remove This Subtask from template"><svg class="icon"><use xlink:href="#icon-trash"></use></svg></button>`; parentList.appendChild(subtaskDiv); subtaskDiv.querySelector('.remove-template-subtask-btn').onclick = () => subtaskDiv.remove();}
        addTemplateMainTaskBtn.addEventListener('click', () => addTemplateTaskEditor());
        newTemplateBtn.addEventListener('click', () => loadTemplateEditor()); 
        saveTemplateBtn.addEventListener('click', () => { const id = templateIdInput.value || generateId(); const name = templateNameInput.value.trim(); if (!name) { showToast('Template Name is required.', 'warning'); templateNameInput.focus(); return; } const tasks = []; document.querySelectorAll('#templateTasksContainer .task-editor-item').forEach(taskDiv => { const taskDesc = taskDiv.querySelector('.template-task-desc').value.trim(); if (taskDesc) { const mainTask = { description: taskDesc, subtasks: [] }; taskDiv.querySelectorAll('.subtask-editor-item').forEach(subtaskDiv => { const subtaskDesc = subtaskDiv.querySelector('.template-subtask-desc').value.trim(); if (subtaskDesc) mainTask.subtasks.push({ description: subtaskDesc }); }); tasks.push(mainTask); }}); const existingIndex = appData.templates.findIndex(t => t.id === id); if (existingIndex > -1) { appData.templates[existingIndex].name = name; appData.templates[existingIndex].tasks = tasks; showToast(`Template "<strong>${name}</strong>" updated.`, 'success'); } else { const isFirstTemplate = appData.templates.length === 0; appData.templates.push({ id, name, tasks, isDefault: isFirstTemplate }); showToast(`Template "<strong>${name}</strong>" saved.`, 'success'); } saveData(); renderTemplateList(); loadTemplateEditor(id); });
        function renderTemplateList() { templateListDiv.innerHTML = ''; if (appData.templates.length === 0) { templateListDiv.innerHTML = '<p style="color: var(--text-secondary); font-style: italic;">No templates. Create one!</p>'; return; } appData.templates.forEach(template => { const item = document.createElement('div'); item.className = 'template-item'; if (template.isDefault) item.classList.add('default-template'); item.innerHTML = `<span>${template.name} ${template.isDefault ? '<strong style="color: var(--star-important-color);">(Default)</strong>' : ''}</span><div class="template-actions"><button class="edit-template-btn button" data-id="${template.id}" title="Edit ${template.name} template"><svg class="icon"><use xlink:href="#icon-pencil"></use></svg> Edit</button>${!template.isDefault ? `<button class="set-default-template-btn button" data-id="${template.id}" title="Set ${template.name} as Default Template" style="background-color:var(--star-important-color);color:var(--text-color);border-color:var(--star-important-color);"><svg class="icon"><use xlink:href="#icon-star"></use></svg> Set Default</button>` : ''}<button class="delete-template-btn btn-icon-only danger" data-id="${template.id}" title="Delete ${template.name} template" aria-label="Delete ${template.name} template"><svg class="icon"><use xlink:href="#icon-trash"></use></svg></button></div>`; templateListDiv.appendChild(item); }); templateListDiv.querySelectorAll('.edit-template-btn').forEach(btn => btn.onclick = () => loadTemplateEditor(btn.dataset.id)); templateListDiv.querySelectorAll('.delete-template-btn').forEach(btn => btn.onclick = () => deleteTemplate(btn.dataset.id)); templateListDiv.querySelectorAll('.set-default-template-btn').forEach(btn => btn.onclick = () => setDefaultTemplate(btn.dataset.id));}
        function deleteTemplate(templateId) { const templateToDelete = appData.templates.find(t => t.id === templateId); if (!templateToDelete) return; if (templateToDelete.isDefault && appData.templates.length <= 1) { showToast("Cannot delete the only default template.", 'warning', 4000); return; } if (templateToDelete.isDefault && appData.templates.length > 1) { showToast("Cannot delete active default. Change default first.", 'warning', 4000); return; } showCustomConfirm(`Are you sure you want to delete the template "<strong>${templateToDelete.name}</strong>"?`, "Delete Template", () => { const name = templateToDelete.name; appData.templates = appData.templates.filter(t => t.id !== templateId); if (appData.templates.length > 0 && !appData.templates.some(t => t.isDefault)) { appData.templates[0].isDefault = true; } saveData(); renderTemplateList(); loadTemplateEditor(); showToast(`Template "<strong>${name}</strong>" deleted.`, 'info'); });}
        function setDefaultTemplate(templateId) { let name = ''; appData.templates.forEach(t => { t.isDefault = (t.id === templateId); if (t.isDefault) name = t.name; }); saveData(); renderTemplateList(); if (name) { showToast(`Template "<strong>${name}</strong>" set as default.`, 'info'); }}
        function populateTemplateSelect(selectElement) { selectElement.innerHTML = '<option value="">-- No Template --</option>'; let defaultId = null; appData.templates.forEach(template => { const option = document.createElement('option'); option.value = template.id; option.textContent = template.name; if (template.isDefault) { option.selected = true; defaultId = template.id; } selectElement.appendChild(option); }); if (defaultId) selectElement.value = defaultId; return defaultId;}

        const clearOldDataBtn = document.getElementById('clearOldDataBtn');
        const clearDataNotificationDiv = document.getElementById('clearDataNotification');
        function checkClearDataNotification() { const today = new Date(); if (today.getDate() > 7) { const firstDayCurrentMonth = new Date(today.getFullYear(), today.getMonth(), 1); const hasOld = appData.projects.some(p => p.isCompleted && p.completionTimestamp && new Date(p.completionTimestamp) < firstDayCurrentMonth); clearDataNotificationDiv.style.display = hasOld ? 'flex' : 'none'; } else { clearDataNotificationDiv.style.display = 'none'; }}
        clearOldDataBtn.addEventListener('click', () => { showCustomConfirm('WARNING! Permanently DELETE old project data (completed BEFORE current month)? This action CANNOT BE UNDONE. Are you sure?', "Clear Old Project Data", () => { const firstDayCurrentMonth = new Date(); firstDayCurrentMonth.setDate(1); firstDayCurrentMonth.setHours(0,0,0,0); const initialCount = appData.projects.length; appData.projects = appData.projects.filter(p => !(p.isCompleted && p.completionTimestamp && new Date(p.completionTimestamp) < firstDayCurrentMonth)); const cleared = initialCount - appData.projects.length; saveData(); renderProjects(); showToast(`${cleared} old project(s) cleared.`, 'success', 4000); checkClearDataNotification(); settingsModal.style.display = 'none'; });});

        window.addEventListener('DOMContentLoaded', () => {
            loadData(); initCustomConfirmModal(); 
            toggleInactiveSectionsBtn = document.getElementById('toggleInactiveSectionsBtn');
            const svgIconElement = document.getElementById('inactiveSectionsToggleIcon'); 
            if (svgIconElement && svgIconElement.tagName.toLowerCase() === 'svg') { inactiveSectionsToggleIcon = svgIconElement.querySelector('use') || svgIconElement; } 
            else if (svgIconElement && svgIconElement.tagName.toLowerCase() === 'use') { inactiveSectionsToggleIcon = svgIconElement; }
            inactiveSectionsToggleText = document.getElementById('inactiveSectionsToggleText');
            completedSectionContainer = document.getElementById('completedSectionContainer');
            archivedSectionContainer = document.getElementById('archivedSectionContainer');
            initInactiveSectionsToggle(); 
            updateDashboard(); 
            renderWeeklyCalendar(weeklyCalendarContainer, currentWeeklyCalendarDate);
            checkClearDataNotification(); 
            document.addEventListener('click', function(event) { const openDropdowns = document.querySelectorAll('.actions-dropdown'); let clickedInsideDropdownRelated = false; openDropdowns.forEach(dd => { if (dd.style.display === 'block') { if (dd.contains(event.target) || (dd.previousElementSibling && dd.previousElementSibling.contains(event.target))) clickedInsideDropdownRelated = true; }}); if (!clickedInsideDropdownRelated) openDropdowns.forEach(dd => dd.style.display = 'none'); if (event.target == questModal) questModal.style.display = "none"; if (event.target == settingsModal) settingsModal.style.display = "none"; if (event.target == customConfirmModal) customConfirmModal.style.display = "none"; });
            document.addEventListener('keydown', function(event) { if (event.key === "Escape" || event.key === "Esc") { if (questModal.style.display === 'block') questModal.style.display = "none"; if (settingsModal.style.display === 'block') settingsModal.style.display = "none"; if (customConfirmModal.style.display === 'block') customConfirmModal.style.display = "none"; document.querySelectorAll('.actions-dropdown').forEach(dd => dd.style.display = 'none'); }});
            const toggleCompletedListBtn = document.getElementById('toggleCompletedListBtn'); const completedQuestsListWrapper = document.getElementById('completedQuestsListWrapper'); const completedQuestsList = document.getElementById('completedQuestsList'); let isCompletedListExpanded = false; 
            if (toggleCompletedListBtn && completedQuestsListWrapper) { completedQuestsListWrapper.classList.remove('expanded'); toggleCompletedListBtn.querySelector('use').setAttribute('xlink:href', '#icon-chevron-down'); toggleCompletedListBtn.addEventListener('click', () => { isCompletedListExpanded = !isCompletedListExpanded; completedQuestsListWrapper.classList.toggle('expanded', isCompletedListExpanded); toggleCompletedListBtn.querySelector('use').setAttribute('xlink:href', isCompletedListExpanded ? '#icon-chevron-up' : '#icon-chevron-down'); if (isCompletedListExpanded && inactiveSectionsVisible && completedQuestsList.children.length === 0) { if (!completedQuestsList.querySelector('.empty-list-message')) completedQuestsList.innerHTML = '<p class="empty-list-message">No quests completed this month yet.</p>'; } else if (!isCompletedListExpanded && completedQuestsList.querySelector('.empty-list-message')) completedQuestsList.querySelector('.empty-list-message').remove(); });}
            const toggleArchivedListBtn = document.getElementById('toggleArchivedListBtn'); const archivedQuestsListWrapper = document.getElementById('archivedQuestsListWrapper'); const archivedQuestsList = document.getElementById('archivedQuestsList'); let isArchivedListExpanded = false; 
            if (toggleArchivedListBtn && archivedQuestsListWrapper) { archivedQuestsListWrapper.classList.remove('expanded'); toggleArchivedListBtn.querySelector('use').setAttribute('xlink:href', '#icon-chevron-down'); toggleArchivedListBtn.addEventListener('click', () => { isArchivedListExpanded = !isArchivedListExpanded; archivedQuestsListWrapper.classList.toggle('expanded', isArchivedListExpanded); toggleArchivedListBtn.querySelector('use').setAttribute('xlink:href', isArchivedListExpanded ? '#icon-chevron-up' : '#icon-chevron-down'); if(isArchivedListExpanded && inactiveSectionsVisible && archivedQuestsList.children.length === 0) { if (!archivedQuestsList.querySelector('.empty-list-message')) archivedQuestsList.innerHTML = '<p class="empty-list-message">No archived quests.</p>'; } else if (!isArchivedListExpanded && archivedQuestsList.querySelector('.empty-list-message')) archivedQuestsList.querySelector('.empty-list-message').remove(); });}
        });
        window.addEventListener('beforeunload', () => { appData.projects.forEach(project => { if (project.ui_isExpanded) { const projectCard = document.querySelector(`.quest-card[data-id="${project.id}"]`); if (projectCard) { const tasksContainerEl = projectCard.querySelector('.tasks-container'); if (tasksContainerEl) project.ui_scrollPosition = tasksContainerEl.scrollTop; } } }); saveData(); });
    </script>
    
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then(registration => console.log('Service Worker registered successfully:', registration.scope))
            .catch(error => console.log('Service Worker registration failed:', error));
        });
      }
    </script>
</body>
</html>
