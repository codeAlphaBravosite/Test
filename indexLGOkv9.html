<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogReel</title>
    <style>
        :root {
            --primary-color: #4A90E2; /* A more modern blue */
            --primary-color-dark: #357ABD;
            --secondary-color: #50E3C2; /* A contrasting teal/mint */
            --text-color: #333;
            --text-color-light: #555;
            --text-color-very-light: #777;
            --bg-color: #F7F9FA; /* Off-white background */
            --card-bg-color: #FFFFFF;
            --border-color: #E0E0E0;
            --danger-color: #D0021B;
            --warning-color: #F5A623; /* Orange/Yellow for stars and important marks */
            --success-color: #7ED321;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --border-radius: 6px;
            --box-shadow: 0 2px 4px rgba(0,0,0,0.05), 0 4px 12px rgba(0,0,0,0.05);
            --box-shadow-light: 0 1px 3px rgba(0,0,0,0.06);
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .screen { display: none; }
        .screen.active { display: block; }

        /* Headers */
        .app-header {
            background-color: var(--card-bg-color);
            color: var(--text-color);
            padding: 18px 20px;
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--box-shadow-light);
        }
        .app-header h1 {
            font-size: 1.75em;
            font-weight: 600;
        }

        .header-with-back {
            display: grid;
            grid-template-columns: auto 1fr auto; /* Col1: button, Col2: title, Col3: spacer */
            align-items: center;
            background-color: var(--card-bg-color);
            color: var(--text-color);
            padding: 15px 20px;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--box-shadow-light);
            position: sticky;
            top: 0;
            z-index: 900;
        }
        .header-with-back .back-button {
            grid-column: 1 / 2;
            background: none;
            border: none;
            color: var(--text-color-light);
            font-size: 1.8em;
            cursor: pointer;
            padding: 5px 15px 5px 5px; /* Increased tap area */
            font-weight: 500;
            line-height: 1;
        }
        .header-with-back .back-button:hover { color: var(--primary-color); }
        .header-with-back h2 {
            grid-column: 2 / 3;
            font-size: 1.4em;
            font-weight: 600;
            margin: 0;
            text-align: center;
        }
        .header-spacer-right {
            grid-column: 3 / 4;
            width: 1px; /* Default, will be set by JS to match back button width */
            visibility: hidden; /* It's just for spacing */
        }


        /* Buttons */
        .button {
            display: inline-flex; /* For aligning icon and text */
            align-items: center;
            justify-content: center;
            padding: 10px 18px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            border: 1px solid transparent;
            border-radius: var(--border-radius);
            transition: all 0.2s ease-in-out;
            white-space: nowrap;
        }
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .button-primary {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .button-primary:hover:not(:disabled) {
            background-color: var(--primary-color-dark);
            border-color: var(--primary-color-dark);
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
        }
        .button-secondary {
            background-color: var(--card-bg-color);
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .button-secondary:hover:not(:disabled) {
            background-color: #f0f6ff; /* Light blue tint */
        }
        .button-danger {
            background-color: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }
        .button-danger:hover:not(:disabled) {
            background-color: #a70216;
            border-color: #a70216;
        }
        .button-subtle {
            background-color: transparent;
            color: var(--text-color-light);
            border-color: var(--border-color);
        }
        .button-subtle:hover:not(:disabled) {
            background-color: #f0f0f0;
            color: var(--text-color);
        }
        .button-full-width { display: flex; width: 100%; margin-bottom: 10px; }
        .button-small { padding: 6px 12px; font-size: 0.85em; }
        .button-icon { margin-right: 8px; font-size: 1.1em; }
        .button .button-icon-only { margin-right: 0; } /* For icon-only buttons like 'important' */


        /* Cards (article is used for semantic cards) */
        article.card, article.video-entry-card, article.log-item {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }
         article.video-entry-card { padding: 0; /* Children manage padding */ }
         article.log-item { padding: 20px; }


        .card-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-color);
        }
        .card-meta {
            font-size: 0.9em;
            color: var(--text-color-light);
            margin-bottom: 15px;
        }
        .card-actions {
            margin-top: 20px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
         article.card .card-actions, article.log-item .card-actions { 
             padding: 0 20px 20px;
             margin-top: 15px;
        }
        
        .card-actions .button { flex-grow: 1; }
        @media (max-width: 480px) {
            .card-actions .button { min-width: 100%; }
        }


        /* Forms */
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9em;
            color: var(--text-color-light);
        }
        .form-group input[type="text"],
        .form-group input[type="search"],
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1em;
            font-family: var(--font-family);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-group input[type="text"]:focus,
        .form-group input[type="search"]:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
            outline: none;
        }
        .form-group textarea { min-height: 100px; resize: vertical; }
        input[type="search"] {
            padding: 12px 15px;
            font-size: 1em;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            width: 100%;
            margin-bottom: 25px;
        }
        input[type="search"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
            outline: none;
        }

        /* Modals */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: var(--card-bg-color); margin: 10% auto; padding: 25px;
            border-radius: var(--border-radius); width: 90%; max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); animation: modalOpen 0.3s ease-out;
        }
        @keyframes modalOpen { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 15px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px;
        }
        .modal-title { font-size: 1.4em; font-weight: 600; }
        .close-button {
            color: var(--text-color-very-light); font-size: 28px; font-weight: normal;
            cursor: pointer; background: none; border: none; padding: 0; line-height: 1;
        }
        .close-button:hover { color: var(--text-color); }

        /* Toast Notifications */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: calc(100% - 40px);
        }
        .toast-message {
            padding: 12px 18px;
            background-color: var(--text-color);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            font-size: 0.9em;
            opacity: 0;
            transform: translateX(110%);
            transition: opacity 0.3s ease, transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .toast-message.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast-message.error { background-color: var(--danger-color); }
        .toast-message.success { background-color: var(--success-color); }
        .toast-message.warning { background-color: var(--warning-color); color: var(--text-color); }


        /* General UI Elements */
        .actions-bar {
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .actions-bar .button { flex: 1; min-width: calc(50% - 10px); }
        @media (max-width: 480px) { .actions-bar .button { min-width: 100%; } }

        .section-title {
            font-size: 1.2em; font-weight: 600; margin-top: 30px;
            margin-bottom: 15px; padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color); color: var(--text-color);
        }
        .empty-state {
            text-align: center; padding: 40px 20px;
            color: var(--text-color-light); border: 2px dashed var(--border-color);
            border-radius: var(--border-radius); margin-top: 20px;
        }
        .empty-state p { font-size: 1.1em; margin-bottom: 15px; }


        /* Screen 2: Project Videos - Layout */
        .video-entry-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            gap: 10px;
        }
        .video-entry-title {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-color);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
            flex-grow: 1;
        }
        .video-card-number {
            font-weight: normal;
            color: var(--text-color-light);
            margin-right: 4px;
        }
        .video-entry-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        .video-entry-actions .button { margin-left: 0; }
        .btn-toggle-important .button-icon { font-size: 1.3em; margin-right: 0; }
        .btn-toggle-important.is-important .button-icon { color: var(--warning-color); }

        /* Consolidated Player Area on Card - Screen 2 */
        .main-video-preview-area {
            padding: 0; 
            background-color: #000; 
            border-bottom: 1px solid var(--border-color);
            position: relative;
            min-height: 150px; 
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; 
        }
        .main-video-thumbnail {
            width: 100%; 
            height: auto;
            max-height: 300px; 
            object-fit: contain; 
            cursor: pointer;
            display: block; 
        }
         .main-video-thumbnail.hidden { display: none; }

        .play-main-video-preview-btn { 
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em; 
            background: rgba(0,0,0,0.4);
            color: white;
            border-radius: 50%;
            width: 70px; 
            height: 70px;
            padding: 0;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            z-index: 10; 
        }
        .play-main-video-preview-btn:hover { background: rgba(0,0,0,0.6); }
        .play-main-video-preview-btn.hidden { display: none; }

        .main-video-preview-player { 
            width: 100%;
            display: block;
            max-height: 300px; 
            background-color: #000;
        }
        .main-video-preview-player.hidden { display: none; }

        /* Custom Controls for Main Player */
        .main-player-custom-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 6px; 
            padding: 6px 10px; 
            background-color: rgba(0,0,0,0.75); 
            color: white;
            z-index: 20; 
            transition: opacity 0.3s ease; 
        }
        .main-player-custom-controls.hidden { display: none; }
        
        .main-player-ctrl-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.1em; 
            padding: 6px; 
            cursor: pointer;
            line-height: 1;
        }
        .main-player-ctrl-btn:hover { color: var(--secondary-color); }
        .main-player-progress-bar-container {
            flex-grow: 1;
            height: 8px;
            background-color: rgba(255,255,255,0.3);
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
            position: relative; 
        }
        .main-player-progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 4px;
            width: 0%;
        }
        .main-player-timecode {
            font-size: 0.8em;
            color: white;
            font-family: monospace;
            min-width: 85px; 
            text-align: right;
            padding-left: 5px;
        }

        .main-video-preview-prompt { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background-color: rgba(0,0,0,0.85); color: white; padding: 20px; text-align: center;
            z-index: 30; 
        }
        .main-video-preview-prompt.hidden { display: none; }
        .main-video-preview-prompt p { margin-bottom: 15px; font-size: 0.95em; line-height: 1.4; }


        /* Scrollable Logged Clips List - Screen 2 */
        .video-clips-list-container {
            padding: 15px 20px;
            max-height: 190px; /* Approx 1.5 items + header. */
            overflow-y: auto;
            position: relative; 
        }
        .video-clips-list-container h4 { /* Sticky header for clips list */
            font-size: 1em; font-weight: 500; color: var(--text-color-light);
            margin-bottom: 15px;
            position: sticky; top: -1px; /* -1px to ensure border is visible if container has padding */
            background-color: var(--card-bg-color); 
            z-index: 1; 
            padding-top: 5px; 
            padding-bottom: 10px; 
            border-bottom: 1px solid var(--border-color); 
        }
        .clip-item-card {
            display: flex;
            gap: 15px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 12px;
            background-color: #fdfdfd;
            align-items: center;
        }
        .clip-item-card:last-child { margin-bottom: 0; }
        .clip-item-thumbnail {
            width: 80px; height: 50px;
            background-color: var(--border-color); object-fit: cover;
            border-radius: 4px; flex-shrink: 0;
        }
        .clip-item-info { flex-grow: 1; min-width:0; }
        .clip-item-info .notes { font-size: 0.95em; margin-bottom: 4px; font-weight: 500; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .clip-item-info .time, .clip-item-info .keywords, .clip-item-info .rating {
            font-size: 0.8em; color: var(--text-color-very-light); margin-bottom: 2px;
        }
        .clip-item-actions { display: flex; flex-direction: column; gap: 5px; align-items: flex-end; flex-shrink:0; }
        .clip-item-actions .button-small { padding: 5px 8px; font-size: 0.8em; }

        /* Screen 3: Video Logging */
        #video-player-container {
            width: 100%; background-color: black; margin-bottom: 15px;
            position: relative; border-radius: var(--border-radius); overflow:hidden;
        }
        #video-player { width: 100%; display: block; max-height: 50vh;}
        #video-file-prompt {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.85); color: white; padding: 25px; text-align: center;
            border-radius: var(--border-radius); z-index:10;
        }
        #video-file-prompt p { margin-bottom: 15px; line-height: 1.4; font-size: 0.95em;}
        #video-file-prompt strong { color: var(--secondary-color); }
        
        .video-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 12px 15px;
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }
        .video-controls .main-controls { display: flex; align-items: center; gap: 10px; }
        .video-controls .button .button-icon { font-size: 1.2em; margin-right: 0; display: inline-flex; align-items: center; justify-content: center; }
        .video-controls .timecode-display { font-family: monospace; font-size: 0.9em; color: var(--text-color-light); text-align: center; flex-grow: 1; min-width: 130px; }
        .video-controls .speed-control-group { display: flex; align-items: center; }
        .video-controls .speed-control-group select { min-width: 70px; }
        
        #timeline-container {
            width: 100%; height: 8px; background-color: #ddd; cursor: pointer;
            border-radius: 4px; margin-bottom: 8px; overflow: hidden;
            touch-action: pan-y;
        }
        #timeline-progress { height: 100%; background-color: var(--primary-color); border-radius: 4px; }
        .mark-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
        .mark-buttons .button { flex-grow: 1; }
        
        .star-rating { display: flex; gap: 6px; cursor: pointer; margin-bottom: 10px; }
        .star-rating .star { background: none; border: none; padding: 0; font-size: 2em; color: var(--border-color); line-height: 1; cursor: pointer; }
        .star-rating .star.selected, .star-rating .star:hover, .star-rating .star:focus { color: var(--warning-color); outline: none; }
        .star-rating .star:focus-visible { outline: 2px solid var(--primary-color); outline-offset: 2px; }
        
        .log-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .log-item-time { font-weight: 600; font-size: 0.95em; }
        .log-item-notes { margin-bottom: 8px; font-size:0.95em; color: var(--text-color-light); }
        .log-item-keywords { font-style: italic; font-size: 0.85em; color: var(--text-color-very-light); margin-bottom: 8px; }
        .log-item-rating .star { font-size: 0.8em; }
        .log-item img { max-width:100px; max-height:60px; border-radius:4px; margin-top:8px; border:1px solid var(--border-color); }

        /* File input styling */
        .file-input-label {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 10px 18px; font-size: 0.95em; font-weight: 500;
            cursor: pointer; text-align: center; text-decoration: none;
            border: 1px solid var(--primary-color); border-radius: var(--border-radius);
            background-color: var(--primary-color); color: white;
            transition: all 0.2s ease-in-out;
        }
        .file-input-label:hover { background-color: var(--primary-color-dark); border-color: var(--primary-color-dark); }
        input[type="file"] { display: none; }
        
        .hidden { display: none !important; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }

        .mt-1 { margin-top: 10px; }
        .mb-1 { margin-bottom: 10px; }

        @media (max-width: 600px) {
            .container { padding: 15px; }
            .app-header h1 { font-size: 1.5em; }
            .header-with-back h2 { font-size: 1.2em; }
            .header-with-back .back-button { font-size: 1.6em; padding: 5px 10px 5px 0px;}
            .header-spacer-right { min-width: 30px; }

            .video-controls { flex-direction: column; align-items: stretch; }
            .video-controls .main-controls { justify-content: center; width: 100%; margin-bottom: 10px; }
            .video-controls .timecode-display { margin-bottom: 10px; min-width: unset; }
            .video-controls .speed-control-group { justify-content: center; width: 100%; }
            .video-controls .speed-control-group select { width: 100%; }

            .mark-buttons { flex-direction: column; }
            .video-entry-header { 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 12px; /* Increased gap */
            }
            .video-entry-title { font-size: 1.05em; }
            .video-entry-actions { 
                width: 100%; 
                display: flex; 
                justify-content: space-between; /* Space out buttons more */
                gap: 10px; /* Gap between buttons */
            }
            .video-entry-actions .button { flex-grow: 1; margin-left: 0 !important; } /* Allow buttons to grow */
            
            .clip-item-card { 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 10px; /* Gap between thumbnail, info, actions */
            }
            .clip-item-thumbnail { 
                width: 100%; 
                height: auto; 
                max-height: 150px; 
                margin-bottom:10px; /* Maintained for separation */
            }
            .clip-item-info .notes { margin-bottom: 6px; } 
            .clip-item-info .time, .clip-item-info .rating, .clip-item-info .keywords {
                margin-bottom: 4px; 
            }
            .clip-item-actions { 
                width: 100%; 
                flex-direction: row; 
                justify-content: space-between; 
                margin-top: 10px; 
                gap: 8px; /* Gap between action buttons */
            }
            .clip-item-actions .button-small { flex-grow: 1; }
            /* No need for .clip-item-actions .button-small + .button-small if using gap */

            /* Responsive main player custom controls */
            .main-player-custom-controls { 
                flex-wrap: wrap; 
                justify-content: center; 
                padding: 8px 10px; /* Increased padding */
                gap: 8px; /* Increased gap between button groups */
            }
            .main-player-progress-bar-container { 
                order: 1; 
                width: 100%; 
                margin: 10px 0 8px; /* More vertical margin */
            }
            .main-player-timecode { 
                order: 2; 
                margin-left: auto; 
                font-size: 0.8em; /* Slightly larger */
            }
            .main-player-ctrl-btn { 
                font-size: 1.1em; /* Ensure icons are large enough */
                padding: 6px 8px; /* More tap area */
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Screen 1: Projects List -->
        <div id="screen-projects" class="screen">
            <header class="app-header">
                <h1>LogReel</h1>
            </header>
            <div class="container">
                <div class="actions-bar">
                    <button id="btn-new-project" class="button button-primary">
                        <span class="button-icon">&#43;</span> New Project
                    </button>
                    <label class="button button-secondary">
                        <span class="button-icon">&#x1F4E5;</span> Import Projects
                        <input type="file" id="import-projects-input" accept=".json">
                    </label>
                </div>
                <div id="projects-list" aria-live="polite" aria-atomic="true">
                    <!-- Project cards will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Screen 2: Project Videos (NEW LAYOUT) -->
        <div id="screen-project-videos" class="screen">
            <header class="header-with-back">
                <button id="btn-back-to-projects" class="back-button" aria-label="Back to projects list">&#x2190;</button>
                <h2 id="project-name-header">Project Name</h2>
                <div class="header-spacer-right" id="project-videos-header-spacer"></div>
            </header>
            <div class="container">
                <div class="actions-bar">
                    <label class="button button-primary">
                         <span class="button-icon">&#43;</span> Add Videos
                        <input type="file" id="add-videos-input" multiple accept="video/*">
                    </label>
                    <button id="btn-export-project" class="button button-secondary">
                        <span class="button-icon">&#x1F4E4;</span> Export Project
                    </button>
                </div>
                <input type="search" id="project-videos-search" placeholder="Search videos or clips by name, notes, tags..." aria-label="Search videos and clips">
                
                <div id="project-videos-container" aria-live="polite" aria-atomic="true">
                    <!-- Video Entry Cards will be rendered here with new structure -->
                </div>
            </div>
        </div>

        <!-- Screen 3: Video Logging -->
        <div id="screen-video-logging" class="screen">
            <header class="header-with-back">
                <button id="btn-back-to-project-videos" class="back-button" aria-label="Back to project videos">&#x2190;</button>
                <h2 id="video-filename-header">Video Filename</h2>
                <div class="header-spacer-right" id="video-logging-header-spacer"></div>
            </header>
            <div class="container">
                <div id="video-player-container">
                    <video id="video-player" playsinline></video>
                     <div id="video-file-prompt" class="hidden"> 
                        <p id="video-file-prompt-message">Please select the video file.</p>
                        <label class="button button-primary mt-1">
                            Select Video File
                            <input type="file" id="video-file-input-logging" accept="video/*">
                        </label>
                    </div>
                </div>

                <div id="timeline-container" class="mb-1" aria-label="Video timeline"><div id="timeline-progress"></div></div>
                
                <div class="video-controls">
                    <div class="main-controls">
                        <button id="rewind-btn" class="button button-subtle" aria-label="Rewind 5 seconds">
                            <span class="button-icon">&#x23EA;</span>
                        </button>
                        <button id="play-pause-btn" class="button button-subtle" aria-label="Play or Pause video">
                            <span class="button-icon">&#9658;</span>
                        </button>
                        <button id="forward-btn" class="button button-subtle" aria-label="Forward 5 seconds">
                            <span class="button-icon">&#x23E9;</span>
                        </button>
                    </div>
                    <div id="timecode-display" class="timecode-display" aria-live="off">00:00 / 00:00</div>
                    <div class="speed-control-group">
                        <label for="speed-select" class="sr-only">Playback Speed:</label>
                        <select id="speed-select" class="button button-subtle" aria-label="Playback speed">
                            <option value="0.5">0.5x</option>
                            <option value="0.75">0.75x</option>
                            <option value="1" selected>1x</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2">2x</option>
                            <option value="2.5">2.5x</option>
                            <option value="3">3x</option>
                        </select>
                    </div>
                </div>

                <div class="mark-buttons">
                    <button id="mark-in-btn" class="button button-secondary">Mark In (00:00.0)</button>
                    <button id="mark-out-btn" class="button button-secondary">Mark Out (00:00.0)</button>
                </div>

                <article class="card">
                    <div style="padding: 20px 20px 0;">
                        <h3 class="card-title">Log Entry</h3>
                        <div class="form-group">
                            <label for="log-notes">Notes:</label>
                            <textarea id="log-notes"></textarea>
                        </div>
                        <div class="form-group">
                            <label id="rating-label">Rating:</label>
                            <div id="log-rating" class="star-rating" role="group" aria-labelledby="rating-label">
                                <button type="button" class="star" data-value="1" aria-label="Rate 1 star" aria-pressed="false">&#9733;</button>
                                <button type="button" class="star" data-value="2" aria-label="Rate 2 stars" aria-pressed="false">&#9733;</button>
                                <button type="button" class="star" data-value="3" aria-label="Rate 3 stars" aria-pressed="false">&#9733;</button>
                                <button type="button" class="star" data-value="4" aria-label="Rate 4 stars" aria-pressed="false">&#9733;</button>
                                <button type="button" class="star" data-value="5" aria-label="Rate 5 stars" aria-pressed="false">&#9733;</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="log-keywords">Keywords (comma-separated):</label>
                            <input type="text" id="log-keywords">
                        </div>
                    </div>
                    <div class="card-actions" style="padding-top:0;">
                         <button id="save-log-btn" class="button button-primary button-full-width">Save Log</button>
                    </div>
                    <input type="hidden" id="editing-log-id"> 
                </article>

                <h3 class="section-title mt-2">Saved Logs for this Video</h3>
                <div id="saved-logs-list" aria-live="polite" aria-atomic="true">
                    <!-- Saved logs will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="modal-new-project" class="modal" role="dialog" aria-labelledby="modal-new-project-title" aria-modal="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="modal-new-project-title">Create New Project</h3>
                    <button class="close-button" data-modal-id="modal-new-project" aria-label="Close new project dialog">&times;</button>
                </div>
                <div class="form-group">
                    <label for="new-project-name">Project Name:</label>
                    <input type="text" id="new-project-name">
                </div>
                <button id="btn-create-project-confirm" class="button button-primary button-full-width">Create Project</button>
            </div>
        </div>

        <div id="modal-confirm-action" class="modal" role="dialog" aria-labelledby="modal-confirm-action-title" aria-modal="true">
            <div class="modal-content">
                 <div class="modal-header">
                    <h3 class="modal-title" id="modal-confirm-action-title">Confirm Action</h3>
                    <button class="close-button" data-modal-id="modal-confirm-action" aria-label="Close confirmation dialog">&times;</button>
                </div>
                <p id="confirm-action-message" style="margin-bottom: 20px; font-size: 1.05em;">Are you sure?</p>
                <div class="card-actions" style="margin-top:0;">
                    <button id="btn-confirm-action-cancel" class="button button-subtle">Cancel</button>
                    <button id="btn-confirm-action-confirm" class="button button-danger">Confirm</button>
                </div>
            </div>
        </div>

        <canvas id="thumbnail-canvas" style="display:none;"></canvas>
        <div id="toast-container" aria-live="assertive" aria-atomic="true"></div>
    </div>

    <script>
    const app = {
        data: {
            projects: [],
            currentProjectId: null,
            currentVideoId: null, 
            videoElement: null, // Screen 3 main video player
            timelineProgress: null,
            timelineContainer: null,
            playPauseBtn: null, // Screen 3
            rewindBtn: null, // Screen 3
            forwardBtn: null, // Screen 3
            timecodeDisplay: null, // Screen 3
            speedSelect: null, // Screen 3
            markInBtn: null,
            markOutBtn: null,
            markInTime: 0,
            markOutTime: null,
            currentRating: 0,
            videoFileCache: {}, 
            
            activeCardPlayer: {
                videoId: null, cardElement: null, playerElement: null, thumbnailElement: null,
                bigPlayButtonElement: null, promptElement: null, fileInputElement: null,
                controlsContainerElement: null, playPauseBtnElement: null, rewindBtnElement: null,
                forwardBtnElement: null, progressBarContainerElement: null, progressBarElement: null,
                timecodeElement: null, stopBtnElement: null, isPlaying: false, isScrubbing: false,
                wasPlayingBeforeScrub: false, currentSegment: { startTime: 0, endTime: 0, duration: 0 },
                boundPlayerTimeUpdate: null, boundPlayerLoadedMetadata: null, boundPlayerEnded: null,
                boundPlayerError: null, boundPlayerPlay: null, boundPlayerPause: null,
                _boundCardPlayerScrubMove: null, _boundCardPlayerScrubEnd: null
            },
            previouslyFocusedElement: null,
            skipTimeSeconds: 5, 
            isScrubbing: false, 
            wasPlayingBeforeScrub: false, 
        },
        dom: {}, 
        idb: {
            db: null,
            dbName: 'LogReelFilesDB',
            storeName: 'videoFiles',
            version: 1,

            initDB() {
                return new Promise((resolve, reject) => {
                    if (app.idb.db) {
                        resolve(app.idb.db);
                        return;
                    }
                    if (!window.indexedDB) {
                        console.warn("IndexedDB not supported by this browser.");
                        reject("IndexedDB not supported");
                        return;
                    }
                    const request = indexedDB.open(app.idb.dbName, app.idb.version);
                    request.onerror = (event) => {
                        console.error("IndexedDB error:", event.target.error);
                        reject("IndexedDB error: " + event.target.error);
                    };
                    request.onsuccess = (event) => {
                        app.idb.db = event.target.result;
                        resolve(app.idb.db);
                    };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(app.idb.storeName)) {
                            db.createObjectStore(app.idb.storeName, { keyPath: 'videoId' });
                        }
                    };
                });
            },
            storeFile(videoId, file) {
                return new Promise(async (resolve, reject) => {
                    try {
                        if (!app.idb.db) await app.idb.initDB();
                        if (!app.idb.db) { reject("IndexedDB not available for storing file."); return; }
                        const transaction = app.idb.db.transaction([app.idb.storeName], 'readwrite');
                        const store = transaction.objectStore(app.idb.storeName);
                        const request = store.put({ videoId: videoId, file: file });
                        request.onsuccess = () => resolve();
                        request.onerror = (event) => reject(event.target.error);
                    } catch (error) { reject(error); }
                });
            },
            retrieveFile(videoId) {
                return new Promise(async (resolve, reject) => {
                    try {
                        if (!app.idb.db) await app.idb.initDB();
                        if (!app.idb.db) { reject("IndexedDB not available for retrieving file."); return;}
                        const transaction = app.idb.db.transaction([app.idb.storeName], 'readonly');
                        const store = transaction.objectStore(app.idb.storeName);
                        const request = store.get(videoId);
                        request.onsuccess = (event) => resolve(event.target.result ? event.target.result.file : null);
                        request.onerror = (event) => reject(event.target.error);
                    } catch (error) { reject(error); }
                });
            },
            deleteFile(videoId) {
                return new Promise(async (resolve, reject) => {
                    try {
                        if (!app.idb.db) await app.idb.initDB();
                        if (!app.idb.db) { reject("IndexedDB not available for deleting file."); return; }
                        const transaction = app.idb.db.transaction([app.idb.storeName], 'readwrite');
                        const store = transaction.objectStore(app.idb.storeName);
                        const request = store.delete(videoId);
                        request.onsuccess = () => resolve();
                        request.onerror = (event) => reject(event.target.error);
                    } catch (error) { reject(error); }
                });
            }
        },
        utils: {
            generateId() { 
                return Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
            },
            formatTime(seconds, includeMillis = false) { 
                if (isNaN(seconds) || seconds < 0) return includeMillis ? '00:00.0' : '00:00';
                const h = Math.floor(seconds / 3600); const m = Math.floor((seconds % 3600) / 60);
                const s = Math.floor(seconds % 60); const ms = Math.floor((seconds - Math.floor(seconds)) * 10); 
                let timeStr = ''; if (h > 0) timeStr += `${String(h).padStart(2, '0')}:`;
                timeStr += `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                if (includeMillis) timeStr += `.${ms}`; return timeStr;
            },
            escapeHtml(unsafe) { 
                if (typeof unsafe !== 'string') return String(unsafe);
                return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            }
        },

        init() {
            this.cacheDomElements();
            this.boundHandleTimelineMouseMove = this.handleTimelineMouseMove.bind(this);
            this.boundHandleTimelineMouseUp = this.handleTimelineMouseUp.bind(this);
            this.boundHandleTimelineTouchMove = this.handleTimelineTouchMove.bind(this);
            this.boundHandleTimelineTouchEnd = this.handleTimelineTouchEnd.bind(this);
            
            this.idb.initDB().catch(error => {
                console.warn("Failed to initialize IndexedDB.", error);
                this.showToast("Persistent file storage unavailable.", "warning", 7000);
            });
            this.loadData();
            this.registerEventListeners();
            this.adjustHeaderSpacers();
            this.navigateTo('screen-projects');
            console.log("LogReel App Initialized");
        },

        adjustHeaderSpacers() {
            const adjust = (btnId, spacerId) => {
                const btn = document.getElementById(btnId), spacer = document.getElementById(spacerId);
                if (btn && spacer) spacer.style.width = `${btn.offsetWidth}px`;
            };
            adjust('btn-back-to-projects', 'project-videos-header-spacer');
            adjust('btn-back-to-project-videos', 'video-logging-header-spacer');
        },

        cacheDomElements() {
            this.dom.screens = {'projects':document.getElementById('screen-projects'), 'project-videos':document.getElementById('screen-project-videos'), 'video-logging':document.getElementById('screen-video-logging')};
            this.dom.modals = {newProject:document.getElementById('modal-new-project'), confirmAction:document.getElementById('modal-confirm-action')};
            this.dom.toastContainer = document.getElementById('toast-container');
            this.dom.projectsList = document.getElementById('projects-list');
            this.dom.btnNewProject = document.getElementById('btn-new-project');
            this.dom.importProjectsInput = document.getElementById('import-projects-input');
            this.dom.btnBackToProjects = document.getElementById('btn-back-to-projects');
            this.dom.projectNameHeader = document.getElementById('project-name-header');
            this.dom.projectVideosHeaderSpacer = document.getElementById('project-videos-header-spacer');
            this.dom.addVideosInput = document.getElementById('add-videos-input');
            this.dom.btnExportProject = document.getElementById('btn-export-project');
            this.dom.projectVideosSearch = document.getElementById('project-videos-search');
            this.dom.projectVideosContainer = document.getElementById('project-videos-container');
            this.dom.btnBackToProjectVideos = document.getElementById('btn-back-to-project-videos');
            this.dom.videoFilenameHeader = document.getElementById('video-filename-header');
            this.dom.videoLoggingHeaderSpacer = document.getElementById('video-logging-header-spacer');
            this.data.videoElement = document.getElementById('video-player');
            this.dom.videoPlayerContainer = document.getElementById('video-player-container'); 
            this.dom.videoFilePrompt = document.getElementById('video-file-prompt');
            this.dom.videoFilePromptMessage = document.getElementById('video-file-prompt-message');
            this.dom.videoFileInputLogging = document.getElementById('video-file-input-logging');
            this.data.timelineContainer = document.getElementById('timeline-container');
            this.data.timelineProgress = document.getElementById('timeline-progress');
            this.data.rewindBtn = document.getElementById('rewind-btn');
            this.data.playPauseBtn = document.getElementById('play-pause-btn');
            this.data.forwardBtn = document.getElementById('forward-btn');
            this.data.timecodeDisplay = document.getElementById('timecode-display');
            this.data.speedSelect = document.getElementById('speed-select');
            this.data.markInBtn = document.getElementById('mark-in-btn');
            this.data.markOutBtn = document.getElementById('mark-out-btn');
            this.dom.logNotes = document.getElementById('log-notes');
            this.dom.logRatingContainer = document.getElementById('log-rating');
            this.dom.logKeywords = document.getElementById('log-keywords');
            this.dom.saveLogBtn = document.getElementById('save-log-btn');
            this.dom.editingLogIdInput = document.getElementById('editing-log-id');
            this.dom.savedLogsList = document.getElementById('saved-logs-list');
            this.dom.thumbnailCanvas = document.getElementById('thumbnail-canvas');
            this.dom.newProjectNameInput = document.getElementById('new-project-name');
            this.dom.btnCreateProjectConfirm = document.getElementById('btn-create-project-confirm');
            this.dom.confirmActionMessage = document.getElementById('confirm-action-message');
            this.dom.btnConfirmActionCancel = document.getElementById('btn-confirm-action-cancel');
            this.dom.btnConfirmActionConfirm = document.getElementById('btn-confirm-action-confirm');
        },

        navigateTo(screenId, params = {}) {
            const targetScreenKey = screenId.replace('screen-', '');
            Object.values(this.dom.screens).forEach(s => s?.classList.remove('active'));
            if (this.dom.screens[targetScreenKey]) {
                this.dom.screens[targetScreenKey].classList.add('active');
            } else {
                console.error(`Screen key "${targetScreenKey}" not found.`);
                this.dom.screens['projects']?.classList.add('active');
                screenId = 'screen-projects';
            }
            this.currentScreen = screenId;
            window.scrollTo(0, 0);

            if (this.data.activeCardPlayer.playerElement && screenId !== 'screen-project-videos') {
                this.resetActiveCardPlayerUI(false); 
            }
            if (this.data.videoElement) { 
                if (screenId !== 'screen-video-logging') this.data.videoElement.pause();
                this.data.videoElement.removeAttribute('controls'); // Always custom controls or none
            }

            switch (screenId) {
                case 'screen-projects': this.renderProjectsScreen(); break;
                case 'screen-project-videos':
                    this.data.currentProjectId = params?.projectId || this.data.currentProjectId || this.data.projects[0]?.id;
                    if (!this.data.currentProjectId) { this.navigateTo('screen-projects'); return; }
                    this.renderProjectVideosScreen();
                    break;
                case 'screen-video-logging':
                    if (params?.videoId && params?.projectId) {
                        this.data.currentProjectId = params.projectId;
                        this.data.currentVideoId = params.videoId;
                    } else if (!this.data.currentProjectId || !this.data.currentVideoId) {
                        const projId = this.data.currentProjectId || this.data.projects[0]?.id;
                        this.navigateTo(projId ? 'screen-project-videos' : 'screen-projects', { projectId: projId });
                        return;
                    }
                    this.renderVideoLoggingScreen(); 
                    if(params?.logIdToEdit) this.editLogEntry(params.logIdToEdit, true);
                    break;
            }
        },

        loadData() { 
            const stored = localStorage.getItem('logReelData');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    if (Array.isArray(parsed)) {
                        this.data.projects = parsed.map(p => ({
                            ...p,
                            videos: (p.videos || []).map(v => ({
                                ...v,
                                isImportant: v.isImportant ?? false,
                                mainVideoThumbnail: v.mainVideoThumbnail ?? null
                            }))
                        }));
                    } else { this.data.projects = []; }
                } catch (e) {
                    console.error("Error parsing localStorage data:", e);
                    this.data.projects = [];
                }
            } else { this.data.projects = []; }
        },
        saveData() { 
            try {
                localStorage.setItem('logReelData', JSON.stringify(this.data.projects));
            } catch (e) {
                console.error("Error saving to localStorage:", e);
                this.showToast("Could not save data.", "error");
            }
        },
        getProjectById(id) { return this.data.projects.find(p => p.id === id); },
        getVideoById(pId, vId) { return this.getProjectById(pId)?.videos.find(v => v.id === vId); },
        getLogById(pId, vId, lId) { return this.getVideoById(pId, vId)?.logs.find(l => l.id === lId); },

        registerEventListeners() {
            this.dom.btnNewProject.addEventListener('click', () => this.showNewProjectModal());
            this.dom.importProjectsInput.addEventListener('change', (e) => this.importProjects(e));
            this.dom.btnBackToProjects.addEventListener('click', () => this.navigateTo('screen-projects'));
            this.dom.addVideosInput.addEventListener('change', (e) => this.handleAddVideos(e.target.files)); 
            this.dom.btnExportProject.addEventListener('click', () => this.exportCurrentProject());
            this.dom.projectVideosSearch.addEventListener('input', (e) => this.renderProjectVideosScreen(e.target.value.trim()));
            this.dom.btnBackToProjectVideos.addEventListener('click', () => this.navigateTo('screen-project-videos', { projectId: this.data.currentProjectId }));
            
            if(this.data.videoElement) {
                const s3player = this.data.videoElement;
                this.data.rewindBtn.addEventListener('click', () => this.rewindVideo());
                this.data.playPauseBtn.addEventListener('click', () => this.togglePlayPause());
                this.data.forwardBtn.addEventListener('click', () => this.fastForwardVideo());
                s3player.addEventListener('play', () => { if(this.data.playPauseBtn && this.currentScreen === 'screen-video-logging') { this.data.playPauseBtn.innerHTML = '<span class="button-icon">&#10074;&#10074;</span>'; this.data.playPauseBtn.setAttribute('aria-label', 'Pause video'); }});
                s3player.addEventListener('pause', () => { if(this.data.playPauseBtn && this.currentScreen === 'screen-video-logging') { this.data.playPauseBtn.innerHTML = '<span class="button-icon">&#9658;</span>'; this.data.playPauseBtn.setAttribute('aria-label', 'Play video'); }});
                ['loadedmetadata', 'timeupdate', 'durationchange'].forEach(evt => s3player.addEventListener(evt, () => { if(this.currentScreen === 'screen-video-logging') this.updateVideoTimes(); }));
                s3player.addEventListener('error', async (e) => { 
                    if(this.currentScreen !== 'screen-video-logging') return;
                    const vData = this.getVideoById(this.data.currentProjectId, this.data.currentVideoId);
                    this.showToast(`Error playing ${vData ? this.utils.escapeHtml(vData.filename) : 'video'}.`, 'error', 5000);
                    if (vData) { 
                        const key = `${this.data.currentProjectId}-${this.data.currentVideoId}`;
                        if(this.data.videoFileCache[key]) { URL.revokeObjectURL(this.data.videoFileCache[key]); delete this.data.videoFileCache[key]; }
                        this.promptForVideoFile(vData.filename);
                    }
                });
                this.data.timelineContainer.addEventListener('mousedown', (e) => this.handleTimelineMouseDown(e));
                this.data.timelineContainer.addEventListener('touchstart', (e) => this.handleTimelineTouchStart(e), { passive: false });
                this.data.speedSelect.addEventListener('change', (e) => { if(s3player) s3player.playbackRate = parseFloat(e.target.value); });
            }
            this.data.markInBtn.addEventListener('click', () => this.setMarkIn());
            this.data.markOutBtn.addEventListener('click', () => this.setMarkOut());
            this.dom.logRatingContainer.addEventListener('click', (e) => this.handleStarRating(e));
            this.dom.saveLogBtn.addEventListener('click', () => this.saveLogEntry()); 
            this.dom.videoFileInputLogging.addEventListener('change', (e) => this.handleVideoFileSelectionForLogging(e.target.files[0])); 
            
            document.querySelectorAll('.close-button').forEach(btn => btn.addEventListener('click', () => this.hideModal(btn.dataset.modalId)));
            this.dom.btnCreateProjectConfirm.addEventListener('click', () => this.createNewProject());
            this.dom.btnConfirmActionCancel.addEventListener('click', () => this.hideModal('modal-confirm-action')); 
            window.addEventListener('keydown', (e) => { if (e.key === 'Escape') Object.values(this.dom.modals).forEach(m => { if (m.style.display === 'block') this.hideModal(m.id); }); });

            this.dom.projectVideosContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('button'), card = btn?.closest('article.video-entry-card'), vId = card?.dataset.videoId;
                if (!btn || !card || !vId) return;

                const actionHandlers = {
                    'btn-log-full-video': () => this.navigateTo('screen-video-logging', { projectId: this.data.currentProjectId, videoId: vId }),
                    'btn-delete-this-video': () => this.confirmDeleteVideo(vId),
                    'btn-toggle-important': () => this.toggleVideoImportance(vId),
                    'btn-play-clip-on-card': () => {
                        const lId = btn.dataset.logId, log = this.getLogById(this.data.currentProjectId, vId, lId);
                        if (log) this.playVideoOnCard(vId, card, { startTime: log.markIn, endTime: log.markOut });
                    },
                    'btn-edit-this-clip': () => this.navigateTo('screen-video-logging', { projectId: this.data.currentProjectId, videoId: vId, logIdToEdit: btn.dataset.logId }),
                    'btn-delete-this-log-item': () => this.confirmDeleteLogItemFromScreen2(vId, btn.dataset.logId),
                    'play-main-video-preview-btn': () => this.playVideoOnCard(vId, card),
                    'main-player-play-pause-btn': () => this.toggleCardPlayerPlayPause(),
                    'main-player-rewind-btn': () => this.rewindCardPlayer(),
                    'main-player-forward-btn': () => this.forwardCardPlayer(),
                    'main-player-stop-btn': () => this.stopAndResetCardPlayer(),
                };
                for (const cls in actionHandlers) { if (btn.classList.contains(cls)) { actionHandlers[cls](); return; }}
            });
            ['mousedown', 'touchstart'].forEach(evtType => {
                this.dom.projectVideosContainer.addEventListener(evtType, (e) => {
                    if (e.target.closest('.main-player-progress-bar-container')) {
                        if (evtType === 'mousedown') this.handleCardPlayerProgressBarMouseDown(e);
                        else this.handleCardPlayerProgressBarTouchStart(e);
                    }
                }, evtType === 'touchstart' ? { passive: false } : {});
            });
            this.dom.projectVideosContainer.addEventListener('change', (e) => {
                if (e.target.classList.contains('main-video-preview-file-input')) {
                    const vId = e.target.dataset.targetPlayerId; 
                    if (this.data.activeCardPlayer.videoId === vId) this.handleCardPlayerFileSelection(e.target.files[0], vId);
                }
            });
        },
        
        async getVideoSource(projectId, videoId, videoFilename) {
            const cacheKey = `${projectId}-${videoId}`;
            if (this.data.videoFileCache[cacheKey]) {
                try {
                    const res = await fetch(this.data.videoFileCache[cacheKey]); 
                    if (res.ok) return this.data.videoFileCache[cacheKey];
                    URL.revokeObjectURL(this.data.videoFileCache[cacheKey]); delete this.data.videoFileCache[cacheKey];
                } catch (e) { 
                    if(this.data.videoFileCache[cacheKey]) URL.revokeObjectURL(this.data.videoFileCache[cacheKey]);
                    delete this.data.videoFileCache[cacheKey];
                }
            }
            try {
                const fileFromDB = await this.idb.retrieveFile(videoId);
                if (fileFromDB && fileFromDB.name === videoFilename) {
                    const objURL = URL.createObjectURL(fileFromDB);
                    this.data.videoFileCache[cacheKey] = objURL; return objURL;
                }
            } catch (error) { console.error("IDB retrieve error for", videoFilename, error); }
            return null;
        },

        renderProjectsScreen() {
            if (!this.dom.projectsList) return;
            this.dom.projectsList.innerHTML = '';
            if (!this.data.projects.length) {
                this.dom.projectsList.innerHTML = '<div class="empty-state"><p>No projects yet.</p><p>Create or import projects.</p></div>';
                return;
            }
            const frag = document.createDocumentFragment();
            this.data.projects.forEach(p => {
                const card = document.createElement('article'); card.className = 'card';
                card.innerHTML = `<div style="padding: 20px;"><div class="card-title">${this.utils.escapeHtml(p.name)}</div><div class="card-meta">${p.videos?.length || 0} video(s)</div></div><div class="card-actions"><button class="button button-primary btn-open-project" data-project-id="${p.id}">Open</button><button class="button button-subtle btn-delete-project" data-project-id="${p.id}">Delete</button></div>`;
                frag.appendChild(card);
            });
            this.dom.projectsList.appendChild(frag);
            this.dom.projectsList.querySelectorAll('.btn-open-project').forEach(b => b.addEventListener('click', e => this.navigateTo('screen-project-videos', { projectId: e.currentTarget.dataset.projectId })));
            this.dom.projectsList.querySelectorAll('.btn-delete-project').forEach(b => b.addEventListener('click', e => this.confirmDeleteProject(e.currentTarget.dataset.projectId)));
        },
        showNewProjectModal() { this.dom.newProjectNameInput.value = ''; this.showModal('modal-new-project'); },
        createNewProject() { 
            const name = this.dom.newProjectNameInput.value.trim();
            if (!name) { this.showToast('Project name empty.', 'warning'); return; }
            this.data.projects.unshift({ id: this.utils.generateId(), name, videos: [], createdAt: new Date().toISOString() });
            this.saveData(); this.renderProjectsScreen(); this.hideModal('modal-new-project');
            this.showToast(`Project "${this.utils.escapeHtml(name)}" created.`, 'success');
        },
        confirmDeleteProject(id) { 
            const p = this.getProjectById(id); if (!p) return;
            this.showConfirmationModal(`Delete project "<strong>${this.utils.escapeHtml(p.name)}</strong>"? <br>This removes all video data & files. Undone.`, () => this.deleteProject(id), null, "Delete Project", "button-danger");
        },
        async deleteProject(id){ 
            const p = this.getProjectById(id);
            if (p?.videos) {
                for (const v of p.videos) {
                    const key = `${id}-${v.id}`; 
                    if (this.data.videoFileCache[key]) { URL.revokeObjectURL(this.data.videoFileCache[key]); delete this.data.videoFileCache[key]; }
                    try { await this.idb.deleteFile(v.id); } catch (err) { console.error(`Failed to delete IDB file for video ${v.id}:`, err); }
                }
            }
            this.data.projects = this.data.projects.filter(proj => proj.id !== id);
            if (this.data.currentProjectId === id) { this.data.currentProjectId = null; this.data.currentVideoId = null; }
            this.saveData(); this.renderProjectsScreen();
            if(p) this.showToast(`Project "${this.utils.escapeHtml(p.name)}" deleted.`, 'success');
        },
        importProjects(event) { 
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (Array.isArray(imported) && imported.every(p => p.id && p.name && Array.isArray(p.videos))) {
                            this.showConfirmationModal(
                                "Import replaces <strong>all current projects & data</strong> (excluding stored files from other projects). Undone. Continue?",
                                () => { 
                                    this.data.projects = imported.map(p => ({...p, videos: (p.videos || []).map(v => ({...v, isImportant: v.isImportant ?? false, mainVideoThumbnail: v.mainVideoThumbnail ?? null})) }));
                                    this.saveData(); this.renderProjectsScreen(); 
                                    this.showToast('Projects imported. Video files may need re-selection.', 'success', 5000);
                                }
                            );
                        } else { this.showToast('Invalid project file.', 'error'); }
                    } catch (err) { this.showToast('Error reading project file.', 'error'); }
                };
                reader.readAsText(file); event.target.value = null; 
            }
        },
        exportCurrentProject() { 
            const p = this.getProjectById(this.data.currentProjectId);
            if (!p) { this.showToast("No project to export.", "warning"); return; }
            const exportData = JSON.parse(JSON.stringify(p)); 
            exportData.videos.forEach(v => delete v.fileURL); 
            const dataStr = JSON.stringify([exportData], null, 2); 
            const uri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const name = `${p.name.replace(/\s+/g, '_')}_LogReel.json`;
            const a = document.createElement('a'); a.href = uri; a.download = name; a.click(); a.remove();
            this.showToast(`Project "${this.utils.escapeHtml(p.name)}" export started.`, 'success');
        },
        
        // --- Screen 2 Methods ---
        async renderProjectVideosScreen(searchTerm = '') {
            const project = this.getProjectById(this.data.currentProjectId);
            if (!project) { this.navigateTo('screen-projects'); return; }

            this.dom.projectNameHeader.textContent = this.utils.escapeHtml(project.name);
            this.dom.projectVideosContainer.innerHTML = '';

            if (this.data.activeCardPlayer.playerElement) this.resetActiveCardPlayerUI(false); 

            let videosToDisplay = project.videos || [];
            if (!videosToDisplay.length && !searchTerm) {
                this.dom.projectVideosContainer.innerHTML = '<div class="empty-state" style="margin:20px;"><p>No videos here.</p><p>Click "Add Videos".</p></div>';
                return;
            }
            
            const fragment = document.createDocumentFragment();
            let foundItems = false;
            videosToDisplay.forEach((video, index) => {
                let videoMatches = false;
                let clips = video.logs || [];
                if (searchTerm) {
                    const lcSearch = searchTerm.toLowerCase();
                    if (video.filename.toLowerCase().includes(lcSearch)) videoMatches = true;
                    clips = clips.filter(log => log.notes.toLowerCase().includes(lcSearch) || log.keywords?.some(k => k.toLowerCase().includes(lcSearch)));
                    if (!videoMatches && !clips.length) return;
                }
                foundItems = true;

                const card = document.createElement('article'); card.className = 'video-entry-card'; card.dataset.videoId = video.id;
                let clipsHtml = clips.sort((a,b) => a.markIn - b.markIn).map(log => {
                    const stars = Array(5).fill(0).map((_,i) => `<span class="star ${i<log.rating?'selected':''}" style="font-size:0.8em;color:${i<log.rating?'var(--warning-color)':'var(--border-color)'};">&#9733;</span>`).join('');
                    return `<div class="clip-item-card"><img src="${log.thumbnail||'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=='}" alt="Clip thumbnail" class="clip-item-thumbnail"><div class="clip-item-info"><p class="notes">${this.utils.escapeHtml(log.notes)}</p><p class="time">Time: ${this.utils.formatTime(log.markIn)} - ${this.utils.formatTime(log.markOut)}</p><p class="rating">Rating: ${stars}</p>${log.keywords?.length?`<p class="keywords">Keywords: ${this.utils.escapeHtml(log.keywords.join(', '))}</p>`:''}</div><div class="clip-item-actions"><button class="button button-primary button-small btn-play-clip-on-card" data-log-id="${log.id}"><span class="button-icon">&#9658;</span>Play</button><button class="button button-subtle button-small btn-edit-this-clip" data-log-id="${log.id}">Edit</button><button class="button button-subtle button-small btn-delete-this-log-item" data-log-id="${log.id}">Del</button></div></div>`;
                }).join('');
                if (!clipsHtml && searchTerm && videoMatches) clipsHtml = '<p style="padding:10px 0;text-align:center;color:var(--text-color-light);font-size:0.9em;">No clips match search.</p>';
                else if (!clipsHtml && !searchTerm) clipsHtml = '<p style="padding:10px 0;text-align:center;color:var(--text-color-light);font-size:0.9em;">No clips logged.</p>';

                const thumbSrc = video.mainVideoThumbnail || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 160 90"%3E%3Crect width="160" height="90" fill="%23e0e0e0"/%3E%3Ctext x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="14px" fill="%23777"%3EVideo%3C/text%3E%3C/svg%3E';
                card.innerHTML = `<div class="video-entry-header"><span class="video-entry-title" title="${this.utils.escapeHtml(video.filename)}"><span class="video-card-number">${index+1}. </span>${this.utils.escapeHtml(video.filename)}</span><div class="video-entry-actions"><button class="button button-subtle button-small btn-toggle-important ${video.isImportant?'is-important':''}" title="${video.isImportant?'Unmark':'Mark'} important" aria-pressed="${video.isImportant}"><span class="button-icon button-icon-only">${video.isImportant?'&#9733;':'&#9734;'}</span></button><button class="button button-secondary button-small btn-log-full-video">Log Full Video</button><button class="button button-subtle button-small btn-delete-this-video">Delete Video</button></div></div><div class="main-video-preview-area" id="main-preview-area-${video.id}"><img src="${thumbSrc}" class="main-video-thumbnail" id="main-thumbnail-${video.id}" alt="Preview for ${this.utils.escapeHtml(video.filename)}"><button class="play-main-video-preview-btn" id="play-main-preview-btn-${video.id}">&#9658;</button><video class="main-video-preview-player hidden" id="main-player-${video.id}" playsinline></video><div class="main-player-custom-controls hidden" id="main-player-controls-${video.id}"><button class="main-player-ctrl-btn main-player-rewind-btn">&#x23EA;</button><button class="main-player-ctrl-btn main-player-play-pause-btn">&#9658;</button><button class="main-player-ctrl-btn main-player-forward-btn">&#x23E9;</button><div class="main-player-progress-bar-container"><div class="main-player-progress-bar" id="main-player-progress-${video.id}"></div></div><span class="main-player-timecode" id="main-player-timecode-${video.id}">00:00/00:00</span><button class="main-player-ctrl-btn main-player-stop-btn">&#x25A0;</button></div><div class="main-video-preview-prompt hidden" id="main-player-prompt-${video.id}"><p id="main-player-prompt-msg-${video.id}">Select video file.</p><label class="button button-primary button-small mt-1">Select File<input type="file" class="main-video-preview-file-input" data-target-player-id="${video.id}" accept="video/*"></label></div></div><div class="video-clips-list-container">${clips.length>0||(searchTerm&&videoMatches)?`<h4>Logged Clips (${clips.length})</h4>`:''}${clipsHtml}</div>`;
                fragment.appendChild(card);
            });
            this.dom.projectVideosContainer.appendChild(fragment);
            if (!foundItems && searchTerm) this.dom.projectVideosContainer.innerHTML = `<div class="empty-state" style="margin:20px;"><p>No videos/clips match "<strong>${this.utils.escapeHtml(searchTerm)}</strong>".</p></div>`;
        },

        async handleAddVideos(files) { 
            const p = this.getProjectById(this.data.currentProjectId); if (!p) return;
            if (!p.videos) p.videos = [];
            let count = 0;
            for (let file of files) {
                if (!file.type.startsWith('video/')) { this.showToast(`"${this.utils.escapeHtml(file.name)}" is not a video.`, 'warning'); continue; }
                const vId = this.utils.generateId();
                let thumb = null;
                try { await this.idb.storeFile(vId, file); } catch (err) { this.showToast(`Could not save "${this.utils.escapeHtml(file.name)}" persistently.`, 'warning', 6000); }
                
                const objURL = URL.createObjectURL(file); this.data.videoFileCache[`${this.data.currentProjectId}-${vId}`] = objURL;
                try {
                    const tempVid = document.createElement('video'); tempVid.muted = true; tempVid.src = objURL;
                    thumb = await new Promise(resolve => {
                        const tOut = setTimeout(() => { tempVid.onloadedmetadata=tempVid.onseeked=tempVid.onerror=null; resolve(null); }, 3000);
                        tempVid.onloadedmetadata = () => tempVid.currentTime = Math.min(0.5, tempVid.duration/2);
                        tempVid.onseeked = async () => { clearTimeout(tOut); resolve(await this.generateGenericThumbnail(tempVid).catch(()=>null)); };
                        tempVid.onerror = () => { clearTimeout(tOut); resolve(null); };
                    });
                } catch (e) { thumb = null; }
                p.videos.push({ id:vId, filename:file.name, logs:[], createdAt:new Date().toISOString(), isImportant:false, mainVideoThumbnail:thumb });
                count++;
            }
            if(count > 0) { this.saveData(); this.renderProjectVideosScreen(); this.showToast(`${count} video(s) added.`, 'success'); }
            this.dom.addVideosInput.value = null; 
        },
        async generateGenericThumbnail(vidEl) {
             return new Promise((resolve, reject) => {
                if (!vidEl?.src || vidEl.readyState < vidEl.HAVE_METADATA || !vidEl.videoWidth || !vidEl.videoHeight) return reject("Video not ready.");
                const canvas = this.dom.thumbnailCanvas, ctx = canvas.getContext('2d');
                const ar = vidEl.videoWidth / vidEl.videoHeight;
                canvas.width = 160; canvas.height = canvas.width / ar || 90; 
                try { ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(vidEl,0,0,canvas.width,canvas.height); resolve(canvas.toDataURL('image/jpeg',0.6)); }
                catch (e) { reject("Error creating thumbnail."); }
            });
        },
        confirmDeleteVideo(vId) { 
            const v = this.getVideoById(this.data.currentProjectId, vId); if (!v) return;
            this.showConfirmationModal(`Delete "<strong>${this.utils.escapeHtml(v.filename)}</strong>" & logs? <br>Removes from storage. Undone.`, () => this.deleteVideo(vId), null, "Delete Video", "button-danger");
        },
        async deleteVideo(vId) { 
            const p = this.getProjectById(this.data.currentProjectId); if (!p?.videos) return;
            const vIdx = p.videos.findIndex(vid => vid.id === vId); if (vIdx === -1) return;
            const vToDel = p.videos[vIdx];
            if (this.data.activeCardPlayer.videoId === vId) this.resetActiveCardPlayerUI(false); 

            const key = `${this.data.currentProjectId}-${vId}`;
            if (this.data.videoFileCache[key]) { URL.revokeObjectURL(this.data.videoFileCache[key]); delete this.data.videoFileCache[key]; }
            try { await this.idb.deleteFile(vId); } catch (err) { this.showToast(`Could not remove "${this.utils.escapeHtml(vToDel.filename)}" from storage.`, 'warning', 7000); }
            p.videos.splice(vIdx, 1);
            if (this.data.currentVideoId === vId) this.data.currentVideoId = null;
            this.saveData(); this.renderProjectVideosScreen();
            if (vToDel) this.showToast(`Video "${this.utils.escapeHtml(vToDel.filename)}" deleted.`, 'success');
        },
        toggleVideoImportance(vId) {
            const v = this.getVideoById(this.data.currentProjectId, vId); if (!v) return;
            v.isImportant = !v.isImportant; this.saveData();
            this.renderProjectVideosScreen(this.dom.projectVideosSearch.value.trim()); 
            this.showToast(`Video "${this.utils.escapeHtml(v.filename)}" ${v.isImportant?'important':'not important'}.`, 'info');
        },

        resetActiveCardPlayerUI(findNewPlayerElements = true) {
            const acp = this.data.activeCardPlayer;
            if (acp.playerElement) {
                acp.playerElement.pause(); acp.playerElement.removeAttribute('src'); acp.playerElement.load();
                if (acp.boundPlayerTimeUpdate) acp.playerElement.removeEventListener('timeupdate', acp.boundPlayerTimeUpdate);
                if (acp.boundPlayerLoadedMetadata) acp.playerElement.removeEventListener('loadedmetadata', acp.boundPlayerLoadedMetadata);
                if (acp.boundPlayerEnded) acp.playerElement.removeEventListener('ended', acp.boundPlayerEnded);
                if (acp.boundPlayerError) acp.playerElement.removeEventListener('error', acp.boundPlayerError);
                if (acp.boundPlayerPlay) acp.playerElement.removeEventListener('play', acp.boundPlayerPlay);
                if (acp.boundPlayerPause) acp.playerElement.removeEventListener('pause', acp.boundPlayerPause);
                acp.playerElement.classList.add('hidden');
                if (acp.controlsContainerElement) acp.controlsContainerElement.classList.add('hidden');
                if (acp.promptElement) acp.promptElement.classList.add('hidden');
                if (acp.thumbnailElement) acp.thumbnailElement.classList.remove('hidden');
                if (acp.bigPlayButtonElement) acp.bigPlayButtonElement.classList.remove('hidden');
                if (acp.timecodeElement) acp.timecodeElement.textContent = '00:00 / 00:00';
                if (acp.progressBarElement) acp.progressBarElement.style.width = '0%';
            }
            this.data.activeCardPlayer = { videoId:null, cardElement:null, playerElement:null, thumbnailElement:null, bigPlayButtonElement:null, promptElement:null, fileInputElement:null, controlsContainerElement:null, playPauseBtnElement:null, rewindBtnElement:null, forwardBtnElement:null, progressBarContainerElement:null, progressBarElement:null, timecodeElement:null, stopBtnElement:null, isPlaying:false, isScrubbing:false, wasPlayingBeforeScrub:false, currentSegment:{startTime:0,endTime:0,duration:0}, boundPlayerTimeUpdate:null, boundPlayerLoadedMetadata:null, boundPlayerEnded:null, boundPlayerError:null, boundPlayerPlay:null, boundPlayerPause:null, _boundCardPlayerScrubMove:null, _boundCardPlayerScrubEnd:null };
        },

        async playVideoOnCard(videoId, cardElement, segmentData = null) {
            const videoData = this.getVideoById(this.data.currentProjectId, videoId); if (!videoData) return;
            if (this.data.activeCardPlayer.videoId && (this.data.activeCardPlayer.videoId !== videoId || (segmentData && this.data.activeCardPlayer.currentSegment.startTime !== segmentData.startTime))) {
                this.resetActiveCardPlayerUI(false); 
            }
            const acp = this.data.activeCardPlayer;
            acp.videoId = videoId; acp.cardElement = cardElement;
            ['playerElement', 'thumbnailElement', 'bigPlayButtonElement', 'promptElement', 'controlsContainerElement'].forEach(key => acp[key] = cardElement.querySelector(`#${key.replace('Element','').replace(/([A-Z])/g, "-$1").toLowerCase().replace('main-player', 'main-player')}-${videoId}`.replace('main-video-preview-player',`main-player-${videoId}`).replace('main-video-thumbnail',`main-thumbnail-${videoId}`).replace('play-main-video-preview-btn',`play-main-preview-btn-${videoId}`).replace('main-video-preview-prompt',`main-player-prompt-${videoId}`).replace('main-player-custom-controls',`main-player-controls-${videoId}`)));
            acp.fileInputElement = acp.promptElement?.querySelector('.main-video-preview-file-input');
            ['playPauseBtnElement','rewindBtnElement','forwardBtnElement','progressBarContainerElement','progressBarElement','timecodeElement','stopBtnElement'].forEach(key => acp[key] = acp.controlsContainerElement?.querySelector(`.${key.replace('Element','').replace(/([A-Z])/g, "-$1").toLowerCase().replace('main-player-custom-','main-player-')}`));
            
            acp.thumbnailElement?.classList.add('hidden'); acp.bigPlayButtonElement?.classList.add('hidden');
            acp.playerElement?.classList.remove('hidden'); acp.controlsContainerElement?.classList.remove('hidden');
            acp.promptElement?.classList.add('hidden');

            acp.boundPlayerError = () => this.handleCardPlayerError(videoData.filename);
            acp.boundPlayerLoadedMetadata = () => this.handleCardPlayerLoadedMetadata(segmentData);
            acp.boundPlayerTimeUpdate = () => this.handleCardPlayerTimeUpdate();
            acp.boundPlayerEnded = () => this.handleCardPlayerEnded();
            acp.boundPlayerPlay = () => { acp.isPlaying = true; if(acp.playPauseBtnElement){ acp.playPauseBtnElement.innerHTML = '&#10074;&#10074;'; acp.playPauseBtnElement.setAttribute('aria-label', 'Pause'); }};
            acp.boundPlayerPause = () => { acp.isPlaying = false; if(acp.playPauseBtnElement && !acp.isScrubbing){ acp.playPauseBtnElement.innerHTML = '&#9658;'; acp.playPauseBtnElement.setAttribute('aria-label', 'Play'); }};
            ['error','loadedmetadata','timeupdate','ended','play','pause'].forEach(evt => acp.playerElement?.addEventListener(evt, acp[`boundPlayer${evt.charAt(0).toUpperCase() + evt.slice(1)}`]));
            
            const videoSrc = await this.getVideoSource(this.data.currentProjectId, videoId, videoData.filename);
            if (videoSrc) {
                if(acp.playerElement.src !== videoSrc) { acp.playerElement.src = videoSrc; acp.playerElement.load(); }
                else { this.handleCardPlayerLoadedMetadata(segmentData); }
                 acp.playerElement.play().catch(() => this.showCardPlayerPrompt(videoData.filename));
            } else { this.showCardPlayerPrompt(videoData.filename); }
            cardElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        },
        handleCardPlayerLoadedMetadata(segmentData) {
            const acp = this.data.activeCardPlayer; if (!acp.playerElement?.duration) return;
            if (segmentData?.endTime > segmentData?.startTime) { 
                acp.currentSegment = {startTime:segmentData.startTime, endTime:Math.min(segmentData.endTime,acp.playerElement.duration), duration:0};
                acp.currentSegment.duration = acp.currentSegment.endTime - acp.currentSegment.startTime;
                acp.playerElement.currentTime = acp.currentSegment.startTime;
            } else { 
                acp.currentSegment = {startTime:0, endTime:acp.playerElement.duration, duration:acp.playerElement.duration};
                if(acp.playerElement.currentTime >= acp.playerElement.duration - 0.1) acp.playerElement.currentTime = 0;
            }
            this.updateCardPlayerTimeDisplay();
        },
        handleCardPlayerTimeUpdate() {
            const acp = this.data.activeCardPlayer; if (!acp.playerElement?.duration || acp.isScrubbing) return;
            const curTime = acp.playerElement.currentTime;
            if (curTime >= acp.currentSegment.endTime - 0.05) {
                acp.playerElement.pause(); acp.playerElement.currentTime = acp.currentSegment.endTime; 
                this.handleCardPlayerSegmentEnd(); return;
            }
            if (curTime < acp.currentSegment.startTime) acp.playerElement.currentTime = acp.currentSegment.startTime;
            const curSegTime = Math.max(0, curTime - acp.currentSegment.startTime);
            const prog = (acp.currentSegment.duration > 0) ? (curSegTime / acp.currentSegment.duration) * 100 : 0;
            if(acp.progressBarElement) acp.progressBarElement.style.width = `${Math.max(0,Math.min(100,prog))}%`;
            this.updateCardPlayerTimeDisplay();
        },
        handleCardPlayerSegmentEnd() { 
            const acp = this.data.activeCardPlayer;
            if(acp.playPauseBtnElement){acp.playPauseBtnElement.innerHTML='&#9658;';acp.playPauseBtnElement.setAttribute('aria-label','Replay');}
            if(acp.progressBarElement)acp.progressBarElement.style.width='100%'; this.updateCardPlayerTimeDisplay();
        },
        handleCardPlayerEnded() { this.handleCardPlayerSegmentEnd(); }, // Treat full video end same as segment end
        handleCardPlayerError(fname) { this.showToast(`Error playing from "${this.utils.escapeHtml(fname)}".`,'error',5000); this.showCardPlayerPrompt(fname); },
        updateCardPlayerTimeDisplay() {
            const acp = this.data.activeCardPlayer; if (!acp.playerElement || !acp.timecodeElement || isNaN(acp.currentSegment.duration)) return;
            const curSegTime = Math.max(0, Math.min(acp.playerElement.currentTime - acp.currentSegment.startTime, acp.currentSegment.duration));
            acp.timecodeElement.textContent = `${this.utils.formatTime(curSegTime)} / ${this.utils.formatTime(acp.currentSegment.duration>0?acp.currentSegment.duration:0)}`;
        },
        toggleCardPlayerPlayPause() {
            const acp = this.data.activeCardPlayer; if (!acp.playerElement?.src) return;
            if (acp.isPlaying) acp.playerElement.pause();
            else {
                if (acp.playerElement.currentTime >= acp.currentSegment.endTime - 0.1) acp.playerElement.currentTime = acp.currentSegment.startTime;
                acp.playerElement.play().catch(e=>console.error("Card player play toggle error:",e));
            }
        },
        rewindCardPlayer() { const acp=this.data.activeCardPlayer; if(!acp.playerElement?.src)return; acp.playerElement.currentTime=Math.max(acp.currentSegment.startTime,acp.playerElement.currentTime-this.data.skipTimeSeconds);},
        forwardCardPlayer() { const acp=this.data.activeCardPlayer; if(!acp.playerElement?.src)return; acp.playerElement.currentTime=Math.min(acp.currentSegment.endTime,acp.playerElement.currentTime+this.data.skipTimeSeconds);},
        stopAndResetCardPlayer() { this.resetActiveCardPlayerUI(true); },
        _handleCardPlayerScrub(event, isTouch = false) {
            const acp = this.data.activeCardPlayer; if (!acp.playerElement?.src || isNaN(acp.currentSegment.duration) || acp.currentSegment.duration <=0 ) return;
            const clientX = isTouch ? (event.touches[0] || event.changedTouches[0]).clientX : event.clientX;
            const rect = acp.progressBarContainerElement.getBoundingClientRect();
            const seekRatio = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
            acp.playerElement.currentTime = acp.currentSegment.startTime + (seekRatio * acp.currentSegment.duration);
            if(acp.progressBarElement) acp.progressBarElement.style.width = `${seekRatio * 100}%`;
            this.updateCardPlayerTimeDisplay();
        },
        handleCardPlayerProgressBarMouseDown(event) {
            const acp = this.data.activeCardPlayer; if (!acp.playerElement?.src) return;
            event.preventDefault(); acp.isScrubbing = true; acp.wasPlayingBeforeScrub = acp.isPlaying; 
            if (acp.isPlaying) acp.playerElement.pause(); 
            this._handleCardPlayerScrub(event);
            acp._boundCardPlayerScrubMove = (e) => this._handleCardPlayerScrub(e);
            acp._boundCardPlayerScrubEnd = () => {
                document.removeEventListener('mousemove', acp._boundCardPlayerScrubMove); document.removeEventListener('mouseup', acp._boundCardPlayerScrubEnd);
                acp.isScrubbing = false; if (acp.wasPlayingBeforeScrub) acp.playerElement.play().catch(console.warn);
                this.updateCardPlayerTimeDisplay(); 
            };
            document.addEventListener('mousemove', acp._boundCardPlayerScrubMove); document.addEventListener('mouseup', acp._boundCardPlayerScrubEnd);
        },
        handleCardPlayerProgressBarTouchStart(event) {
            const acp = this.data.activeCardPlayer; if (!acp.playerElement?.src) return;
            event.preventDefault(); acp.isScrubbing = true; acp.wasPlayingBeforeScrub = acp.isPlaying;
            if (acp.isPlaying) acp.playerElement.pause();
            this._handleCardPlayerScrub(event, true);
            acp._boundCardPlayerScrubMove = (e) => this._handleCardPlayerScrub(e, true);
            acp._boundCardPlayerScrubEnd = () => {
                document.removeEventListener('touchmove',acp._boundCardPlayerScrubMove);document.removeEventListener('touchend',acp._boundCardPlayerScrubEnd);document.removeEventListener('touchcancel',acp._boundCardPlayerScrubEnd);
                acp.isScrubbing = false; if(acp.wasPlayingBeforeScrub)acp.playerElement.play().catch(console.warn);
                this.updateCardPlayerTimeDisplay();
            };
            document.addEventListener('touchmove',acp._boundCardPlayerScrubMove,{passive:false});document.addEventListener('touchend',acp._boundCardPlayerScrubEnd);document.addEventListener('touchcancel',acp._boundCardPlayerScrubEnd);
        },
        showCardPlayerPrompt(fname) { 
            const acp = this.data.activeCardPlayer; if (!acp.promptElement) return;
            acp.promptElement.querySelector('p').innerHTML = `Video "<strong>${this.utils.escapeHtml(fname)}</strong>" needs selection.`;
            acp.promptElement.classList.remove('hidden');
            acp.playerElement?.classList.add('hidden'); acp.controlsContainerElement?.classList.add('hidden');
            acp.thumbnailElement?.classList.add('hidden'); acp.bigPlayButtonElement?.classList.add('hidden');
        },
        async handleCardPlayerFileSelection(file, vIdToMatch) {
            const acp = this.data.activeCardPlayer; if (!file || acp.videoId !== vIdToMatch) return;
            const vData = this.getVideoById(this.data.currentProjectId, acp.videoId); if (!vData) return;
            if (file.name !== vData.filename) { this.showToast(`Incorrect file. Expected "${this.utils.escapeHtml(vData.filename)}".`,'warning'); if(acp.fileInputElement)acp.fileInputElement.value=''; return;}
            const key = `${this.data.currentProjectId}-${acp.videoId}`;
            if (this.data.videoFileCache[key]) URL.revokeObjectURL(this.data.videoFileCache[key]);
            try { await this.idb.storeFile(acp.videoId, file); } catch (err) { this.showToast(`Could not save "${this.utils.escapeHtml(file.name)}" persistently.`,'warning');}
            this.data.videoFileCache[key] = URL.createObjectURL(file); 
            if (acp.playerElement) {
                acp.promptElement.classList.add('hidden'); acp.playerElement.classList.remove('hidden'); acp.controlsContainerElement.classList.remove('hidden');
                acp.playerElement.src = this.data.videoFileCache[key]; acp.playerElement.load(); 
                acp.playerElement.play().catch(e => console.error("Error playing card player after file select:", e));
            }
            if(acp.fileInputElement) acp.fileInputElement.value = '';
        },
        confirmDeleteLogItemFromScreen2(vId, lId){
            const log = this.getLogById(this.data.currentProjectId, vId, lId); if (!log) return;
            this.showConfirmationModal(`Delete log? <br><small>${this.utils.escapeHtml(log.notes.substring(0,50))}...</small><br>Undone.`, () => this.deleteLogItem(vId, lId), null, "Delete Log", "button-danger");
        },
        deleteLogItem(vId, lId) { 
            const vid = this.getVideoById(this.data.currentProjectId, vId); if (!vid?.logs) return;
            const log = this.getLogById(this.data.currentProjectId, vId, lId);
            if (this.data.activeCardPlayer.videoId === vId && this.data.activeCardPlayer.currentSegment?.startTime === log?.markIn) {
                this.resetActiveCardPlayerUI(true);
            }
            vid.logs = vid.logs.filter(l => l.id !== lId);
            this.saveData(); this.renderProjectVideosScreen(this.dom.projectVideosSearch.value.trim()); 
            if(log) this.showToast(`Log entry deleted.`, 'success');
        },

        // --- Screen 3 Methods ---
        async renderVideoLoggingScreen() { 
            const vData = this.getVideoById(this.data.currentProjectId, this.data.currentVideoId);
            if (!vData) { this.navigateTo('screen-project-videos', { projectId: this.data.currentProjectId }); this.showToast("Video not found.", "error"); return; }
            this.dom.videoFilenameHeader.textContent = this.utils.escapeHtml(vData.filename);
            this.resetLogForm(); this.renderSavedLogsList();
            this.data.videoElement.pause(); this.data.videoElement.removeAttribute('src'); this.data.videoElement.load(); 
            this.data.playPauseBtn.innerHTML = '<span class="button-icon">&#9658;</span>'; this.data.playPauseBtn.setAttribute('aria-label', 'Play video');
            this.updateVideoTimes(); 
            this.dom.videoPlayerContainer.classList.remove('hidden'); this.dom.videoFilePrompt.classList.add('hidden'); 
            this.data.videoElement.classList.add('hidden'); 
            const videoSrc = await this.getVideoSource(this.data.currentProjectId, this.data.currentVideoId, vData.filename);
            if (videoSrc) { this.data.videoElement.src = videoSrc; this.data.videoElement.classList.remove('hidden'); } 
            else { this.promptForVideoFile(vData.filename); }
        },
        promptForVideoFile(fname) { 
            this.data.videoElement.classList.add('hidden'); this.dom.videoFilePrompt.classList.remove('hidden'); 
            this.dom.videoFilePromptMessage.innerHTML = `Video "<strong>${this.utils.escapeHtml(fname)}</strong>" needs selection.`;
            this.dom.videoFileInputLogging.dataset.expectedFilename = fname; 
        },
        async handleVideoFileSelectionForLogging(file) { 
            const expected = this.dom.videoFileInputLogging.dataset.expectedFilename;
            if (!this.getVideoById(this.data.currentProjectId, this.data.currentVideoId)) return;
            if (file && file.name === expected) {
                const key = `${this.data.currentProjectId}-${this.data.currentVideoId}`;
                if (this.data.videoFileCache[key]) URL.revokeObjectURL(this.data.videoFileCache[key]);
                try { await this.idb.storeFile(this.data.currentVideoId, file); } catch (err) { this.showToast(`Could not save "${this.utils.escapeHtml(file.name)}" persistently.`, 'warning'); }
                this.data.videoFileCache[key] = URL.createObjectURL(file); 
                this.data.videoElement.src = this.data.videoFileCache[key]; 
                this.dom.videoFilePrompt.classList.add('hidden'); this.data.videoElement.classList.remove('hidden'); 
            } else if (file) { this.showToast(`Incorrect file. Expected "${this.utils.escapeHtml(expected)}".`, 'warning'); }
            this.dom.videoFileInputLogging.value = ''; 
        },
        updateVideoTimes() { 
            if (!this.data.videoElement?.duration) {
                this.data.timecodeDisplay.textContent = '00:00 / 00:00'; this.data.timelineProgress.style.width = '0%';
                if(this.data.markInBtn) this.data.markInBtn.textContent = `Mark In (00:00.0)`;
                if(this.data.markOutBtn) this.data.markOutBtn.textContent = `Mark Out (00:00.0)`; return;
            }
            const cur = this.data.videoElement.currentTime, dur = this.data.videoElement.duration;
            this.data.timecodeDisplay.textContent = `${this.utils.formatTime(cur)} / ${this.utils.formatTime(dur)}`;
            if (!this.data.isScrubbing) this.data.timelineProgress.style.width = `${(cur/dur)*100}%`;
            if (this.data.markInTime===0 || this.data.markInBtn?.classList.contains('default-mark')) this.data.markInBtn.textContent = `Mark In (${this.utils.formatTime(cur,true)})`;
            if (this.data.markOutTime===null || this.data.markOutBtn?.classList.contains('default-mark')) this.data.markOutBtn.textContent = `Mark Out (${this.utils.formatTime(cur,true)})`;
        },
        async togglePlayPause() { 
            if (!this.data.videoElement.src || !this.dom.videoFilePrompt.classList.contains('hidden')) { 
                const vData = this.getVideoById(this.data.currentProjectId, this.data.currentVideoId);
                this.showToast("Select video file.", "warning"); this.promptForVideoFile(vData?.filename || "video file"); return; 
            }
            if (this.data.videoElement.paused || this.data.videoElement.ended) { 
                try { await this.data.videoElement.play(); } catch (e) {
                     const vData = this.getVideoById(this.data.currentProjectId, this.data.currentVideoId);
                     if (vData) this.promptForVideoFile(vData.filename);
                }
            } else { this.data.videoElement.pause(); }
        },
        _adjustTimeS3(delta) { if(!this.data.videoElement?.src||this.dom.videoFilePrompt.classList.contains('hidden')||isNaN(this.data.videoElement.duration)){this.showToast("Video not ready.","warning");return;} this.data.videoElement.currentTime=Math.max(0,Math.min(this.data.videoElement.duration,this.data.videoElement.currentTime+delta));},
        rewindVideo() { this._adjustTimeS3(-this.data.skipTimeSeconds); },
        fastForwardVideo() { this._adjustTimeS3(this.data.skipTimeSeconds); },
        _handleTimelineScrub(event, isTouch = false) {
            if (!this.data.videoElement?.duration) return;
            const clientX = isTouch ? (event.touches[0] || event.changedTouches[0]).clientX : event.clientX;
            const rect = this.data.timelineContainer.getBoundingClientRect();
            const seekRatio = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
            const newTime = seekRatio * this.data.videoElement.duration;
            this.data.videoElement.currentTime = newTime;
            this.data.timelineProgress.style.width = `${seekRatio*100}%`;
            this.data.timecodeDisplay.textContent = `${this.utils.formatTime(newTime)} / ${this.utils.formatTime(this.data.videoElement.duration)}`;
        },
        handleTimelineMouseDown(event) {
            if (!this.data.videoElement?.src || this.dom.videoFilePrompt.classList.contains('hidden') || isNaN(this.data.videoElement.duration)) return;
            event.preventDefault(); this.data.isScrubbing = true; this.data.wasPlayingBeforeScrub = !this.data.videoElement.paused;
            if (this.data.wasPlayingBeforeScrub) this.data.videoElement.pause();
            this._handleTimelineScrub(event); 
            document.addEventListener('mousemove', this.boundHandleTimelineMouseMove); document.addEventListener('mouseup', this.boundHandleTimelineMouseUp);
        },
        handleTimelineMouseMove(event) { if(this.data.isScrubbing)this._handleTimelineScrub(event);},
        handleTimelineMouseUp(event) {
            if (!this.data.isScrubbing) return; this.data.isScrubbing = false; this._handleTimelineScrub(event); 
            document.removeEventListener('mousemove', this.boundHandleTimelineMouseMove); document.removeEventListener('mouseup', this.boundHandleTimelineMouseUp);
            if (this.data.wasPlayingBeforeScrub) this.data.videoElement.play().catch(console.warn);
            this.updateVideoTimes(); 
        },
        handleTimelineTouchStart(event) {
            if (!this.data.videoElement?.src || this.dom.videoFilePrompt.classList.contains('hidden') || isNaN(this.data.videoElement.duration)) return;
            event.preventDefault(); this.data.isScrubbing = true; this.data.wasPlayingBeforeScrub = !this.data.videoElement.paused;
            if (this.data.wasPlayingBeforeScrub) this.data.videoElement.pause();
            this._handleTimelineScrub(event, true); 
            document.addEventListener('touchmove', this.boundHandleTimelineTouchMove, { passive: false }); document.addEventListener('touchend', this.boundHandleTimelineTouchEnd); document.addEventListener('touchcancel', this.boundHandleTimelineTouchEnd); 
        },
        handleTimelineTouchMove(event) {if(this.data.isScrubbing){event.preventDefault();this._handleTimelineScrub(event,true);}},
        handleTimelineTouchEnd(event) {
            if (!this.data.isScrubbing) return; this.data.isScrubbing = false; 
            if (event.changedTouches?.length) this._handleTimelineScrub(event, true);
            document.removeEventListener('touchmove',this.boundHandleTimelineTouchMove);document.removeEventListener('touchend',this.boundHandleTimelineTouchEnd);document.removeEventListener('touchcancel',this.boundHandleTimelineTouchEnd);
            if (this.data.wasPlayingBeforeScrub) this.data.videoElement.play().catch(console.warn);
            this.updateVideoTimes(); 
        },
        setMarkIn() { 
            if (!this.data.videoElement.src || !this.dom.videoFilePrompt.classList.contains('hidden')) { this.showToast("Load video.", "warning"); return; }
            this.data.markInTime = this.data.videoElement.currentTime;
            this.data.markInBtn.textContent = `Mark In (${this.utils.formatTime(this.data.markInTime, true)})`;
            this.data.markInBtn.classList.remove('default-mark','button-secondary'); this.data.markInBtn.classList.add('button-primary'); 
            setTimeout(() => {this.data.markInBtn.classList.remove('button-primary');this.data.markInBtn.classList.add('button-secondary');},1000);
            if (this.data.markOutTime !== null && this.data.markOutTime < this.data.markInTime) {
                this.data.markOutTime = null; this.data.markOutBtn.textContent = `Mark Out (${this.utils.formatTime(this.data.videoElement.currentTime, true)})`; this.data.markOutBtn.classList.add('default-mark');
            }
        },
        setMarkOut() { 
            if (!this.data.videoElement.src || !this.dom.videoFilePrompt.classList.contains('hidden')) { this.showToast("Load video.", "warning"); return; }
            const cur = this.data.videoElement.currentTime;
            if (cur <= this.data.markInTime) { this.showToast("Mark Out after Mark In.", "warning"); return; }
            this.data.markOutTime = cur;
            this.data.markOutBtn.textContent = `Mark Out (${this.utils.formatTime(this.data.markOutTime, true)})`;
            this.data.markOutBtn.classList.remove('default-mark','button-secondary'); this.data.markOutBtn.classList.add('button-primary');
            setTimeout(() => {this.data.markOutBtn.classList.remove('button-primary');this.data.markOutBtn.classList.add('button-secondary');},1000);
        },
        handleStarRating(event) { 
            const starBtn = event.target.closest('button.star');
            if (starBtn) { this.data.currentRating = parseInt(starBtn.dataset.value); this.updateStarDisplay(); }
        },
        updateStarDisplay() { 
            this.dom.logRatingContainer.querySelectorAll('button.star').forEach(s => {
                const sel = parseInt(s.dataset.value) <= this.data.currentRating;
                s.classList.toggle('selected', sel); s.setAttribute('aria-pressed', sel ? 'true' : 'false');
            });
        },
        async saveLogEntry() { 
            const notes = this.dom.logNotes.value.trim(), keywordsRaw = this.dom.logKeywords.value.trim();
            const keywords = keywordsRaw ? keywordsRaw.split(',').map(k => k.trim()).filter(Boolean) : [];
            if (this.data.markOutTime === null || this.data.markOutTime <= this.data.markInTime) { this.showToast("Set valid Mark In/Out.", "warning"); return; }
            if (!notes || this.data.currentRating === 0) { this.showToast("Notes & rating required.", "warning"); return; }
            this.dom.saveLogBtn.disabled = true; this.dom.saveLogBtn.textContent = 'Saving...';
            let thumb = null;
            try {
                if (this.data.videoElement.src && this.data.videoElement.readyState >= 2 && this.dom.videoFilePrompt.classList.contains('hidden')) { 
                    thumb = await this.generateLogThumbnail(this.data.markInTime); 
                }
            } catch (error) { this.showToast("Thumbnail gen failed.", "warning");}
            const vid = this.getVideoById(this.data.currentProjectId, this.data.currentVideoId);
            if (!vid) { this.showToast("Video not found.", "error"); this.dom.saveLogBtn.disabled=false; this.dom.saveLogBtn.textContent='Save Log'; return; }
            if (!vid.logs) vid.logs = [];
            const editId = this.dom.editingLogIdInput.value;
            const logData = { markIn:this.data.markInTime, markOut:this.data.markOutTime, notes, rating:this.data.currentRating, keywords, thumbnail };
            if (editId) { 
                const log = vid.logs.find(l => l.id === editId); if (log) Object.assign(log, logData, {updatedAt:new Date().toISOString()});
                this.showToast("Log updated.", "success");
            } else { 
                vid.logs.push({ ...logData, id:this.utils.generateId(), createdAt:new Date().toISOString() }); 
                this.showToast("Log saved.", "success");
            }
            this.saveData(); this.renderSavedLogsList(); this.resetLogForm();
            this.dom.saveLogBtn.disabled = false; this.dom.saveLogBtn.textContent = 'Save Log';
        },
        generateLogThumbnail(time) { 
            return new Promise((resolve, reject) => {
                if(!this.data.videoElement?.src||this.data.videoElement.readyState<2||!this.dom.videoFilePrompt.classList.contains('hidden'))return reject("Video not ready for thumb.");
                const vid = this.data.videoElement, canvas = this.dom.thumbnailCanvas, ctx = canvas.getContext('2d');
                if(!vid.videoWidth||!vid.videoHeight)return reject("Video dimensions zero.");
                const origTime=vid.currentTime,origPaused=vid.paused,origMuted=vid.muted;vid.muted=true;
                let tOut; const cleanup=()=>{vid.removeEventListener('seeked',onSeeked);vid.removeEventListener('error',onError);clearTimeout(tOut);vid.currentTime=origTime;if(!origPaused)vid.play().catch(console.warn);vid.muted=origMuted;};
                const onSeeked=()=>{cleanup();const ar=vid.videoWidth/vid.videoHeight;canvas.width=160;canvas.height=canvas.width/ar||90;ctx.clearRect(0,0,canvas.width,canvas.height);ctx.drawImage(vid,0,0,canvas.width,canvas.height);try{resolve(canvas.toDataURL('image/jpeg',0.6));}catch(e){reject("Thumb creation error.");}};
                const onError=(e)=>{cleanup();reject("Seek error for thumb.");};
                vid.addEventListener('seeked',onSeeked,{once:true});vid.addEventListener('error',onError,{once:true});
                if(!origPaused)vid.pause();vid.currentTime=time;
                tOut=setTimeout(()=>{if(vid.seeking||(Math.abs(vid.currentTime-time)<0.5&&vid.readyState>=vid.HAVE_CURRENT_DATA))onSeeked();else onError(new Error("Seek timeout."));},1500); 
            });
        },
        resetLogForm() { 
            this.dom.logNotes.value = ''; this.dom.logKeywords.value = ''; this.data.currentRating = 0; this.updateStarDisplay();
            this.data.markInTime = 0; this.data.markOutTime = null;
            const defTime = (this.data.videoElement?.src && this.dom.videoFilePrompt.classList.contains('hidden')) ? this.data.videoElement.currentTime : 0;
            this.data.markInBtn.textContent = `Mark In (${this.utils.formatTime(defTime, true)})`; this.data.markInBtn.classList.add('default-mark');
            this.data.markOutBtn.textContent = `Mark Out (${this.utils.formatTime(defTime, true)})`; this.data.markOutBtn.classList.add('default-mark');
            this.dom.editingLogIdInput.value = ''; this.dom.saveLogBtn.textContent = 'Save Log';
        },
        renderSavedLogsList() { 
            const vid = this.getVideoById(this.data.currentProjectId, this.data.currentVideoId);
            this.dom.savedLogsList.innerHTML = '';
            if (!vid?.logs?.length) { this.dom.savedLogsList.innerHTML = '<div class="empty-state" style="padding:20px;font-size:0.9em;"><p>No logs saved.</p></div>'; return; }
            const frag = document.createDocumentFragment();
            [...vid.logs].sort((a,b)=>a.markIn-b.markIn).forEach(log => {
                const item = document.createElement('article');item.className='log-item';item.id=`log-item-${log.id}`;
                const stars=Array(5).fill(0).map((_,i)=>`<span class="star ${i<log.rating?'selected':''}" style="font-size:0.8em;color:${i<log.rating?'var(--warning-color)':'var(--border-color)'};">&#9733;</span>`).join('');
                item.innerHTML=`<div class="log-item-header"><span class="log-item-time">${this.utils.formatTime(log.markIn)} - ${this.utils.formatTime(log.markOut)}</span><div class="log-item-rating">${stars}</div></div><p class="log-item-notes">${this.utils.escapeHtml(log.notes)}</p>${log.keywords?.length?`<p class="log-item-keywords">Keywords: ${this.utils.escapeHtml(log.keywords.join(', '))}</p>`:''}${log.thumbnail?`<img src="${log.thumbnail}" alt="Log thumbnail">`:''}<div class="card-actions" style="margin-top:10px;"><button class="button button-subtle button-small btn-go-to-log-time" data-time="${log.markIn}">Go to</button><button class="button button-secondary button-small btn-edit-log" data-log-id="${log.id}">Edit</button><button class="button button-subtle button-small btn-delete-log" data-log-id="${log.id}">Delete</button></div>`;
                frag.appendChild(item);
            });
            this.dom.savedLogsList.appendChild(frag);
            this.dom.savedLogsList.querySelectorAll('.btn-go-to-log-time').forEach(b=>b.addEventListener('click',e=>this.goToLogTime(parseFloat(e.currentTarget.dataset.time))));
            this.dom.savedLogsList.querySelectorAll('.btn-edit-log').forEach(b=>b.addEventListener('click',e=>this.editLogEntry(e.currentTarget.dataset.logId)));
            this.dom.savedLogsList.querySelectorAll('.btn-delete-log').forEach(b=>b.addEventListener('click',e=>this.confirmDeleteLogOnScreen3(e.currentTarget.dataset.logId)));
        },
        async goToLogTime(time) { 
            if(this.data.videoElement?.src && this.dom.videoFilePrompt.classList.contains('hidden')) {
                this.data.videoElement.currentTime = time; 
                try { await this.data.videoElement.play(); } catch(e) { this.showToast("Error playing at time.", "error"); }
                this.data.videoElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else { 
                const vData = this.getVideoById(this.data.currentProjectId, this.data.currentVideoId);
                this.showToast("Video not loaded.", "warning"); this.promptForVideoFile(vData?.filename || "video file"); 
            }
        },
        editLogEntry(lId, fromNav = false) { 
            const log = this.getLogById(this.data.currentProjectId, this.data.currentVideoId, lId); if (!log) return;
            this.dom.logNotes.value = log.notes; this.dom.logKeywords.value = log.keywords?.join(', ') || '';
            this.data.currentRating = log.rating; this.updateStarDisplay();
            this.data.markInTime = log.markIn; this.data.markOutTime = log.markOut;
            if (this.data.videoElement?.src && this.dom.videoFilePrompt.classList.contains('hidden')) this.data.videoElement.currentTime = log.markIn;
            this.data.markInBtn.textContent = `Mark In (${this.utils.formatTime(log.markIn, true)})`;
            this.data.markOutBtn.textContent = `Mark Out (${this.utils.formatTime(log.markOut, true)})`;
            [this.data.markInBtn,this.data.markOutBtn].forEach(b=>b.classList.remove('default-mark'));
            this.dom.editingLogIdInput.value = log.id; this.dom.saveLogBtn.textContent = 'Update Log';
            this.dom.logNotes.focus(); this.dom.logNotes.closest('article.card')?.scrollIntoView({behavior:'smooth',block:'start'});
        },
        confirmDeleteLogOnScreen3(lId) { 
            const log = this.getLogById(this.data.currentProjectId, this.data.currentVideoId, lId); if (!log) return;
            this.showConfirmationModal(`Delete log? <br><small>${this.utils.escapeHtml(log.notes.substring(0,50))}...</small><br>Undone.`, () => this.deleteLogOnScreen3(lId), null, "Delete Log", "button-danger");
        },
        deleteLogOnScreen3(lId) { 
            const vid = this.getVideoById(this.data.currentProjectId, this.data.currentVideoId);
            if (!vid?.logs) return;
            vid.logs = vid.logs.filter(l => l.id !== lId); this.saveData(); this.renderSavedLogsList();
            if(this.dom.editingLogIdInput.value === lId) this.resetLogForm();
            this.showToast("Log entry deleted.", "success");
        },

        // --- Modal and Toast Methods ---
        showModal(id) { 
            const m = document.getElementById(id); 
            if (m) { this.data.previouslyFocusedElement = document.activeElement; m.style.display='block'; m.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')?.focus(); }
        },
        hideModal(id) { 
            document.getElementById(id)?.style.setProperty('display', 'none', 'important'); // Force hide
            if (this.data.previouslyFocusedElement) { try { this.data.previouslyFocusedElement.focus(); } catch(e){} this.data.previouslyFocusedElement = null; }
        },
        showToast(msg, type = 'info', dur = 3000) {
            if (!this.dom.toastContainer) this.dom.toastContainer = document.getElementById('toast-container');
            if (!this.dom.toastContainer) { alert(`${type.toUpperCase()}: ${msg}`); return; }
            const t = document.createElement('div'); t.className = `toast-message ${type}`; t.textContent = msg; t.setAttribute('role', 'alert');
            this.dom.toastContainer.appendChild(t); requestAnimationFrame(() => t.classList.add('show'));
            setTimeout(() => { t.classList.remove('show'); t.addEventListener('transitionend', () => t.remove(), { once: true }); }, dur);
        },
        showConfirmationModal(msg, onConfirm, onCancel = null, confirmBtnTxt = 'Confirm', confirmBtnCls = 'button-danger', title = 'Confirm Action') {
            this.dom.modals.confirmAction.querySelector('.modal-title').textContent = title;
            this.dom.confirmActionMessage.innerHTML = msg;
            this.dom.btnConfirmActionConfirm.textContent = confirmBtnTxt; this.dom.btnConfirmActionConfirm.className = `button ${confirmBtnCls}`; 
            this.dom.btnConfirmActionConfirm.onclick = () => { onConfirm(); this.hideModal('modal-confirm-action'); };
            this.dom.btnConfirmActionCancel.onclick = () => { if (onCancel) onCancel(); this.hideModal('modal-confirm-action'); };
            this.showModal('modal-confirm-action');
        },
    };
    document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
