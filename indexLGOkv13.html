<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogReel Pro</title>
    <style>
        :root {
            --primary-color: #3B82F6; /* Modern Blue */
            --primary-color-dark: #2563EB;
            --primary-color-light: #EFF6FF; /* Light blue for backgrounds/hovers */
            --secondary-color: #10B981; /* Teal/Green for success/accents */
            --text-color: #1F2937; /* Dark Gray */
            --text-color-light: #4B5563;
            --text-color-very-light: #6B7280;
            --text-on-primary: #FFFFFF;
            --bg-color: #F9FAFB; /* Very Light Gray */
            --card-bg-color: #FFFFFF;
            --border-color: #E5E7EB; /* Lighter border */
            --danger-color: #EF4444;
            --warning-color: #F59E0B; /* Amber for stars */
            --success-color: var(--secondary-color);
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --border-radius: 8px; /* Slightly larger radius */
            --border-radius-small: 4px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --input-focus-ring: 0 0 0 3px rgba(59, 130, 246, 0.3); /* primary-color with opacity */
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: 16px; /* Base font size */
        }

        .container {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px 15px;
        }

        .screen { display: none; }
        .screen.active { 
            display: block; 
            animation: fadeInScreen 0.3s ease-out;
        }
        @keyframes fadeInScreen {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Headers */
        .app-header {
            background-color: var(--card-bg-color);
            padding: 16px 15px;
            text-align: center;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }
        .app-header h1 {
            font-size: 1.5em; /* 24px */
            font-weight: 700;
            color: var(--primary-color);
        }

        .header-with-back {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            background-color: var(--card-bg-color);
            padding: 12px 15px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 900;
        }
        .header-with-back .back-button {
            grid-column: 1 / 2;
            background: none;
            border: none;
            color: var(--text-color-light);
            font-size: 1.5em; /* For icon */
            cursor: pointer;
            padding: 8px;
            margin-right: 8px; /* Space between button and title */
            border-radius: var(--border-radius-small);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, color 0.2s;
        }
        .header-with-back .back-button:hover { background-color: var(--primary-color-light); color: var(--primary-color); }
        .header-with-back .back-button .icon { width: 24px; height: 24px; }

        .header-with-back h2 {
            grid-column: 2 / 3;
            font-size: 1.25em; /* 20px */
            font-weight: 600;
            margin: 0;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .header-spacer-right {
            grid-column: 3 / 4;
            width: 1px;
            visibility: hidden;
        }

        /* Buttons */
        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px; /* Space between icon and text */
            padding: 10px 16px;
            font-size: 0.9375em; /* 15px */
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            border: 1px solid transparent;
            border-radius: var(--border-radius);
            transition: all 0.2s ease-in-out;
            white-space: nowrap;
        }
        .button:focus-visible {
            outline: none;
            box-shadow: var(--input-focus-ring);
        }
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: var(--border-color);
            color: var(--text-color-light);
            border-color: var(--border-color);
        }
        .button-primary {
            background-color: var(--primary-color);
            color: var(--text-on-primary);
            border-color: var(--primary-color);
        }
        .button-primary:hover:not(:disabled) {
            background-color: var(--primary-color-dark);
            border-color: var(--primary-color-dark);
            box-shadow: var(--shadow-sm);
        }
        .button-secondary {
            background-color: var(--card-bg-color);
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .button-secondary:hover:not(:disabled) {
            background-color: var(--primary-color-light);
        }
        .button-danger {
            background-color: var(--danger-color);
            color: var(--text-on-primary);
            border-color: var(--danger-color);
        }
        .button-danger:hover:not(:disabled) {
            background-color: #CC2525; /* Darker danger */
            border-color: #CC2525;
        }
        .button-subtle {
            background-color: transparent;
            color: var(--text-color-light);
            border-color: var(--border-color);
        }
        .button-subtle:hover:not(:disabled) {
            background-color: var(--bg-color);
            color: var(--text-color);
            border-color: #D1D5DB; /* Slightly darker border on hover */
        }
        .button-full-width { display: flex; width: 100%; margin-bottom: 10px; }
        .button-small { padding: 6px 12px; font-size: 0.875em; /* 14px */ }
        .button .icon { width: 18px; height: 18px; } /* Default icon size in buttons */
        .button-small .icon { width: 16px; height: 16px; }
        .button-icon-only { padding: 8px; }
        .button-icon-only .icon { margin: 0; }


        /* Cards */
        article.card, article.video-entry-card, article.log-item {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 20px; 
            box-shadow: var(--shadow-md);
            overflow: hidden; /* For nested rounded corners */
        }
        article.video-entry-card { margin-bottom: 24px; }
        article.log-item { padding: 16px; } 

        .card-content-padding { padding: 16px; }

        .card-title { 
            font-size: 1.25em; /* 20px */
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }
        .card-meta {
            font-size: 0.875em; /* 14px */
            color: var(--text-color-light);
            margin-bottom: 16px;
        }
        .card-actions {
            margin-top: 16px;
            padding: 0 16px 16px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .card-actions .button { flex-grow: 1; }
        
        /* Forms */
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.875em; /* 14px */
            color: var(--text-color-light);
        }
        .form-group input[type="text"],
        .form-group input[type="search"],
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-small);
            font-size: 1em;
            font-family: var(--font-family);
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: var(--card-bg-color); /* Ensure input bg matches card if needed */
        }
        .form-group input[type="text"]:focus,
        .form-group input[type="search"]:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: var(--input-focus-ring);
            outline: none;
        }
        .form-group textarea { min-height: 120px; resize: vertical; }
        
        input[type="search"]#project-videos-search { /* Specific styling for search bar on screen 2 */
            width: 100%;
            padding: 12px 15px;
            font-size: 1em;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 24px;
            background-color: var(--card-bg-color);
            box-shadow: var(--shadow-sm);
        }
        input[type="search"]#project-videos-search:focus {
            border-color: var(--primary-color);
            box-shadow: var(--input-focus-ring), var(--shadow-sm);
            outline: none;
        }

        /* Tag Input for Keywords */
        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-small);
            background-color: var(--card-bg-color);
            cursor: text; /* Indicate it's an input area */
        }
        .tag-input-container:focus-within {
             border-color: var(--primary-color);
             box-shadow: var(--input-focus-ring);
        }
        .tag-item {
            display: inline-flex;
            align-items: center;
            background-color: var(--primary-color-light);
            color: var(--primary-color-dark);
            padding: 4px 8px;
            border-radius: var(--border-radius-small);
            font-size: 0.875em;
            font-weight: 500;
        }
        .tag-item .remove-tag-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            margin-left: 6px;
            cursor: pointer;
            padding: 0;
            font-size: 1.1em; /* For icon size */
            line-height: 1;
        }
        .tag-item .remove-tag-btn .icon { width: 14px; height: 14px; }
        .tag-input-container input[type="text"] {
            flex-grow: 1;
            border: none;
            padding: 4px 0; /* Minimal padding */
            font-size: 1em;
            outline: none;
            box-shadow: none;
            min-width: 100px; /* So it doesn't collapse too small */
            background-color: transparent;
        }


        /* Modals */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; 
            background-color: rgba(17, 24, 39, 0.6); /* Darker overlay, text-color like */
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
            padding: 20px 0; /* Allow scrolling for tall modals on small screens */
        }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content {
            background-color: var(--card-bg-color); margin: auto; padding: 24px;
            border-radius: var(--border-radius); width: 90%; max-width: 500px;
            box-shadow: var(--shadow-lg); 
            animation: modalOpen 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            max-height: calc(100vh - 40px); /* Ensure modal doesn't exceed viewport height */
            overflow-y: auto; /* Scroll content if it exceeds max-height */
        }
        @keyframes modalOpen { 
            from { opacity: 0; transform: translateY(-20px) scale(0.95); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 12px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px;
        }
        .modal-title { font-size: 1.25em; font-weight: 600; color: var(--text-color); }
        .modal .close-button {
            background: none; border: none; padding: 8px;
            color: var(--text-color-very-light); font-size: 1.5em; /* For icon */
            cursor: pointer; line-height: 1; border-radius: 50%;
            transition: background-color 0.2s, color 0.2s;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .modal .close-button:hover { background-color: var(--bg-color); color: var(--text-color); }
        .modal .close-button .icon { width: 20px; height: 20px; }
        .modal-actions { margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end; }


        /* Toast Notifications */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: calc(100% - 40px); 
        }
        .toast-message {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 18px;
            background-color: var(--text-color);
            color: var(--text-on-primary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            font-size: 0.9375em; /* 15px */
            opacity: 0;
            transform: translateX(110%); 
            transition: opacity 0.3s ease, transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .toast-message .icon { width: 20px; height: 20px; flex-shrink: 0; }
        .toast-message.show { opacity: 1; transform: translateX(0); }
        .toast-message.error { background-color: var(--danger-color); }
        .toast-message.success { background-color: var(--success-color); }
        .toast-message.warning { background-color: var(--warning-color); color: var(--text-color); } /* Warning often has dark text on yellow */
        .toast-message.info { background-color: var(--primary-color); }


        /* General UI Elements */
        .actions-bar {
            margin-bottom: 24px;
            display: flex;
            flex-direction: column; /* Mobile first: buttons stack */
            gap: 12px;
        }
        
        .section-title {
            font-size: 1.125em; /* 18px */ 
            font-weight: 600; 
            margin-top: 32px;
            margin-bottom: 16px; 
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color); 
            color: var(--text-color);
        }
        .empty-state {
            text-align: center; padding: 40px 20px;
            color: var(--text-color-light); 
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius); 
            margin-top: 20px;
            background-color: var(--card-bg-color); /* To stand out slightly from page bg */
        }
        .empty-state .icon { /* For placeholder icon */
            font-size: 3em; 
            margin-bottom: 16px; 
            color: var(--border-color); /* Very subtle icon color */
            display: block;
        }
        .empty-state p { font-size: 1.05em; margin-bottom: 15px; }


        /* Screen 1: Project Cards specific */
        .project-card-actions { /* Overrides .card-actions for project cards */
            display: flex;
            gap: 8px; /* Tighter gap for smaller action buttons */
            padding: 0 16px 16px;
        }
        .project-card-actions .button {
            flex: 1; /* Make buttons share space */
        }
        .project-card-actions .button-icon-only {
            flex: 0 0 auto; /* Don't let icon-only button grow */
        }


        /* Screen 2: Project Videos - Layout */
        .video-entry-header {
            padding: 16px;
            display: flex;
            flex-direction: column; /* Mobile first */
            gap: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        .video-entry-title-block {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .video-entry-title {
            font-size: 1.125em; /* 18px */
            font-weight: 600;
            color: var(--text-color);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-grow: 1;
        }
        .video-card-number {
            font-weight: 500;
            color: var(--text-color-light);
            font-size: 0.9em;
        }
        .video-entry-actions {
            display: flex;
            align-items: center;
            gap: 8px; 
            width: 100%; /* Mobile: full width */
            justify-content: space-between; /* Distribute buttons */
        }
        .btn-toggle-important .icon { 
            font-size: 1.3em; /* Make star icon a bit bigger */
            transition: color 0.2s, transform 0.2s;
        }
        .btn-toggle-important.is-important .icon { 
            color: var(--warning-color);
            transform: scale(1.1);
        }

        /* Player Area on Card - Screen 2 */
        .main-video-preview-area {
            background-color: #000; 
            position: relative;
            min-height: 200px; /* Mobile first aspect ratio */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; 
        }
        .main-video-thumbnail {
            width: 100%; 
            height: 100%; /* Make it fill the container */
            object-fit: cover; /* Cover for better aesthetics if aspect mismatches */
            cursor: pointer;
            display: block; 
            transition: opacity 0.3s;
        }
        .main-video-thumbnail.hidden { display: none; }

        .play-main-video-preview-btn { 
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px; 
            height: 60px;
            background: rgba(30, 30, 30, 0.7);
            border-radius: 50%;
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            z-index: 10; 
            box-shadow: var(--shadow-md);
        }
        .play-main-video-preview-btn .icon { width: 28px; height: 28px; }
        .play-main-video-preview-btn:hover { background: rgba(0,0,0,0.85); transform: translate(-50%,-50%) scale(1.05); }
        .play-main-video-preview-btn.hidden { display: none; }

        .main-video-preview-player { 
            width: 100%;
            display: block;
            max-height: 400px; /* Max height on larger screens */
            background-color: #000;
        }
        .main-video-preview-player.hidden { display: none; }

        /* Custom Controls for Main Player on Card - Screen 2 (Integrated Overlay) */
        .main-player-custom-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 20;
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            align-items: center;
            gap: 6px; 
            padding: 8px 12px; 
            background-image: linear-gradient(to top, rgba(0,0,0,0.7), rgba(0,0,0,0)); /* Gradient background */
            color: white;
            opacity: 0; /* Hidden by default */
            transition: opacity 0.3s ease;
        }
        .main-video-preview-area:hover .main-player-custom-controls,
        .main-player-custom-controls.visible { /* Add .visible class when playing */
            opacity: 1;
        }
        .main-player-ctrl-btn {
            background: none;
            border: none;
            color: white;
            padding: 6px; 
            cursor: pointer;
            line-height: 1;
            border-radius: var(--border-radius-small);
            transition: background-color 0.2s;
        }
        .main-player-ctrl-btn .icon { width: 20px; height: 20px; }
        .main-player-ctrl-btn:hover { background-color: rgba(255,255,255,0.2); }

        .main-player-progress-bar-container {
            flex-grow: 1;
            height: 6px; /* Slimmer bar */
            background-color: rgba(255,255,255,0.3);
            border-radius: 3px;
            cursor: pointer;
            margin: 0 8px;
            position: relative; 
            order: 1; /* Mobile: progress bar below buttons if wrapped */
            width: 100%; /* Mobile: full width if wrapped */
            margin-top: 8px; /* Mobile: space if wrapped */
        }
        .main-player-progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 3px;
            width: 0%;
        }
        .main-player-timecode {
            font-size: 0.8125em; /* 13px */
            color: white;
            font-family: monospace;
            min-width: 90px; 
            text-align: right;
            padding-left: 5px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5); /* Better readability */
            order: 2; /* Mobile: after progress bar if wrapped */
        }
        
        .main-video-preview-prompt { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background-color: rgba(0,0,0,0.9); color: white; padding: 20px; text-align: center;
            z-index: 30; 
        }
        .main-video-preview-prompt.hidden { display: none; }
        .main-video-preview-prompt p { margin-bottom: 15px; font-size: 0.95em; line-height: 1.4; }


        /* Scrollable Logged Clips List - Screen 2 */
        .video-clips-list-container {
            padding: 16px; 
            background-color: var(--bg-color); /* Slightly different bg for clip list */
            /* min-height controlled by content or explicit style if needed */
            max-height: 400px; /* Max height for scroll */
            overflow-y: auto;
        }
        .video-clips-list-container h4 { 
            font-size: 1em; font-weight: 600; color: var(--text-color);
            margin-bottom: 12px; 
        }
        .clip-item-card {
            display: flex;
            flex-direction: column; /* Mobile first */
            gap: 10px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-small);
            margin-bottom: 12px;
            background-color: var(--card-bg-color);
            box-shadow: var(--shadow-sm);
            transition: box-shadow 0.2s;
        }
        .clip-item-card:hover { box-shadow: var(--shadow-md); }
        .clip-item-card:last-child { margin-bottom: 0; }
        
        .clip-item-thumbnail {
            width: 100%; /* Full width on mobile */
            height: auto;
            aspect-ratio: 16 / 9; /* Maintain aspect ratio */
            max-height: 120px; /* Limit height on mobile */
            background-color: var(--border-color); object-fit: cover;
            border-radius: var(--border-radius-small); flex-shrink: 0;
            margin-bottom: 8px;
        }
        .clip-item-info { flex-grow: 1; min-width:0; }
        .clip-item-info .notes { font-size: 0.9375em; margin-bottom: 6px; font-weight: 500; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .clip-item-info .time, .clip-item-info .keywords, .clip-item-info .rating {
            font-size: 0.8125em; color: var(--text-color-light); margin-bottom: 4px;
        }
        .clip-item-info .keywords span { /* Style individual keywords if needed */
            background-color: var(--bg-color);
            padding: 2px 5px;
            border-radius: var(--border-radius-small);
            margin-right: 4px;
        }
        .clip-item-actions { 
            display: flex; 
            gap: 8px; 
            width: 100%; /* Full width on mobile */
            margin-top: 8px;
        }
        .clip-item-actions .button-small { flex-grow: 1; font-size: 0.8125em; }

        /* Screen 3: Video Logging */
        #video-player-container {
            width: 100%; background-color: black; margin-bottom: 16px;
            position: relative; border-radius: var(--border-radius); overflow:hidden;
            box-shadow: var(--shadow-md);
            min-height: 200px; /* Ensure space for prompt */
        }
        #video-player { width: 100%; display: block; max-height: 50vh;}
        #video-file-prompt {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.9); color: white; padding: 25px; text-align: center;
            border-radius: var(--border-radius); z-index:10;
        }
        #video-file-prompt p { margin-bottom: 15px; line-height: 1.4; font-size: 0.95em;}
        #video-file-prompt strong { color: var(--secondary-color); }
        
        .video-controls { /* Styles for Screen 3 controls */
            display: flex;
            flex-direction: column; /* Mobile first */
            align-items: stretch;
            gap: 12px;
            margin-bottom: 20px;
            padding: 12px;
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
        }
        .video-controls .main-controls { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%;}
        .video-controls .button .icon { width: 20px; height: 20px; }
        .video-controls .timecode-display { font-family: monospace; font-size: 1em; color: var(--text-color); text-align: center; }
        .video-controls .speed-control-group { display: flex; align-items: center; width: 100%; }
        .video-controls .speed-control-group select { 
            width: 100%; 
            padding: 10px 12px; 
            border: 1px solid var(--border-color); 
            border-radius: var(--border-radius-small);
            background-color: var(--card-bg-color);
            font-size: 0.9375em;
        }
        .video-controls .speed-control-group select:focus {
            border-color: var(--primary-color);
            box-shadow: var(--input-focus-ring);
            outline: none;
        }
        
        #timeline-container {
            width: 100%; height: 10px; background-color: #CFD8DC; /* Lighter grey */
            cursor: pointer;
            border-radius: 5px; margin-bottom: 8px; overflow: hidden;
            touch-action: pan-y;
        }
        #timeline-progress { height: 100%; background-color: var(--primary-color); border-radius: 5px; }
        
        .mark-buttons { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        
        .star-rating { display: flex; gap: 8px; cursor: pointer; margin-bottom: 10px; justify-content: center; /* Center stars */ }
        .star-rating .star { 
            background: none; border: none; padding: 0; 
            font-size: 2.2em; /* Larger stars */
            color: var(--border-color); 
            line-height: 1; cursor: pointer; 
            transition: color 0.2s, transform 0.1s;
        }
        .star-rating .star.selected, 
        .star-rating:hover .star:hover, /* Hover effect on individual stars within a hovered group */
        .star-rating .star:focus-visible { 
            color: var(--warning-color); 
        }
        .star-rating .star:hover { transform: scale(1.1); }
        .star-rating .star:focus-visible { outline: 2px solid var(--primary-color); outline-offset: 2px; border-radius: 2px; } /* Custom focus */
        
        .log-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .log-item-time { font-weight: 600; font-size: 0.9375em; color: var(--text-color); }
        .log-item-notes { margin-bottom: 8px; font-size:1em; color: var(--text-color-light); line-height: 1.5; }
        .log-item-keywords { font-size: 0.875em; color: var(--text-color-very-light); margin-bottom: 8px; }
        .log-item-keywords span { /* Style individual keywords */
            background-color: var(--bg-color);
            padding: 2px 6px;
            border-radius: var(--border-radius-small);
            margin-right: 5px;
            display: inline-block;
            margin-bottom: 4px; /* for wrapping */
        }
        .log-item-rating .star-display { font-size: 0.875em; color: var(--warning-color); } /* For displaying stars, not interactive ones */
        .log-item img { 
            max-width:120px; max-height:75px; /* Slightly larger */
            border-radius: var(--border-radius-small); margin-top:10px; 
            border:1px solid var(--border-color); 
            object-fit: cover;
        }

        .file-input-label { /* Wrapper for file input, styled as a button */
            /* Use .button styles */
        }
        input[type="file"] { display: none; }
        
        .hidden { display: none !important; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }

        .mt-1 { margin-top: 10px; }
        .mb-1 { margin-bottom: 10px; }


        /* Medium screens and up (Tablet) */
        @media (min-width: 640px) {
            .container { padding: 24px 20px; }
            .app-header h1 { font-size: 1.75em; }
            .header-with-back h2 { font-size: 1.4em; }

            .actions-bar {
                flex-direction: row; /* Buttons side-by-side */
                justify-content: flex-start;
            }
            .actions-bar .button { width: auto; /* Allow buttons to size to content */ }

            .video-entry-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
            .video-entry-actions { width: auto; /* Don't take full width */ }

            .clip-item-card {
                flex-direction: row; /* Clips side-by-side */
                align-items: flex-start; /* Align top */
            }
            .clip-item-thumbnail {
                width: 120px; /* Fixed width for thumbnail */
                height: 75px;
                margin-bottom: 0;
                margin-right: 12px;
            }
            .clip-item-actions { width: auto; flex-direction: column; align-items: flex-end; margin-top: 0; }
            .clip-item-actions .button-small { flex-grow: 0; width: 100%; /* Stack buttons in column */ }
            .clip-item-actions .button-small + .button-small { margin-left: 0; margin-top: 5px; }


            .video-controls { /* Screen 3 */
                flex-direction: row;
                align-items: center;
                gap: 15px;
            }
            .video-controls .main-controls { width: auto; margin-bottom: 0; }
            .video-controls .timecode-display { margin-bottom: 0; flex-grow: 1; text-align: center; }
            .video-controls .speed-control-group { width: auto; }
            .video-controls .speed-control-group select { width: auto; min-width: 90px; }

            .mark-buttons { flex-direction: row; }

            .main-player-progress-bar-container { order: 0; width: auto; margin-top: 0; }
            .main-player-timecode { order: 0; }
        }

        /* Large screens and up (Desktop) */
        @media (min-width: 768px) {
            .main-video-preview-area { min-height: 250px; }
            .video-entry-card { display: flex; flex-direction: column; } /* Keep overall column flow */

            /* Consider two-column for Screen 3 if desired, but stick to single for now for simplicity */
        }

    </style>
</head>
<body>
    <div id="app-container">
        <!-- Screen 1: Projects List -->
        <div id="screen-projects" class="screen">
            <header class="app-header">
                <h1>LogReel Pro</h1>
            </header>
            <div class="container">
                <div class="actions-bar">
                    <button id="btn-new-project" class="button button-primary">
                        <span class="icon"><!-- SVG: plus --></span> New Project
                    </button>
                    <label class="button button-secondary">
                        <span class="icon"><!-- SVG: import --></span> Import Projects
                        <input type="file" id="import-projects-input" accept=".json">
                    </label>
                </div>
                <div id="projects-list" aria-live="polite" aria-atomic="true">
                    <!-- Project cards will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Screen 2: Project Videos -->
        <div id="screen-project-videos" class="screen">
            <header class="header-with-back">
                <button id="btn-back-to-projects" class="back-button" aria-label="Back to projects list">
                    <span class="icon"><!-- SVG: arrow-left --></span>
                </button>
                <h2 id="project-name-header">Project Name</h2>
                <div class="header-spacer-right" id="project-videos-header-spacer"></div>
            </header>
            <div class="container">
                <div class="actions-bar">
                    <label class="button button-primary">
                         <span class="icon"><!-- SVG: video-plus --></span> Add Videos
                        <input type="file" id="add-videos-input" multiple accept="video/*">
                    </label>
                    <button id="btn-export-project" class="button button-secondary">
                        <span class="icon"><!-- SVG: export --></span> Export Project
                    </button>
                </div>
                <input type="search" id="project-videos-search" placeholder="Search videos or clips..." aria-label="Search videos and clips">
                
                <div id="project-videos-container" class="project-videos-list-scroll-container" aria-live="polite" aria-atomic="true">
                    <!-- Video Entry Cards will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Screen 3: Video Logging -->
        <div id="screen-video-logging" class="screen">
            <header class="header-with-back">
                <button id="btn-back-to-project-videos" class="back-button" aria-label="Back to project videos">
                     <span class="icon"><!-- SVG: arrow-left --></span>
                </button>
                <h2 id="video-filename-header">Video Filename</h2>
                <div class="header-spacer-right" id="video-logging-header-spacer"></div>
            </header>
            <div class="container">
                <div id="video-player-container">
                    <video id="video-player" playsinline></video> 
                     <div id="video-file-prompt" class="hidden"> 
                        <p id="video-file-prompt-message">Please select the video file.</p>
                        <label class="button button-primary mt-1">
                            <span class="icon"><!-- SVG: folder-open --></span> Select Video File
                            <input type="file" id="video-file-input-logging" accept="video/*">
                        </label>
                    </div>
                </div>

                <div id="timeline-container" class="mb-1" aria-label="Video timeline"><div id="timeline-progress"></div></div>
                
                <div class="video-controls">
                    <div class="main-controls">
                        <button id="rewind-btn" class="button button-subtle button-icon-only" aria-label="Rewind 5 seconds">
                            <span class="icon"><!-- SVG: rewind --></span> 
                        </button>
                        <button id="play-pause-btn" class="button button-subtle button-icon-only" aria-label="Play video">
                            <span class="icon play-icon"><!-- SVG: play --></span> 
                            <span class="icon pause-icon hidden"><!-- SVG: pause --></span> 
                        </button>
                        <button id="forward-btn" class="button button-subtle button-icon-only" aria-label="Forward 5 seconds">
                            <span class="icon"><!-- SVG: fast-forward --></span> 
                        </button>
                    </div>
                    <div id="timecode-display" class="timecode-display" aria-live="off">00:00 / 00:00</div>
                    <div class="speed-control-group">
                        <label for="speed-select" class="sr-only">Playback Speed:</label>
                        <select id="speed-select" aria-label="Playback speed">
                            <option value="0.5">0.5x</option><option value="0.75">0.75x</option>
                            <option value="1" selected>1x Normal</option>
                            <option value="1.25">1.25x</option><option value="1.5">1.5x</option>
                            <option value="2">2x</option><option value="2.5">2.5x</option><option value="3">3x</option>
                        </select>
                    </div>
                </div>

                <div class="mark-buttons">
                    <button id="mark-in-btn" class="button button-secondary">
                        <span class="icon"><!-- SVG: mark-in --></span> Mark In (00:00.0)
                    </button>
                    <button id="mark-out-btn" class="button button-secondary">
                        <span class="icon"><!-- SVG: mark-out --></span> Mark Out (00:00.0)
                    </button>
                </div>

                <article class="card">
                    <div class="card-content-padding">
                        <h3 class="card-title" style="margin-bottom: 16px;">Log Entry</h3>
                        <div class="form-group">
                            <label for="log-notes">Notes:</label>
                            <textarea id="log-notes"></textarea>
                        </div>
                        <div class="form-group">
                            <label id="rating-label">Rating:</label>
                            <div id="log-rating" class="star-rating" role="group" aria-labelledby="rating-label">
                                <button type="button" class="star" data-value="1" aria-label="Rate 1 star" aria-pressed="false"><span class="icon star-icon-empty"><!-- SVG: star-empty --></span><span class="icon star-icon-filled hidden"><!-- SVG: star-filled --></span></button>
                                <button type="button" class="star" data-value="2" aria-label="Rate 2 stars" aria-pressed="false"><span class="icon star-icon-empty"><!-- SVG: star-empty --></span><span class="icon star-icon-filled hidden"><!-- SVG: star-filled --></span></button>
                                <button type="button" class="star" data-value="3" aria-label="Rate 3 stars" aria-pressed="false"><span class="icon star-icon-empty"><!-- SVG: star-empty --></span><span class="icon star-icon-filled hidden"><!-- SVG: star-filled --></span></button>
                                <button type="button" class="star" data-value="4" aria-label="Rate 4 stars" aria-pressed="false"><span class="icon star-icon-empty"><!-- SVG: star-empty --></span><span class="icon star-icon-filled hidden"><!-- SVG: star-filled --></span></button>
                                <button type="button" class="star" data-value="5" aria-label="Rate 5 stars" aria-pressed="false"><span class="icon star-icon-empty"><!-- SVG: star-empty --></span><span class="icon star-icon-filled hidden"><!-- SVG: star-filled --></span></button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="log-keywords-input">Keywords:</label>
                            <div id="log-keywords-container" class="tag-input-container" tabindex="0">
                                <!-- Tags will be rendered here by JS -->
                                <input type="text" id="log-keywords-input" placeholder="Add keywords...">
                            </div>
                        </div>
                    </div>
                    <div class="card-actions" style="padding-top:0;">
                         <button id="save-log-btn" class="button button-primary button-full-width">
                            <span class="icon"><!-- SVG: save --></span> <span class="btn-text">Save Log</span>
                         </button>
                    </div>
                    <input type="hidden" id="editing-log-id"> 
                </article>

                <h3 class="section-title">Saved Logs for this Video</h3>
                <div id="saved-logs-list" class="saved-logs-list-scroll-container" aria-live="polite" aria-atomic="true">
                    <!-- Saved logs will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="modal-new-project" class="modal" role="dialog" aria-labelledby="modal-new-project-title" aria-modal="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="modal-new-project-title">Create New Project</h3>
                    <button class="close-button" data-modal-id="modal-new-project" aria-label="Close new project dialog">
                        <span class="icon"><!-- SVG: close --></span>
                    </button>
                </div>
                <div class="form-group">
                    <label for="new-project-name">Project Name:</label>
                    <input type="text" id="new-project-name">
                </div>
                <div class="modal-actions">
                    <button class="button button-subtle" data-modal-id="modal-new-project">Cancel</button>
                    <button id="btn-create-project-confirm" class="button button-primary">
                        <span class="icon"><!-- SVG: check --></span> Create Project
                    </button>
                </div>
            </div>
        </div>
        
        <div id="modal-rename-project" class="modal" role="dialog" aria-labelledby="modal-rename-project-title" aria-modal="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="modal-rename-project-title">Rename Project</h3>
                    <button class="close-button" data-modal-id="modal-rename-project" aria-label="Close rename project dialog">
                        <span class="icon"><!-- SVG: close --></span>
                    </button>
                </div>
                <input type="hidden" id="rename-project-id">
                <div class="form-group">
                    <label for="rename-project-name">New Project Name:</label>
                    <input type="text" id="rename-project-name">
                </div>
                <div class="modal-actions">
                    <button class="button button-subtle" data-modal-id="modal-rename-project">Cancel</button>
                    <button id="btn-rename-project-confirm" class="button button-primary">
                        <span class="icon"><!-- SVG: check --></span> Save Name
                    </button>
                </div>
            </div>
        </div>

        <div id="modal-confirm-action" class="modal" role="dialog" aria-labelledby="modal-confirm-action-title" aria-modal="true">
            <div class="modal-content">
                 <div class="modal-header">
                    <h3 class="modal-title" id="modal-confirm-action-title">Confirm Action</h3>
                    <button class="close-button" data-modal-id="modal-confirm-action" aria-label="Close confirmation dialog">
                        <span class="icon"><!-- SVG: close --></span>
                    </button>
                </div>
                <p id="confirm-action-message" style="margin-bottom: 20px; font-size: 1.05em; line-height: 1.5;">Are you sure?</p>
                <div class="modal-actions">
                    <button id="btn-confirm-action-cancel" class="button button-subtle">Cancel</button>
                    <button id="btn-confirm-action-confirm" class="button button-danger">Confirm</button>
                </div>
            </div>
        </div>

        <canvas id="thumbnail-canvas" style="display:none;"></canvas>
        <div id="toast-container" aria-live="assertive" aria-atomic="true"></div>
    </div>

    <script>
    // Placeholder for SVG icons. Replace these with actual SVG code.
    // Example: const ICON_PLUS = '<svg viewBox="0 0 24 24">...</svg>';
    const ICONS = {
        PLUS: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',
        IMPORT: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>',
        EDIT: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>',
        TRASH: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>',
        ARROW_LEFT: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>',
        VIDEO_PLUS: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect><path d="M12 17v-4M9 15h6"></path><path d="M22 7l-2.45-2.8A2 2 0 0 0 17.66 3H16"></path></svg>', // Placeholder
        EXPORT: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>',
        FOLDER_OPEN: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>',
        REWIND: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 19 2 12 11 5 11 19"></polygon><polygon points="22 19 13 12 22 5 22 19"></polygon></svg>',
        PLAY: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>',
        PAUSE: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>',
        FAST_FORWARD: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 19 22 12 13 5 13 19"></polygon><polygon points="2 19 11 12 2 5 2 19"></polygon></svg>',
        STOP: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>',
        MARK_IN: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 18V6l-4 3"></path><path d="M10 12h10"></path></svg>', // Placeholder
        MARK_OUT: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 18V6l4 3"></path><path d="M14 12H4"></path></svg>', // Placeholder
        STAR_EMPTY: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>',
        STAR_FILLED: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>',
        SAVE: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>',
        CLOSE: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',
        CHECK: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>',
        CHEVRON_DOWN: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>',
        ALERT_TRIANGLE: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
        INFO: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>',
        STAR_OUTLINE: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>', // Same as STAR_EMPTY for simplicity
        EYE: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>',
        EMPTY_PROJECTS: '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>', // Placeholder
        EMPTY_VIDEOS: '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect><polyline points="17 2 12 7 7 2"></polyline></svg>', // Placeholder
        EMPTY_LOGS: '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>', // Placeholder
    };

    function getIcon(iconName) {
        return ICONS[iconName.toUpperCase()] || '';
    }
    
    // Function to inject icons after DOM is loaded
    function injectIcons() {
        document.querySelectorAll('.icon').forEach(iconEl => {
            const iconName = Array.from(iconEl.classList).find(cls => cls.startsWith('icon-svg-'))?.replace('icon-svg-', '');
            if (iconName && ICONS[iconName.toUpperCase()]) {
                iconEl.innerHTML = ICONS[iconName.toUpperCase()];
            } else {
                // Fallback for icons not defined in ICONS or for placeholder comments
                const placeholderComment = Array.from(iconEl.childNodes).find(node => node.nodeType === Node.COMMENT_NODE && node.textContent.startsWith(' SVG: '));
                if (placeholderComment) {
                    const svgName = placeholderComment.textContent.replace(' SVG: ', '').trim().toUpperCase();
                    if (ICONS[svgName]) {
                        iconEl.innerHTML = ICONS[svgName];
                    }
                }
            }
        });
        // Special handling for play/pause toggle icons
        const playPauseBtn = document.getElementById('play-pause-btn');
        if (playPauseBtn) {
            const playIconEl = playPauseBtn.querySelector('.play-icon');
            const pauseIconEl = playPauseBtn.querySelector('.pause-icon');
            if(playIconEl) playIconEl.innerHTML = getIcon('PLAY');
            if(pauseIconEl) pauseIconEl.innerHTML = getIcon('PAUSE');
        }
        // Star icons
        document.querySelectorAll('.star-icon-empty').forEach(el => el.innerHTML = getIcon('STAR_EMPTY'));
        document.querySelectorAll('.star-icon-filled').forEach(el => el.innerHTML = getIcon('STAR_FILLED'));
    }


    const app = {
        data: {
            projects: [],
            currentProjectId: null,
            currentVideoId: null, 
            videoElement: null, 
            timelineProgress: null,
            timelineContainer: null,
            playPauseBtn: null, 
            playIconInBtn: null,
            pauseIconInBtn: null,
            rewindBtn: null, 
            forwardBtn: null, 
            timecodeDisplay: null, 
            speedSelect: null, 
            markInBtn: null,
            markOutBtn: null,
            markInTime: 0,
            markOutTime: null,
            currentRating: 0,
            currentKeywords: [], // For tag input
            videoFileCache: {}, 
            
            activeCardPlayer: {
                videoId: null, cardElement: null, playerElement: null, thumbnailElement: null,
                bigPlayButtonElement: null, promptElement: null, fileInputElement: null, 
                controlsContainerElement: null, playPauseBtnElement: null, rewindBtnElement: null,
                forwardBtnElement: null, progressBarContainerElement: null, progressBarElement: null,
                timecodeElement: null, stopBtnElement: null, isPlaying: false, isScrubbing: false,
                wasPlayingBeforeScrub: false, currentSegment: { startTime: 0, endTime: 0, duration: 0 }, 
                boundPlayerTimeUpdate: null, boundPlayerLoadedMetadata: null, boundPlayerEnded: null,
                boundPlayerError: null, boundPlayerPlay: null, boundPlayerPause: null,
                _boundCardPlayerScrubMove: null, _boundCardPlayerScrubEnd: null,
            },
            previouslyFocusedElement: null,
            skipTimeSeconds: 5, 
            isScrubbing: false, 
            wasPlayingBeforeScrub: false, 
            scrollPositions: {}, // To store scroll positions: {'screenId_entityId': scrollTop}
        },
        dom: {}, 
        idb: { /* IDB logic remains largely the same, ensure it handles errors gracefully */
            db: null, dbName: 'LogReelProFilesDB', storeName: 'videoFiles', version: 1,
            initDB() { /* ... existing code ... */ 
                return new Promise((resolve, reject) => {
                    if (app.idb.db) { resolve(app.idb.db); return; }
                    if (!window.indexedDB) { console.warn("IndexedDB not supported."); reject("IndexedDB not supported"); return; }
                    const request = indexedDB.open(app.idb.dbName, app.idb.version);
                    request.onerror = (event) => { console.error("IndexedDB error:", event.target.error); reject("IndexedDB error: " + event.target.error); };
                    request.onsuccess = (event) => { app.idb.db = event.target.result; console.log("IndexedDB initialized."); resolve(app.idb.db); };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(app.idb.storeName)) {
                            db.createObjectStore(app.idb.storeName, { keyPath: 'videoId' });
                        }
                    };
                });
            },
            storeFile(videoId, file) { /* ... existing code ... */ 
                return new Promise(async (resolve, reject) => {
                    try {
                        if (!app.idb.db) await app.idb.initDB();
                        if (!app.idb.db) { reject("IndexedDB not available for storing file."); return; }
                        const transaction = app.idb.db.transaction([app.idb.storeName], 'readwrite');
                        const store = transaction.objectStore(app.idb.storeName);
                        const request = store.put({ videoId: videoId, file: file });
                        request.onsuccess = () => resolve();
                        request.onerror = (event) => { console.error("Error storing file in IDB:", event.target.error); reject(event.target.error); };
                    } catch (error) { console.error("Exception in storeFile:", error); reject(error); }
                });
            },
            retrieveFile(videoId) { /* ... existing code ... */
                 return new Promise(async (resolve, reject) => {
                    try {
                        if (!app.idb.db) await app.idb.initDB();
                        if (!app.idb.db) { reject("IndexedDB not available for retrieving file."); return; }
                        const transaction = app.idb.db.transaction([app.idb.storeName], 'readonly');
                        const store = transaction.objectStore(app.idb.storeName);
                        const request = store.get(videoId);
                        request.onsuccess = (event) => resolve(event.target.result ? event.target.result.file : null);
                        request.onerror = (event) => { console.error("Error retrieving file from IDB:", event.target.error); reject(event.target.error); };
                    } catch (error) { console.error("Exception in retrieveFile:", error); reject(error); }
                });
            },
            deleteFile(videoId) { /* ... existing code ... */
                return new Promise(async (resolve, reject) => {
                    try {
                        if (!app.idb.db) await app.idb.initDB();
                         if (!app.idb.db) { reject("IndexedDB not available for deleting file."); return; }
                        const transaction = app.idb.db.transaction([app.idb.storeName], 'readwrite');
                        const store = transaction.objectStore(app.idb.storeName);
                        const request = store.delete(videoId);
                        request.onsuccess = () => resolve();
                        request.onerror = (event) => { console.error("Error deleting file from IDB:", event.target.error); reject(event.target.error); };
                    } catch (error) { console.error("Exception in deleteFile:", error); reject(error); }
                });
            }
        },
        utils: { /* Utils remain largely the same */
            generateId() { return Date.now().toString(36) + Math.random().toString(36).substring(2, 9); },
            formatTime(seconds, includeMillis = false) { 
                if (isNaN(seconds) || seconds < 0) return includeMillis ? '00:00.0' : '00:00';
                const h = Math.floor(seconds / 3600); const m = Math.floor((seconds % 3600) / 60);
                const s = Math.floor(seconds % 60); const ms = Math.floor((seconds - Math.floor(seconds)) * 10); 
                let timeStr = ''; if (h > 0) timeStr += `${String(h).padStart(2, '0')}:`;
                timeStr += `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                if (includeMillis) timeStr += `.${ms}`; return timeStr;
            },
            escapeHtml(unsafe) { 
                if (typeof unsafe !== 'string') return String(unsafe);
                return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            }
        },

        init() {
            this.cacheDomElements();
            this.boundHandleTimelineMouseMove = this.handleTimelineMouseMove.bind(this);
            this.boundHandleTimelineMouseUp = this.handleTimelineMouseUp.bind(this);
            this.boundHandleTimelineTouchMove = this.handleTimelineTouchMove.bind(this);
            this.boundHandleTimelineTouchEnd = this.handleTimelineTouchEnd.bind(this);
            
            this.idb.initDB().catch(error => {
                this.showToast("Persistent file storage unavailable. Files may need re-selection.", "warning", 7000, 'ALERT_TRIANGLE');
            });
            this.loadData();
            this.registerEventListeners();
            this.adjustHeaderSpacers(); // Call after DOM is ready and potentially after icons are injected if width depends on them
            this.navigateTo('screen-projects');
            injectIcons(); // Inject SVGs
            console.log("LogReel Pro App Initialized");
        },
        
        // SCROLL POSITION HANDLING
        storeScrollPosition(screenKey) {
            let scrollElement;
            if (screenKey === 'screen-project-videos' && this.dom.projectVideosContainer) {
                scrollElement = this.dom.projectVideosContainer;
            } else if (screenKey === 'screen-video-logging' && this.dom.savedLogsListScrollContainer) {
                scrollElement = this.dom.savedLogsListScrollContainer;
            } // Add more specific scroll containers if needed
            
            if (scrollElement) {
                this.data.scrollPositions[screenKey] = scrollElement.scrollTop;
            } else { // Fallback to window scroll if no specific container or for general screens
                this.data.scrollPositions[screenKey] = window.pageYOffset;
            }
        },
        restoreScrollPosition(screenKey) {
            const storedScrollTop = this.data.scrollPositions[screenKey];
            if (typeof storedScrollTop === 'number') {
                requestAnimationFrame(() => { // Ensure content is rendered
                    let scrollElement;
                     if (screenKey === 'screen-project-videos' && this.dom.projectVideosContainer) {
                        scrollElement = this.dom.projectVideosContainer;
                    } else if (screenKey === 'screen-video-logging' && this.dom.savedLogsListScrollContainer) {
                        scrollElement = this.dom.savedLogsListScrollContainer;
                    }

                    if (scrollElement) {
                        scrollElement.scrollTop = storedScrollTop;
                    } else {
                        window.scrollTo(0, storedScrollTop);
                    }
                });
            }
        },


        adjustHeaderSpacers() { /* Remains the same, but ensure buttons exist */
            const adjust = (btnId, spacerId) => {
                const btn = document.getElementById(btnId); const spacer = document.getElementById(spacerId);
                if (btn && spacer) spacer.style.width = `${btn.offsetWidth}px`;
            };
            adjust('btn-back-to-projects', 'project-videos-header-spacer');
            adjust('btn-back-to-project-videos', 'video-logging-header-spacer');
        },

        cacheDomElements() {
            this.dom.screens = {
                'projects': document.getElementById('screen-projects'),
                'project-videos': document.getElementById('screen-project-videos'),
                'video-logging': document.getElementById('screen-video-logging'),
            };
            this.dom.modals = {
                newProject: document.getElementById('modal-new-project'),
                renameProject: document.getElementById('modal-rename-project'), // New modal
                confirmAction: document.getElementById('modal-confirm-action'),
            };
            this.dom.toastContainer = document.getElementById('toast-container');
            this.dom.projectsList = document.getElementById('projects-list');
            this.dom.btnNewProject = document.getElementById('btn-new-project');
            this.dom.importProjectsInput = document.getElementById('import-projects-input');
            
            this.dom.btnBackToProjects = document.getElementById('btn-back-to-projects');
            this.dom.projectNameHeader = document.getElementById('project-name-header');
            this.dom.projectVideosHeaderSpacer = document.getElementById('project-videos-header-spacer'); // Check if still needed with grid
            this.dom.addVideosInput = document.getElementById('add-videos-input');
            this.dom.btnExportProject = document.getElementById('btn-export-project');
            this.dom.projectVideosSearch = document.getElementById('project-videos-search');
            this.dom.projectVideosContainer = document.getElementById('project-videos-container');

            this.dom.btnBackToProjectVideos = document.getElementById('btn-back-to-project-videos');
            this.dom.videoFilenameHeader = document.getElementById('video-filename-header');
            this.dom.videoLoggingHeaderSpacer = document.getElementById('video-logging-header-spacer'); // Check
            this.data.videoElement = document.getElementById('video-player'); 
            this.dom.videoPlayerContainer = document.getElementById('video-player-container'); 
            this.dom.videoFilePrompt = document.getElementById('video-file-prompt');
            this.dom.videoFilePromptMessage = document.getElementById('video-file-prompt-message');
            this.dom.videoFileInputLogging = document.getElementById('video-file-input-logging');
            this.data.timelineContainer = document.getElementById('timeline-container');
            this.data.timelineProgress = document.getElementById('timeline-progress');

            this.data.rewindBtn = document.getElementById('rewind-btn');
            this.data.playPauseBtn = document.getElementById('play-pause-btn');
            this.data.playIconInBtn = this.data.playPauseBtn ? this.data.playPauseBtn.querySelector('.play-icon') : null;
            this.data.pauseIconInBtn = this.data.playPauseBtn ? this.data.playPauseBtn.querySelector('.pause-icon') : null;
            this.data.forwardBtn = document.getElementById('forward-btn');
            this.data.timecodeDisplay = document.getElementById('timecode-display');
            this.data.speedSelect = document.getElementById('speed-select');
            
            this.data.markInBtn = document.getElementById('mark-in-btn');
            this.data.markOutBtn = document.getElementById('mark-out-btn');
            this.dom.logNotes = document.getElementById('log-notes');
            this.dom.logRatingContainer = document.getElementById('log-rating');
            
            // Tag input elements
            this.dom.logKeywordsContainer = document.getElementById('log-keywords-container');
            this.dom.logKeywordsInput = document.getElementById('log-keywords-input');

            this.dom.saveLogBtn = document.getElementById('save-log-btn');
            this.dom.saveLogBtnText = this.dom.saveLogBtn ? this.dom.saveLogBtn.querySelector('.btn-text') : null;
            this.dom.editingLogIdInput = document.getElementById('editing-log-id');
            this.dom.savedLogsList = document.getElementById('saved-logs-list');
            this.dom.savedLogsListScrollContainer = document.querySelector('.saved-logs-list-scroll-container');


            this.dom.thumbnailCanvas = document.getElementById('thumbnail-canvas');

            this.dom.newProjectNameInput = document.getElementById('new-project-name');
            this.dom.btnCreateProjectConfirm = document.getElementById('btn-create-project-confirm');
            
            this.dom.renameProjectIdInput = document.getElementById('rename-project-id');
            this.dom.renameProjectNameInput = document.getElementById('rename-project-name');
            this.dom.btnRenameProjectConfirm = document.getElementById('btn-rename-project-confirm');

            this.dom.confirmActionMessage = document.getElementById('confirm-action-message');
            this.dom.btnConfirmActionCancel = document.getElementById('btn-confirm-action-cancel');
            this.dom.btnConfirmActionConfirm = document.getElementById('btn-confirm-action-confirm');
        },

        navigateTo(screenId, params = {}) {
            const currentScreenKey = this.currentScreen ? `${this.currentScreen}${this.data.currentProjectId ? `-${this.data.currentProjectId}` : ''}${this.data.currentVideoId ? `-${this.data.currentVideoId}` : ''}` : null;
            if (currentScreenKey) {
                this.storeScrollPosition(currentScreenKey);
            }

            const targetScreenKey = screenId.replace('screen-', '');
            Object.values(this.dom.screens).forEach(screen => screen.classList.remove('active'));
            if (this.dom.screens[targetScreenKey]) {
                this.dom.screens[targetScreenKey].classList.add('active');
            } else { // Fallback
                this.dom.screens['projects'].classList.add('active');
                screenId = 'screen-projects';
            }
            this.currentScreen = screenId; // Store the plain screenId
            // Construct a more specific key for restoring scroll
            const newScreenKeyForScroll = `${screenId}${params.projectId ? `-${params.projectId}` : (this.data.currentProjectId ? `-${this.data.currentProjectId}` : '')}${params.videoId ? `-${params.videoId}` : (this.data.currentVideoId ? `-${this.data.currentVideoId}` : '')}`;
            this.restoreScrollPosition(newScreenKeyForScroll);


            if (this.data.activeCardPlayer.playerElement && screenId !== 'screen-project-videos') {
                this.resetActiveCardPlayerUI(false); 
            }
            if (this.data.videoElement) { 
                if (screenId === 'screen-video-logging') {
                    this.data.videoElement.removeAttribute('controls');
                } else { this.data.videoElement.pause(); }
            }

            // Route based on screenId
            switch (screenId) {
                case 'screen-projects': this.renderProjectsScreen(); break;
                case 'screen-project-videos':
                    if (params.projectId) this.data.currentProjectId = params.projectId;
                    else if (!this.data.currentProjectId && this.data.projects.length > 0) this.data.currentProjectId = this.data.projects[0].id;
                    else if (!this.data.currentProjectId) { this.navigateTo('screen-projects'); return; }
                    this.renderProjectVideosScreen();
                    break;
                case 'screen-video-logging':
                    if (params.videoId && params.projectId) {
                        this.data.currentProjectId = params.projectId;
                        this.data.currentVideoId = params.videoId;
                    } else if (!this.data.currentProjectId || !this.data.currentVideoId) {
                        const targetProjId = this.data.currentProjectId || (this.data.projects.length > 0 ? this.data.projects[0].id : null);
                        if(targetProjId) this.navigateTo('screen-project-videos', { projectId: targetProjId });
                        else this.navigateTo('screen-projects');
                        return;
                    }
                    this.renderVideoLoggingScreen(); 
                    if(params.logIdToEdit) this.editLogEntry(params.logIdToEdit, true);
                    break;
            }
             this.adjustHeaderSpacers(); // Re-adjust if back button visibility changes or content shifts
        },

        loadData() { /* Same, but ensure default fields are set for older data */
            const storedData = localStorage.getItem('logReelProData'); // New key
            if (storedData) {
                try {
                    const parsedData = JSON.parse(storedData);
                    this.data.projects = Array.isArray(parsedData) ? parsedData : [];
                    this.data.projects.forEach(project => {
                        project.videos = project.videos || [];
                        project.videos.forEach(video => {
                            video.isImportant = video.isImportant || false;
                            video.mainVideoThumbnail = video.mainVideoThumbnail || null;
                            video.logs = video.logs || [];
                            video.logs.forEach(log => {
                                log.keywords = log.keywords || []; // Ensure keywords array exists
                            });
                        });
                    });
                } catch (e) {
                    this.showToast("Error loading data. Data might be corrupted.", "error", 5000, 'ALERT_TRIANGLE');
                    this.data.projects = [];
                }
            } else { this.data.projects = []; }
        },
        saveData() { 
            try { localStorage.setItem('logReelProData', JSON.stringify(this.data.projects)); } // New key
            catch (e) { this.showToast("Could not save data. Storage full or disabled?", "error", 5000, 'ALERT_TRIANGLE');}
        },
        getProjectById(projectId) { return this.data.projects.find(p => p.id === projectId); },
        getVideoById(projectId, videoId) { 
            const project = this.getProjectById(projectId);
            return project ? project.videos.find(v => v.id === videoId) : null;
        },
        getLogById(projectId, videoId, logId) { 
            const video = this.getVideoById(projectId, videoId);
            return video && video.logs ? video.logs.find(l => l.id === logId) : null;
        },

        registerEventListeners() {
            // Screen 1
            this.dom.btnNewProject.addEventListener('click', () => this.showNewProjectModal());
            this.dom.importProjectsInput.addEventListener('change', (e) => this.importProjects(e));
            this.dom.btnCreateProjectConfirm.addEventListener('click', () => this.createNewProject());
            
            // Rename Project Modal
            this.dom.btnRenameProjectConfirm.addEventListener('click', () => this.confirmRenameProject());


            // Screen 2
            this.dom.btnBackToProjects.addEventListener('click', () => this.navigateTo('screen-projects'));
            this.dom.addVideosInput.addEventListener('change', (e) => this.handleAddVideos(e.target.files)); 
            this.dom.btnExportProject.addEventListener('click', () => this.exportCurrentProject());
            this.dom.projectVideosSearch.addEventListener('input', (e) => this.renderProjectVideosScreen(e.target.value.trim()));
            this.dom.projectVideosContainer.addEventListener('click', (e) => { // Delegated events for video cards
                const targetButton = e.target.closest('button');
                if (!targetButton) return;
                const videoEntryCard = targetButton.closest('article.video-entry-card');
                if (!videoEntryCard) return; 
                const videoId = videoEntryCard.dataset.videoId;

                if (targetButton.classList.contains('btn-log-full-video')) {
                    this.navigateTo('screen-video-logging', { projectId: this.data.currentProjectId, videoId: videoId });
                } else if (targetButton.classList.contains('btn-delete-this-video')) {
                    this.confirmDeleteVideo(videoId);
                } else if (targetButton.classList.contains('btn-toggle-important')) {
                    this.toggleVideoImportance(videoId);
                } else if (targetButton.classList.contains('btn-play-clip-on-card')) { 
                    const logId = targetButton.dataset.logId;
                    const logData = this.getLogById(this.data.currentProjectId, videoId, logId);
                    if (logData) this.playVideoOnCard(videoId, videoEntryCard, { startTime: logData.markIn, endTime: logData.markOut });
                } else if (targetButton.classList.contains('btn-edit-this-clip')) {
                    const logId = targetButton.dataset.logId;
                    this.navigateTo('screen-video-logging', { projectId: this.data.currentProjectId, videoId: videoId, logIdToEdit: logId });
                } else if (targetButton.classList.contains('btn-delete-this-log-item')) {
                     const logId = targetButton.dataset.logId;
                     this.confirmDeleteLogItemFromScreen2(videoId, logId);
                } else if (targetButton.classList.contains('play-main-video-preview-btn')) { 
                    this.playVideoOnCard(videoId, videoEntryCard); 
                } else if (targetButton.classList.contains('main-player-play-pause-btn')) {
                    this.toggleCardPlayerPlayPause();
                } else if (targetButton.classList.contains('main-player-rewind-btn')) {
                    this.rewindCardPlayer();
                } else if (targetButton.classList.contains('main-player-forward-btn')) {
                    this.forwardCardPlayer();
                } else if (targetButton.classList.contains('main-player-stop-btn')) {
                    this.stopAndResetCardPlayer();
                }
            });
            this.dom.projectVideosContainer.addEventListener('mousedown', (e) => { 
                if (e.target.closest('.main-player-progress-bar-container')) this.handleCardPlayerProgressBarMouseDown(e);
            });
            this.dom.projectVideosContainer.addEventListener('touchstart', (e) => { 
                if (e.target.closest('.main-player-progress-bar-container')) this.handleCardPlayerProgressBarTouchStart(e);
            }, { passive: false });
            this.dom.projectVideosContainer.addEventListener('change', (e) => {
                if (e.target.classList.contains('main-video-preview-file-input')) {
                    const videoId = e.target.dataset.targetPlayerId; 
                    if (this.data.activeCardPlayer.videoId === videoId) this.handleCardPlayerFileSelection(e.target.files[0], videoId);
                }
            });


            // Screen 3
            this.dom.btnBackToProjectVideos.addEventListener('click', () => this.navigateTo('screen-project-videos', { projectId: this.data.currentProjectId }));
            if(this.data.videoElement) { 
                this.data.rewindBtn.addEventListener('click', () => this.rewindVideo());
                this.data.playPauseBtn.addEventListener('click', () => this.togglePlayPause());
                this.data.forwardBtn.addEventListener('click', () => this.fastForwardVideo());

                this.data.videoElement.addEventListener('play', () => { 
                    if(this.data.playIconInBtn && this.data.pauseIconInBtn && this.currentScreen === 'screen-video-logging') {
                        this.data.playIconInBtn.classList.add('hidden');
                        this.data.pauseIconInBtn.classList.remove('hidden');
                        this.data.playPauseBtn.setAttribute('aria-label', 'Pause video'); 
                    }
                });
                this.data.videoElement.addEventListener('pause', () => { 
                    if(this.data.playIconInBtn && this.data.pauseIconInBtn && this.currentScreen === 'screen-video-logging') {
                        this.data.playIconInBtn.classList.remove('hidden');
                        this.data.pauseIconInBtn.classList.add('hidden');
                        this.data.playPauseBtn.setAttribute('aria-label', 'Play video'); 
                    }
                });
                this.data.videoElement.addEventListener('loadedmetadata', () => { if(this.currentScreen === 'screen-video-logging') this.updateVideoTimes(); });
                this.data.videoElement.addEventListener('timeupdate', () => { if(this.currentScreen === 'screen-video-logging') this.updateVideoTimes(); });
                this.data.videoElement.addEventListener('durationchange', () => { if(this.currentScreen === 'screen-video-logging') this.updateVideoTimes(); });
                this.data.videoElement.addEventListener('error', async (e) => { 
                    if(this.currentScreen !== 'screen-video-logging') return;
                    const videoData = this.getVideoById(this.data.currentProjectId, this.data.currentVideoId);
                    this.showToast(`Error playing ${videoData ? this.utils.escapeHtml(videoData.filename) : 'video'}.`, 'error', 5000, 'ALERT_TRIANGLE');
                    if (videoData) { 
                        const cacheKey = `${this.data.currentProjectId}-${this.data.currentVideoId}`;
                        if(this.data.videoFileCache[cacheKey]) {
                            URL.revokeObjectURL(this.data.videoFileCache[cacheKey]); delete this.data.videoFileCache[cacheKey];
                        }
                        this.promptForVideoFile(videoData.filename);
                    }
                });
            
                this.data.timelineContainer.addEventListener('mousedown', (e) => this.handleTimelineMouseDown(e));
                this.data.timelineContainer.addEventListener('touchstart', (e) => this.handleTimelineTouchStart(e), { passive: false });
                this.data.speedSelect.addEventListener('change', (e) => { if(this.data.videoElement) this.data.videoElement.playbackRate = parseFloat(e.target.value); });
            }
            this.data.markInBtn.addEventListener('click', () => this.setMarkIn());
            this.data.markOutBtn.addEventListener('click', () => this.setMarkOut());
            this.dom.logRatingContainer.addEventListener('click', (e) => this.handleStarRating(e));
            this.dom.saveLogBtn.addEventListener('click', () => this.saveLogEntry()); 
            this.dom.videoFileInputLogging.addEventListener('change', (e) => this.handleVideoFileSelectionForLogging(e.target.files[0])); 
            
            // Tag Input Listeners
            this.dom.logKeywordsContainer.addEventListener('click', () => this.dom.logKeywordsInput.focus());
            this.dom.logKeywordsInput.addEventListener('keydown', (e) => this.handleKeywordInput(e));
            this.dom.logKeywordsInput.addEventListener('blur', () => this.addKeywordFromInput(this.dom.logKeywordsInput.value.trim()));


            // Modals & Global
            document.querySelectorAll('.close-button, .button[data-modal-id]').forEach(btn => {
                btn.addEventListener('click', () => this.hideModal(btn.dataset.modalId || btn.closest('.modal').id));
            });
            this.dom.btnConfirmActionCancel.addEventListener('click', () => this.hideModal('modal-confirm-action')); 
            
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    Object.values(this.dom.modals).forEach(modal => {
                        if (modal.classList.contains('active')) this.hideModal(modal.id);
                    });
                }
                // Keyboard shortcuts for Screen 3
                if (this.currentScreen === 'screen-video-logging' && this.data.videoElement && this.data.videoElement.src && !this.dom.videoFilePrompt.classList.contains('hidden')) {
                    if (document.activeElement !== this.dom.logNotes && document.activeElement !== this.dom.logKeywordsInput) { // Avoid interference with typing
                        switch(e.key.toLowerCase()) {
                            case ' ': e.preventDefault(); this.togglePlayPause(); break;
                            case 'k': e.preventDefault(); this.togglePlayPause(); break;
                            case 'j': e.preventDefault(); this.rewindVideo(); break;
                            case 'l': e.preventDefault(); this.fastForwardVideo(); break;
                            case 'i': e.preventDefault(); this.setMarkIn(); break;
                            case 'o': e.preventDefault(); this.setMarkOut(); break;
                        }
                    }
                }
            });
        },
        
        async getVideoSource(projectId, videoId, videoFilename) { /* Largely same logic */
            const cacheKey = `${projectId}-${videoId}`;
            if (this.data.videoFileCache[cacheKey]) {
                try {
                    const response = await fetch(this.data.videoFileCache[cacheKey]); 
                    if (response.ok) return this.data.videoFileCache[cacheKey];
                    URL.revokeObjectURL(this.data.videoFileCache[cacheKey]); delete this.data.videoFileCache[cacheKey];
                } catch (e) { 
                    if (this.data.videoFileCache[cacheKey]) URL.revokeObjectURL(this.data.videoFileCache[cacheKey]);
                    delete this.data.videoFileCache[cacheKey];
                }
            }
            try {
                const fileFromDB = await this.idb.retrieveFile(videoId);
                if (fileFromDB && fileFromDB.name === videoFilename) {
                    const objectURL = URL.createObjectURL(fileFromDB);
                    this.data.videoFileCache[cacheKey] = objectURL; 
                    return objectURL;
                } else if (fileFromDB && fileFromDB.name !== videoFilename) { /* Mismatch handling could be added */ }
            } catch (error) {
                 if (error !== "IndexedDB not supported" && error !== "IndexedDB not available for retrieving file.") {
                    this.showToast(`Error accessing storage for "${this.utils.escapeHtml(videoFilename)}".`, "warning", 5000, 'ALERT_TRIANGLE');
                 }
            }
            return null;
        },

        renderProjectsScreen() {
            this.dom.projectsList.innerHTML = '';
            if (this.data.projects.length === 0) {
                this.dom.projectsList.innerHTML = `<div class="empty-state">
                    <span class="icon">${getIcon('EMPTY_PROJECTS')}</span>
                    <p>No projects yet.</p>
                    <p>Create one or import projects to get started!</p>
                </div>`;
                return;
            }
            const fragment = document.createDocumentFragment();
            this.data.projects.forEach(project => {
                const card = document.createElement('article');
                card.className = 'card project-card'; // Added .project-card for specific styling
                card.innerHTML = `
                    <div class="card-content-padding">
                        <div class="card-title">${this.utils.escapeHtml(project.name)}</div>
                        <div class="card-meta">
                            ${project.videos ? project.videos.length : 0} video(s) &bull; 
                            Created: ${new Date(project.createdAt).toLocaleDateString()}
                        </div>
                    </div>
                    <div class="project-card-actions">
                        <button class="button button-primary btn-open-project" data-project-id="${project.id}">
                            <span class="icon">${getIcon('FOLDER_OPEN')}</span> Open
                        </button>
                        <button class="button button-subtle button-icon-only btn-rename-project" data-project-id="${project.id}" aria-label="Rename project">
                            <span class="icon">${getIcon('EDIT')}</span>
                        </button>
                        <button class="button button-subtle button-icon-only btn-delete-project" data-project-id="${project.id}" aria-label="Delete project">
                            <span class="icon">${getIcon('TRASH')}</span>
                        </button>
                    </div>
                `;
                fragment.appendChild(card);
            });
            this.dom.projectsList.appendChild(fragment);

            this.dom.projectsList.querySelectorAll('.btn-open-project').forEach(btn => {
                btn.addEventListener('click', (e) => this.navigateTo('screen-project-videos', { projectId: e.currentTarget.dataset.projectId }));
            });
            this.dom.projectsList.querySelectorAll('.btn-rename-project').forEach(btn => {
                btn.addEventListener('click', (e) => this.showRenameProjectModal(e.currentTarget.dataset.projectId));
            });
            this.dom.projectsList.querySelectorAll('.btn-delete-project').forEach(btn => {
                btn.addEventListener('click', (e) => this.confirmDeleteProject(e.currentTarget.dataset.projectId));
            });
        },
        showNewProjectModal() { 
            this.dom.newProjectNameInput.value = '';
            this.showModal('modal-new-project');
            this.dom.newProjectNameInput.focus();
        },
        createNewProject() { 
            const name = this.dom.newProjectNameInput.value.trim();
            if (!name) { this.showToast('Project name cannot be empty.', 'warning', 3000, 'ALERT_TRIANGLE'); return; }
            const newProject = { id: this.utils.generateId(), name: name, videos: [], createdAt: new Date().toISOString() };
            this.data.projects.unshift(newProject);
            this.saveData(); this.renderProjectsScreen(); this.hideModal('modal-new-project');
            this.showToast(`Project "${this.utils.escapeHtml(name)}" created.`, 'success', 3000, 'CHECK');
        },
        showRenameProjectModal(projectId) {
            const project = this.getProjectById(projectId);
            if (!project) return;
            this.dom.renameProjectIdInput.value = projectId;
            this.dom.renameProjectNameInput.value = project.name;
            this.showModal('modal-rename-project');
            this.dom.renameProjectNameInput.focus();
        },
        confirmRenameProject() {
            const projectId = this.dom.renameProjectIdInput.value;
            const newName = this.dom.renameProjectNameInput.value.trim();
            const project = this.getProjectById(projectId);

            if (!project) { this.showToast('Error: Project not found.', 'error', 3000, 'ALERT_TRIANGLE'); return; }
            if (!newName) { this.showToast('Project name cannot be empty.', 'warning', 3000, 'ALERT_TRIANGLE'); return; }

            const oldName = project.name;
            project.name = newName;
            this.saveData();
            this.renderProjectsScreen(); // Re-render projects list
            if (this.data.currentProjectId === projectId && this.currentScreen === 'screen-project-videos') {
                this.dom.projectNameHeader.textContent = this.utils.escapeHtml(newName); // Update header if current project
            }
            this.hideModal('modal-rename-project');
            this.showToast(`Project "${this.utils.escapeHtml(oldName)}" renamed to "${this.utils.escapeHtml(newName)}".`, 'success', 3000, 'CHECK');
        },
        confirmDeleteProject(projectId) { /* ... same, maybe update message style ... */ 
            const project = this.getProjectById(projectId);
            if (!project) return;
            const message = `Delete project "<strong>${this.utils.escapeHtml(project.name)}</strong>"? <br><small>This removes all associated video files from storage and cannot be undone.</small>`;
            this.showConfirmationModal(message, () => this.deleteProject(projectId), null, "Delete Project", "button-danger");
        },
        async deleteProject(projectId){ /* ... same ... */ 
            const project = this.getProjectById(projectId);
            if (project && project.videos) {
                for (const video of project.videos) {
                    const cacheKey = `${projectId}-${video.id}`; 
                    if (this.data.videoFileCache[cacheKey]) {
                         URL.revokeObjectURL(this.data.videoFileCache[cacheKey]); delete this.data.videoFileCache[cacheKey];
                    }
                    try { await this.idb.deleteFile(video.id); } catch (error) { /* handle */ }
                }
            }
            this.data.projects = this.data.projects.filter(p => p.id !== projectId);
            if (this.data.currentProjectId === projectId) { this.data.currentProjectId = null; this.data.currentVideoId = null; }
            this.saveData(); this.renderProjectsScreen();
            if(project) this.showToast(`Project "${this.utils.escapeHtml(project.name)}" deleted.`, 'success', 3000, 'TRASH');
        },
        importProjects(event) { /* ... same, but ensure fields like isImportant, keywords array are handled ... */
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (Array.isArray(importedData) && importedData.every(p => p.id && p.name)) { // Simplified check
                             this.showConfirmationModal(
                                "Add imported projects as <strong>new projects</strong>? IDs will be regenerated. Video files may need re-selection.",
                                () => {
                                    const projectsToAdd = [];
                                    importedData.forEach(importedProject => {
                                        const newProject = JSON.parse(JSON.stringify(importedProject)); // Deep copy
                                        newProject.id = this.utils.generateId();
                                        newProject.createdAt = new Date().toISOString();
                                        newProject.videos = newProject.videos || [];
                                        newProject.videos.forEach(video => {
                                            video.id = this.utils.generateId();
                                            video.createdAt = new Date().toISOString();
                                            video.isImportant = video.isImportant || false;
                                            video.mainVideoThumbnail = video.mainVideoThumbnail || null;
                                            video.logs = video.logs || [];
                                            video.logs.forEach(log => {
                                                log.id = this.utils.generateId();
                                                log.createdAt = new Date().toISOString();
                                                log.keywords = Array.isArray(log.keywords) ? log.keywords : [];
                                            });
                                        });
                                        projectsToAdd.push(newProject);
                                    });
                                    this.data.projects.push(...projectsToAdd);
                                    this.saveData(); this.renderProjectsScreen();
                                    this.showToast(`${projectsToAdd.length} project(s) imported!`, 'success', 5000, 'CHECK');
                                }, null, "Import & Add", "button-primary"
                            );
                        } else { this.showToast('Invalid project file format.', 'error', 3000, 'ALERT_TRIANGLE'); }
                    } catch (error) { this.showToast('Error reading project file.', 'error', 3000, 'ALERT_TRIANGLE'); console.error("Import error:", error); }
                };
                reader.readAsText(file); event.target.value = null; 
            }
         },
        exportCurrentProject() { /* ... same ... */ 
            const project = this.getProjectById(this.data.currentProjectId);
            if (!project) { this.showToast("No project to export.", "warning", 3000, 'ALERT_TRIANGLE'); return; }
            const projectToExport = JSON.parse(JSON.stringify(project)); 
            projectToExport.videos.forEach(video => { delete video.fileURL; }); 
            const dataStr = JSON.stringify([projectToExport], null, 2); 
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `${project.name.replace(/\s+/g, '_')}_LogReel_export.json`;
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri); linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click(); linkElement.remove();
            this.showToast(`Project "${this.utils.escapeHtml(project.name)}" export started.`, 'success', 3000, 'EXPORT');
        },
        
        async renderProjectVideosScreen(searchTerm = '') {
            const project = this.getProjectById(this.data.currentProjectId);
            if (!project) { this.navigateTo('screen-projects'); return; }

            this.dom.projectNameHeader.textContent = this.utils.escapeHtml(project.name);
            this.dom.projectVideosContainer.innerHTML = '';

            if (this.data.activeCardPlayer.playerElement) this.resetActiveCardPlayerUI(false); 

            let videosToDisplay = project.videos || [];
            let foundItems = false;
            const fragment = document.createDocumentFragment();

            if (videosToDisplay.length === 0 && !searchTerm) {
                this.dom.projectVideosContainer.innerHTML = `<div class="empty-state">
                    <span class="icon">${getIcon('EMPTY_VIDEOS')}</span>
                    <p>No videos in this project yet.</p><p>Click "Add Videos" to begin.</p>
                </div>`;
                return;
            }
            
            videosToDisplay.forEach((video, index) => {
                let videoMatchesSearch = false;
                let clipsToDisplay = video.logs || [];

                if (searchTerm) {
                    const lowerSearchTerm = searchTerm.toLowerCase();
                    if (video.filename.toLowerCase().includes(lowerSearchTerm)) videoMatchesSearch = true;
                    clipsToDisplay = clipsToDisplay.filter(log =>
                        log.notes.toLowerCase().includes(lowerSearchTerm) ||
                        (log.keywords && log.keywords.some(k => k.toLowerCase().includes(lowerSearchTerm)))
                    );
                    if (!videoMatchesSearch && clipsToDisplay.length === 0) return; 
                }
                foundItems = true;

                const videoCard = document.createElement('article');
                videoCard.className = 'video-entry-card';
                videoCard.dataset.videoId = video.id;

                let clipsHtml = '';
                if (clipsToDisplay.length > 0) {
                    clipsToDisplay.sort((a,b) => a.markIn - b.markIn).forEach(log => {
                        const ratingStars = Array(log.rating).fill(0).map(() => `<span class="star-display">${getIcon('STAR_FILLED')}</span>`).join('') +
                                          Array(5 - log.rating).fill(0).map(() => `<span class="star-display" style="color:var(--border-color);">${getIcon('STAR_EMPTY')}</span>`).join('');
                        const keywordsString = log.keywords && log.keywords.length > 0 ? 
                            log.keywords.map(k => `<span>${this.utils.escapeHtml(k)}</span>`).join('') : 'None';

                        clipsHtml += `
                            <div class="clip-item-card">
                                <img src="${log.thumbnail || 'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=='}" alt="Clip thumbnail" class="clip-item-thumbnail">
                                <div class="clip-item-info">
                                    <p class="notes">${this.utils.escapeHtml(log.notes)}</p>
                                    <p class="time">Time: ${this.utils.formatTime(log.markIn)} - ${this.utils.formatTime(log.markOut)}</p>
                                    <p class="rating">Rating: ${ratingStars}</p>
                                    <p class="keywords">Keywords: ${keywordsString}</p>
                                </div>
                                <div class="clip-item-actions">
                                    <button class="button button-primary button-small btn-play-clip-on-card" data-log-id="${log.id}"><span class="icon">${getIcon('PLAY')}</span>Play</button>
                                    <button class="button button-subtle button-small btn-edit-this-clip" data-log-id="${log.id}"><span class="icon">${getIcon('EDIT')}</span>Edit</button>
                                    <button class="button button-subtle button-small btn-delete-this-log-item" data-log-id="${log.id}"><span class="icon">${getIcon('TRASH')}</span>Del</button>
                                </div>
                            </div>
                        `;
                    });
                } else if (searchTerm && videoMatchesSearch) { 
                    clipsHtml = '<p style="padding: 10px 0; text-align:center; color: var(--text-color-light); font-size:0.9em;">No logged clips match search.</p>';
                } else if (!searchTerm) {
                     clipsHtml = `<div class="empty-state" style="padding: 15px; margin:0; font-size:0.9em; border-style:solid; border-width:1px;">
                        <span class="icon" style="font-size:1.5em; margin-bottom:8px;">${getIcon('EMPTY_LOGS')}</span>
                        <p>No clips logged for this video yet.</p>
                     </div>`;
                }

                const mainThumbnailSrc = video.mainVideoThumbnail || `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 160 90'%3E%3Crect width='160' height='90' fill='%23E5E7EB'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='${getComputedStyle(document.body).fontFamily}' font-size='14px' fill='%236B7280'%3EVideo%3C/text%3E%3C/svg%3E`;

                videoCard.innerHTML = `
                    <div class="video-entry-header">
                        <div class="video-entry-title-block">
                            <span class="video-card-number">${index + 1}.</span>
                            <span class="video-entry-title" title="${this.utils.escapeHtml(video.filename)}">${this.utils.escapeHtml(video.filename)}</span>
                        </div>
                        <div class="video-entry-actions">
                             <button class="button button-subtle button-small btn-toggle-important ${video.isImportant ? 'is-important' : ''}" title="${video.isImportant ? 'Unmark important' : 'Mark important'}" aria-pressed="${video.isImportant}">
                                <span class="icon">${video.isImportant ? getIcon('STAR_FILLED') : getIcon('STAR_OUTLINE')}</span>
                            </button>
                            <button class="button button-secondary button-small btn-log-full-video"><span class="icon">${getIcon('EDIT')}</span> Log Video</button>
                            <button class="button button-subtle button-small btn-delete-this-video"><span class="icon">${getIcon('TRASH')}</span> Delete</button>
                        </div>
                    </div>
                    <div class="main-video-preview-area" id="main-preview-area-${video.id}">
                        <img src="${mainThumbnailSrc}" class="main-video-thumbnail" id="main-thumbnail-${video.id}" alt="Video preview">
                        <button class="play-main-video-preview-btn" id="play-main-preview-btn-${video.id}" aria-label="Play video preview"><span class="icon">${getIcon('PLAY')}</span></button>
                        <video class="main-video-preview-player hidden" id="main-player-${video.id}" playsinline width="100%"></video>
                        <div class="main-video-preview-prompt hidden" id="main-player-prompt-${video.id}">
                            <p id="main-player-prompt-msg-${video.id}">Select video file.</p>
                            <label class="button button-primary button-small mt-1">
                                <span class="icon">${getIcon('FOLDER_OPEN')}</span> Select File
                                <input type="file" class="main-video-preview-file-input" data-target-player-id="${video.id}" accept="video/*">
                            </label>
                        </div>
                         <div class="main-player-custom-controls hidden" id="main-player-controls-${video.id}">
                            <button class="main-player-ctrl-btn main-player-rewind-btn" aria-label="Rewind"><span class="icon">${getIcon('REWIND')}</span></button>
                            <button class="main-player-ctrl-btn main-player-play-pause-btn" aria-label="Play"><span class="icon">${getIcon('PLAY')}</span></button>
                            <button class="main-player-ctrl-btn main-player-forward-btn" aria-label="Forward"><span class="icon">${getIcon('FAST_FORWARD')}</span></button>
                            <div class="main-player-progress-bar-container"><div class="main-player-progress-bar" id="main-player-progress-${video.id}"></div></div>
                            <span class="main-player-timecode" id="main-player-timecode-${video.id}">00:00/00:00</span>
                            <button class="main-player-ctrl-btn main-player-stop-btn" aria-label="Stop"><span class="icon">${getIcon('STOP')}</span></button>
                        </div>
                    </div>
                    ${clipsToDisplay.length > 0 || (searchTerm && videoMatchesSearch) ? `<div class="video-clips-list-container"><h4>Logged Clips (${clipsToDisplay.length})</h4>${clipsHtml}</div>` : (clipsHtml ? `<div class="video-clips-list-container">${clipsHtml}</div>` : '')}
                `;
                fragment.appendChild(videoCard);
            });
            this.dom.projectVideosContainer.appendChild(fragment);
            
            if (!foundItems && searchTerm) {
                 this.dom.projectVideosContainer.innerHTML = `<div class="empty-state"><p>No videos or clips found matching "<strong>${this.utils.escapeHtml(searchTerm)}</strong>".</p></div>`;
            } else if (!foundItems && !searchTerm && videosToDisplay.length > 0) { /* Should be caught by initial empty check */ }
        },

        async handleAddVideos(files) { 
            const project = this.getProjectById(this.data.currentProjectId);
            if (!project) return;
            if (!project.videos) project.videos = [];
            let addedCount = 0;
            const originalButtonText = this.dom.addVideosInput.previousElementSibling.innerHTML; // Assuming label is sibling
            this.dom.addVideosInput.previousElementSibling.innerHTML = `<span class="icon"><!-- SVG: loader --></span> Adding...`;
            this.dom.addVideosInput.disabled = true;

            for (let file of files) {
                if (file.type.startsWith('video/')) {
                    const videoId = this.utils.generateId();
                    let mainThumbnail = null;
                    try { await this.idb.storeFile(videoId, file); } 
                    catch (error) { this.showToast(`Could not save "${this.utils.escapeHtml(file.name)}" for persistence.`, 'warning', 6000, 'ALERT_TRIANGLE'); }

                    const objectURL = URL.createObjectURL(file);
                    this.data.videoFileCache[`${this.data.currentProjectId}-${videoId}`] = objectURL;
                    try {
                        const tempVideoEl = document.createElement('video'); tempVideoEl.muted = true; tempVideoEl.src = objectURL;
                        mainThumbnail = await new Promise((resolve) => {
                            let tId = setTimeout(() => { tempVideoEl.onloadedmetadata = tempVideoEl.onseeked = tempVideoEl.onerror = null; resolve(null); }, 3000); 
                            tempVideoEl.onloadedmetadata = () => { tempVideoEl.currentTime = Math.min(0.5, tempVideoEl.duration / 2); };
                            tempVideoEl.onseeked = async () => { clearTimeout(tId); try { resolve(await this.generateGenericThumbnail(tempVideoEl)); } catch { resolve(null); }};
                            tempVideoEl.onerror = () => { clearTimeout(tId); resolve(null); };
                        });
                    } catch (e) { mainThumbnail = null; }
                    
                    project.videos.push({ 
                        id: videoId, filename: file.name, logs: [], createdAt: new Date().toISOString(),
                        isImportant: false, mainVideoThumbnail: mainThumbnail 
                    });
                    addedCount++;
                } else { this.showToast(`"${this.utils.escapeHtml(file.name)}" is not a video.`, 'warning', 3000, 'ALERT_TRIANGLE'); }
            }
            if(addedCount > 0) {
                this.saveData(); this.renderProjectVideosScreen(); 
                this.showToast(`${addedCount} video(s) added.`, 'success', 3000, 'CHECK');
            }
            this.dom.addVideosInput.previousElementSibling.innerHTML = originalButtonText; // Restore button text
            this.dom.addVideosInput.disabled = false;
            this.dom.addVideosInput.value = null; 
        },
        async generateGenericThumbnail(videoElement) { /* Quality increased to 0.8 */
             return new Promise((resolve, reject) => {
                if (!videoElement || !videoElement.src || videoElement.readyState < videoElement.HAVE_METADATA || videoElement.videoWidth === 0 || videoElement.videoHeight === 0) {
                    return reject("Video not ready for thumbnail.");
                }
                const canvas = this.dom.thumbnailCanvas; const ctx = canvas.getContext('2d');
                const ar = videoElement.videoWidth / videoElement.videoHeight;
                canvas.width = 240; /* Increased base width for better quality */
                canvas.height = canvas.width / ar; if (isNaN(canvas.height) || !isFinite(canvas.height) || canvas.height <= 0) canvas.height = 135; 
                try {
                    ctx.clearRect(0, 0, canvas.width, canvas.height); 
                    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8)); /* Higher quality */
                } catch (e) { reject("Error creating thumbnail data."); }
            });
        },
        confirmDeleteVideo(videoId) { /* ... same, maybe update message style ... */ 
            const video = this.getVideoById(this.data.currentProjectId, videoId);
            if (!video) return;
            const message = `Delete "<strong>${this.utils.escapeHtml(video.filename)}</strong>" and its logs? <br><small>This removes it from storage and cannot be undone.</small>`;
            this.showConfirmationModal(message, () => this.deleteVideo(videoId), null, "Delete Video", "button-danger");
        },
        async deleteVideo(videoId) { /* ... same ... */ 
            const project = this.getProjectById(this.data.currentProjectId);
            if (!project || !project.videos) return;
            const videoIndex = project.videos.findIndex(v => v.id === videoId);
            if (videoIndex === -1) return;
            const videoToDelete = project.videos[videoIndex];
            const cacheKey = `${this.data.currentProjectId}-${videoId}`;

            if (this.data.activeCardPlayer.videoId === videoId) this.resetActiveCardPlayerUI(false); 
            if (this.data.videoFileCache[cacheKey]) { URL.revokeObjectURL(this.data.videoFileCache[cacheKey]); delete this.data.videoFileCache[cacheKey]; }
            try { await this.idb.deleteFile(videoId); } 
            catch (error) { this.showToast(`Could not remove "${this.utils.escapeHtml(videoToDelete.filename)}" from persistent storage.`, 'warning', 7000, 'ALERT_TRIANGLE'); }
            project.videos.splice(videoIndex, 1);
            if (this.data.currentVideoId === videoId) this.data.currentVideoId = null;
            this.saveData(); this.renderProjectVideosScreen();
            if (videoToDelete) this.showToast(`Video "${this.utils.escapeHtml(videoToDelete.filename)}" deleted.`, 'success', 3000, 'TRASH');
        },
        toggleVideoImportance(videoId) { /* ... same, but re-render might need to update icon correctly ... */
            const video = this.getVideoById(this.data.currentProjectId, videoId);
            if (!video) return;
            video.isImportant = !video.isImportant;
            this.saveData();
            // Optimized re-render for just the button:
            const button = this.dom.projectVideosContainer.querySelector(`.video-entry-card[data-video-id="${videoId}"] .btn-toggle-important`);
            if (button) {
                button.classList.toggle('is-important', video.isImportant);
                button.setAttribute('aria-pressed', video.isImportant);
                button.title = video.isImportant ? 'Unmark important' : 'Mark important';
                button.querySelector('.icon').innerHTML = video.isImportant ? getIcon('STAR_FILLED') : getIcon('STAR_OUTLINE');
            } else { this.renderProjectVideosScreen(this.dom.projectVideosSearch.value.trim()); } // Fallback
            this.showToast(`Video "${this.utils.escapeHtml(video.filename)}" marked as ${video.isImportant ? 'important' : 'not important'}.`, 'info', 3000, 'INFO');
        },

        // --- On-Card Player Logic (Screen 2) ---
        // Largely the same, but ensure control visibility logic is smooth (.visible class on controls)
        // Ensure play/pause icon in controls toggles correctly.
        resetActiveCardPlayerUI(findNewPlayerElements = true) {
            const acp = this.data.activeCardPlayer;
            if (acp.playerElement) {
                acp.playerElement.pause(); acp.playerElement.removeAttribute('src'); acp.playerElement.load();
                if (acp.boundPlayerTimeUpdate) acp.playerElement.removeEventListener('timeupdate', acp.boundPlayerTimeUpdate);
                // ... remove other listeners ...
                acp.playerElement.classList.add('hidden');
                if (acp.controlsContainerElement) {
                    acp.controlsContainerElement.classList.add('hidden');
                    acp.controlsContainerElement.classList.remove('visible');
                }
                if (acp.promptElement) acp.promptElement.classList.add('hidden');
                if (acp.thumbnailElement) acp.thumbnailElement.classList.remove('hidden');
                if (acp.bigPlayButtonElement) acp.bigPlayButtonElement.classList.remove('hidden');
                if (acp.timecodeElement) acp.timecodeElement.textContent = '00:00 / 00:00';
                if (acp.progressBarElement) acp.progressBarElement.style.width = '0%';
                const playPauseCtrlBtn = acp.controlsContainerElement?.querySelector('.main-player-play-pause-btn .icon');
                if(playPauseCtrlBtn) playPauseCtrlBtn.innerHTML = getIcon('PLAY');
            }
            this.data.activeCardPlayer = { /* Reset structure */ videoId: null, /* ... */ };
        },
        async playVideoOnCard(videoId, cardElement, segmentData = null) {
            const videoData = this.getVideoById(this.data.currentProjectId, videoId);
            if (!videoData) return;
            if (this.data.activeCardPlayer.videoId && (this.data.activeCardPlayer.videoId !== videoId || (segmentData && this.data.activeCardPlayer.currentSegment.startTime !== segmentData.startTime))) {
                this.resetActiveCardPlayerUI(false); 
            }
            const acp = this.data.activeCardPlayer;
            acp.videoId = videoId; acp.cardElement = cardElement;
            // Query elements (ensure they exist from new HTML structure)
            acp.playerElement = cardElement.querySelector(`#main-player-${videoId}`);
            acp.thumbnailElement = cardElement.querySelector(`#main-thumbnail-${videoId}`);
            acp.bigPlayButtonElement = cardElement.querySelector(`#play-main-preview-btn-${videoId}`);
            acp.promptElement = cardElement.querySelector(`#main-player-prompt-${videoId}`);
            if(acp.promptElement) acp.fileInputElement = acp.promptElement.querySelector('.main-video-preview-file-input');
            acp.controlsContainerElement = cardElement.querySelector(`#main-player-controls-${videoId}`);
            // ... query control buttons inside acp.controlsContainerElement ...
            acp.playPauseBtnElement = acp.controlsContainerElement?.querySelector('.main-player-play-pause-btn');
            acp.progressBarElement = acp.controlsContainerElement?.querySelector('.main-player-progress-bar');
            acp.timecodeElement = acp.controlsContainerElement?.querySelector('.main-player-timecode');


            if(!acp.playerElement || !acp.thumbnailElement || !acp.controlsContainerElement) { /* Error */ return; }

            acp.thumbnailElement.classList.add('hidden');
            acp.bigPlayButtonElement.classList.add('hidden');
            acp.playerElement.classList.remove('hidden');
            acp.controlsContainerElement.classList.remove('hidden');
            acp.controlsContainerElement.classList.add('visible'); // Show controls when playing
            acp.promptElement.classList.add('hidden');

            // Remove old listeners & add new ones (same logic)
            // ...
            acp.boundPlayerPlay = () => { 
                acp.isPlaying = true; 
                if(acp.playPauseBtnElement) { acp.playPauseBtnElement.innerHTML = `<span class="icon">${getIcon('PAUSE')}</span>`; acp.playPauseBtnElement.setAttribute('aria-label', 'Pause');}
                if(acp.controlsContainerElement) acp.controlsContainerElement.classList.add('visible');
            };
            acp.boundPlayerPause = () => { 
                acp.isPlaying = false; 
                if(acp.playPauseBtnElement && !acp.isScrubbing) { acp.playPauseBtnElement.innerHTML = `<span class="icon">${getIcon('PLAY')}</span>`; acp.playPauseBtnElement.setAttribute('aria-label', 'Play');}
                // Don't hide controls immediately on pause, rely on hover out or stop
            };
            // ... add listeners ...

            const videoSrc = await this.getVideoSource(this.data.currentProjectId, videoId, videoData.filename);
            if (videoSrc) {
                if(acp.playerElement.src !== videoSrc) { acp.playerElement.src = videoSrc; acp.playerElement.load(); }
                else { this.handleCardPlayerLoadedMetadata(segmentData);  }
                 acp.playerElement.play().catch(e => { /* Handle error */ this.showCardPlayerPrompt(videoData.filename); });
            } else { this.showCardPlayerPrompt(videoData.filename); }
            const controlsRect = acp.controlsContainerElement.getBoundingClientRect();
            const cardRect = acp.cardElement.getBoundingClientRect();
            if (controlsRect.bottom > window.innerHeight || cardRect.top < 0 ) {
                 acp.cardElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        },
        handleCardPlayerLoadedMetadata(segmentData) { /* ... same ... */ },
        handleCardPlayerTimeUpdate() { /* ... same ... */ },
        handleCardPlayerSegmentEnd() { 
            const acp = this.data.activeCardPlayer;
            acp.isPlaying = false;
            if(acp.playPauseBtnElement) { acp.playPauseBtnElement.innerHTML = `<span class="icon">${getIcon('PLAY')}</span>`; acp.playPauseBtnElement.setAttribute('aria-label', 'Replay'); }
            if(acp.progressBarElement) acp.progressBarElement.style.width = '100%';
            this.updateCardPlayerTimeDisplay(); 
        },
        handleCardPlayerEnded() { /* ... same, ensure play button icon updates ... */
            const acp = this.data.activeCardPlayer;
            acp.isPlaying = false;
            if(acp.playPauseBtnElement) { acp.playPauseBtnElement.innerHTML = `<span class="icon">${getIcon('PLAY')}</span>`; acp.playPauseBtnElement.setAttribute('aria-label', 'Replay');}
            if(acp.progressBarElement) acp.progressBarElement.style.width = '100%';
            if(acp.playerElement) acp.playerElement.currentTime = acp.currentSegment.endTime; 
            this.updateCardPlayerTimeDisplay();
        },
        handleCardPlayerError(filename) { /* ... same ... */ },
        updateCardPlayerTimeDisplay() { /* ... same ... */ },
        toggleCardPlayerPlayPause() { /* ... same, ensure play button icon updates ... */ 
             const acp = this.data.activeCardPlayer;
            if (!acp.playerElement || !acp.playerElement.src) { /*...*/ return; }
            if (acp.isPlaying) acp.playerElement.pause();
            else {
                if (acp.playerElement.currentTime >= acp.currentSegment.endTime - 0.1) acp.playerElement.currentTime = acp.currentSegment.startTime;
                acp.playerElement.play().catch(e => { /*...*/ });
            }
        },
        rewindCardPlayer() { /* ... same ... */ },
        forwardCardPlayer() { /* ... same ... */ },
        stopAndResetCardPlayer() { 
            const acp = this.data.activeCardPlayer;
            if(acp.controlsContainerElement) acp.controlsContainerElement.classList.remove('visible'); // Hide controls
            this.resetActiveCardPlayerUI(true); 
        },
        handleCardPlayerProgressBarMouseDown(event) { /* ... same ... */ },
        handleCardPlayerProgressBarTouchStart(event) { /* ... same ... */ },
        updateCardPlayerProgressBarOnScrub(event) {  /* ... same ... */ },
        showCardPlayerPrompt(videoFilename) {  /* ... same ... */ },
        async handleCardPlayerFileSelection(file, videoIdToMatch) { /* ... same ... */ },
        confirmDeleteLogItemFromScreen2(videoId, logId){ /* ... same ... */ },
        deleteLogItem(videoId, logId) { /* ... same ... */ },


        // --- Screen 3: Video Logging ---
        async renderVideoLoggingScreen() { /* ... same basic flow ... */ 
            const videoData = this.getVideoById(this.data.currentProjectId, this.data.currentVideoId);
            if (!videoData) { this.navigateTo('screen-project-videos', { projectId: this.data.currentProjectId }); this.showToast("Video not found.", "error", 3000, 'ALERT_TRIANGLE'); return; }
            this.dom.videoFilenameHeader.textContent = this.utils.escapeHtml(videoData.filename);
            this.resetLogForm(); this.renderSavedLogsList();
            
            this.data.videoElement.pause(); this.data.videoElement.removeAttribute('src'); this.data.videoElement.load(); 
            if(this.data.playIconInBtn && this.data.pauseIconInBtn) {
                this.data.playIconInBtn.classList.remove('hidden'); this.data.pauseIconInBtn.classList.add('hidden');
                this.data.playPauseBtn.setAttribute('aria-label', 'Play video');
            }
            this.updateVideoTimes(); 
            
            this.dom.videoPlayerContainer.classList.remove('hidden'); 
            this.dom.videoFilePrompt.classList.add('hidden'); 
            this.data.videoElement.classList.add('hidden'); 
            this.data.videoElement.removeAttribute('controls');

            const videoSrc = await this.getVideoSource(this.data.currentProjectId, this.data.currentVideoId, videoData.filename);
            if (videoSrc) {
                this.data.videoElement.src = videoSrc; this.data.videoElement.classList.remove('hidden'); 
            } else { this.promptForVideoFile(videoData.filename); }
        },
        promptForVideoFile(filename) { /* ... same ... */ },
        async handleVideoFileSelectionForLogging(file) { /* ... same ... */ },
        updateVideoTimes() { /* ... same ... */ },
        async togglePlayPause() { /* ... same, ensure play button icon updates ... */ 
             if (!this.data.videoElement.src || !this.dom.videoFilePrompt.classList.contains('hidden')) { /* ... */ return; }
            if (this.data.videoElement.paused || this.data.videoElement.ended) { 
                try { await this.data.videoElement.play(); } catch (e) { /* ... */ }
            } else { this.data.videoElement.pause(); }
        },
        rewindVideo() { /* ... same ... */ },
        fastForwardVideo() { /* ... same ... */ },
        handleTimelineMouseDown(event) { /* ... same ... */ }, handleTimelineMouseMove(event) { /* ... same ... */ }, handleTimelineMouseUp(event) { /* ... same ... */ },
        handleTimelineTouchStart(event) { /* ... same ... */ }, handleTimelineTouchMove(event) { /* ... same ... */ }, handleTimelineTouchEnd(event) { /* ... same ... */ },
        updateTimelineOnScrub(event) { /* ... same ... */ },
        setMarkIn() { /* ... same, styling might change slightly if icons are in buttons ... */ 
            if (!this.data.videoElement.src || !this.dom.videoFilePrompt.classList.contains('hidden')) { this.showToast("Load video first.", "warning", 3000, 'ALERT_TRIANGLE'); return; }
            this.data.markInTime = this.data.videoElement.currentTime;
            this.data.markInBtn.innerHTML = `<span class="icon">${getIcon('MARK_IN')}</span> Mark In (${this.utils.formatTime(this.data.markInTime, true)})`;
            this.data.markInBtn.classList.remove('default-mark', 'button-secondary'); this.data.markInBtn.classList.add('button-primary'); 
            setTimeout(() => { this.data.markInBtn.classList.remove('button-primary'); this.data.markInBtn.classList.add('button-secondary');}, 1000);
            if (this.data.markOutTime !== null && this.data.markOutTime < this.data.markInTime) {
                this.data.markOutTime = null; this.data.markOutBtn.innerHTML = `<span class="icon">${getIcon('MARK_OUT')}</span> Mark Out (${this.utils.formatTime(this.data.videoElement.currentTime, true)})`;
                this.data.markOutBtn.classList.add('default-mark');
            }
        },
        setMarkOut() { /* ... same, styling might change slightly ... */ 
            if (!this.data.videoElement.src || !this.dom.videoFilePrompt.classList.contains('hidden')) { this.showToast("Load video first.", "warning", 3000, 'ALERT_TRIANGLE'); return; }
            const currentTime = this.data.videoElement.currentTime;
            if (currentTime <= this.data.markInTime) { this.showToast("Mark Out time must be after Mark In time.", "warning", 3000, 'ALERT_TRIANGLE'); return; }
            this.data.markOutTime = currentTime;
            this.data.markOutBtn.innerHTML = `<span class="icon">${getIcon('MARK_OUT')}</span> Mark Out (${this.utils.formatTime(this.data.markOutTime, true)})`;
            this.data.markOutBtn.classList.remove('default-mark', 'button-secondary'); this.data.markOutBtn.classList.add('button-primary');
            setTimeout(() => { this.data.markOutBtn.classList.remove('button-primary'); this.data.markOutBtn.classList.add('button-secondary'); }, 1000);
        },
        handleStarRating(event) { 
            const starButton = event.target.closest('button.star');
            if (starButton) { 
                this.data.currentRating = parseInt(starButton.dataset.value); 
                this.updateStarDisplay(); 
            }
        },
        updateStarDisplay() { 
            this.dom.logRatingContainer.querySelectorAll('button.star').forEach((star, index) => {
                const selected = (index + 1) <= this.data.currentRating;
                star.classList.toggle('selected', selected);
                star.setAttribute('aria-pressed', selected ? 'true' : 'false');
                star.querySelector('.star-icon-empty').classList.toggle('hidden', selected);
                star.querySelector('.star-icon-filled').classList.toggle('hidden', !selected);
            });
        },
        // Tag Input Logic
        renderKeywords() {
            // Remove all tags except the input field
            Array.from(this.dom.logKeywordsContainer.children).forEach(child => {
                if (child !== this.dom.logKeywordsInput) {
                    this.dom.logKeywordsContainer.removeChild(child);
                }
            });
            this.data.currentKeywords.forEach((keyword, index) => {
                const tagEl = document.createElement('span');
                tagEl.className = 'tag-item';
                tagEl.textContent = this.utils.escapeHtml(keyword);
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-tag-btn';
                removeBtn.setAttribute('aria-label', `Remove keyword ${this.utils.escapeHtml(keyword)}`);
                removeBtn.innerHTML = `<span class="icon">${getIcon('CLOSE')}</span>`;
                removeBtn.onclick = () => {
                    this.data.currentKeywords.splice(index, 1);
                    this.renderKeywords(); // Re-render
                };
                tagEl.appendChild(removeBtn);
                this.dom.logKeywordsContainer.insertBefore(tagEl, this.dom.logKeywordsInput);
            });
            this.dom.logKeywordsInput.value = ''; // Clear input after rendering
        },
        addKeywordFromInput(keyword) {
            keyword = keyword.trim();
            if (keyword && !this.data.currentKeywords.includes(keyword)) {
                this.data.currentKeywords.push(keyword);
                this.renderKeywords();
            }
            this.dom.logKeywordsInput.value = ''; // Always clear after attempt
        },
        handleKeywordInput(event) {
            if (event.key === 'Enter' || event.key === ',') {
                event.preventDefault();
                this.addKeywordFromInput(this.dom.logKeywordsInput.value.trim());
            } else if (event.key === 'Backspace' && this.dom.logKeywordsInput.value === '' && this.data.currentKeywords.length > 0) {
                this.data.currentKeywords.pop(); // Remove last keyword on backspace if input is empty
                this.renderKeywords();
            }
        },
        async saveLogEntry() { 
            const notes = this.dom.logNotes.value.trim();
            // Keywords are now in this.data.currentKeywords
            if (this.data.markOutTime === null || this.data.markOutTime <= this.data.markInTime) { this.showToast("Set valid Mark In/Out times.", "warning", 3000, 'ALERT_TRIANGLE'); return; }
            if (!notes) { this.showToast("Notes cannot be empty.", "warning", 3000, 'ALERT_TRIANGLE'); return; }
            if (this.data.currentRating === 0) { this.showToast("Provide a rating.", "warning", 3000, 'ALERT_TRIANGLE'); return; }
            
            this.dom.saveLogBtn.disabled = true; 
            if (this.dom.saveLogBtnText) this.dom.saveLogBtnText.textContent = 'Saving...';
            
            let thumbnail = null;
            try {
                if (this.data.videoElement.src && this.data.videoElement.readyState >= 2 && this.dom.videoFilePrompt.classList.contains('hidden')) { 
                    thumbnail = await this.generateLogThumbnail(this.data.markInTime); 
                }
            } catch (error) { this.showToast("Could not generate thumbnail.", "warning", 3000, 'ALERT_TRIANGLE');}
            
            const video = this.getVideoById(this.data.currentProjectId, this.data.currentVideoId);
            if (!video) { /* ... error handling ... */ this.dom.saveLogBtn.disabled = false; if (this.dom.saveLogBtnText) this.dom.saveLogBtnText.textContent = 'Save Log'; return; }
            if (!video.logs) video.logs = [];
            
            const editingLogId = this.dom.editingLogIdInput.value;
            const logData = { markIn: this.data.markInTime, markOut: this.data.markOutTime, notes: notes, rating: this.data.currentRating, keywords: [...this.data.currentKeywords], thumbnail: thumbnail };
            
            if (editingLogId) { 
                const log = video.logs.find(l => l.id === editingLogId);
                if (log) Object.assign(log, logData, { updatedAt: new Date().toISOString() }); 
                this.showToast("Log entry updated.", "success", 3000, 'CHECK');
            } else { 
                video.logs.push({ ...logData, id: this.utils.generateId(), createdAt: new Date().toISOString() }); 
                this.showToast("Log entry saved.", "success", 3000, 'CHECK');
            }
            this.saveData(); this.renderSavedLogsList(); this.resetLogForm();
            this.dom.saveLogBtn.disabled = false; 
            if (this.dom.saveLogBtnText) this.dom.saveLogBtnText.textContent = this.dom.editingLogIdInput.value ? 'Update Log' : 'Save Log';
        },
        generateLogThumbnail(time) { /* Quality increased to 0.8 */
            return new Promise((resolve, reject) => {
                if (!this.data.videoElement || !this.data.videoElement.src || this.data.videoElement.readyState < 2 || !this.dom.videoFilePrompt.classList.contains('hidden') || this.data.videoElement.videoWidth === 0) { return reject("Video not ready."); }
                const video = this.data.videoElement; const canvas = this.dom.thumbnailCanvas; const ctx = canvas.getContext('2d');
                const originalTime = video.currentTime; const originalPaused = video.paused; const originalMuted = video.muted; video.muted = true;
                let seekTimeout;
                const cleanup = () => { /* ... same cleanup ... */ };
                const onSeeked = () => {
                    clearTimeout(seekTimeout);
                    const ar = video.videoWidth / video.videoHeight; canvas.width = 160; canvas.height = canvas.width / ar; if (isNaN(canvas.height) || !isFinite(canvas.height) || canvas.height <= 0) canvas.height = 90; 
                    ctx.clearRect(0,0, canvas.width, canvas.height);
                    try { ctx.drawImage(video, 0, 0, canvas.width, canvas.height); resolve(canvas.toDataURL('image/jpeg', 0.8)); } 
                    catch (e) { reject("Err creating thumb."); } finally { cleanup(); }
                };
                const onError = (e) => { cleanup(); reject("Err seek thumb."); };
                video.addEventListener('seeked', onSeeked, { once: true }); video.addEventListener('error', onError, { once: true });
                if (!originalPaused) video.pause(); video.currentTime = time;
                seekTimeout = setTimeout(() => {
                    if (Math.abs(video.currentTime - time) < 0.5 && video.readyState >= video.HAVE_CURRENT_DATA) onSeeked();
                    else onError(new Error("Seek timeout"));
                }, 1500); 
            });
        },
        resetLogForm() { 
            this.dom.logNotes.value = ''; 
            this.data.currentKeywords = []; this.renderKeywords(); // Reset and render tags
            this.data.currentRating = 0; this.updateStarDisplay();
            this.data.markInTime = 0; this.data.markOutTime = null;
            const defaultTime = (this.data.videoElement && this.data.videoElement.src && this.dom.videoFilePrompt.classList.contains('hidden')) ? this.data.videoElement.currentTime : 0;
            this.data.markInBtn.innerHTML = `<span class="icon">${getIcon('MARK_IN')}</span> Mark In (${this.utils.formatTime(defaultTime, true)})`; this.data.markInBtn.classList.add('default-mark');
            this.data.markOutBtn.innerHTML = `<span class="icon">${getIcon('MARK_OUT')}</span> Mark Out (${this.utils.formatTime(defaultTime, true)})`; this.data.markOutBtn.classList.add('default-mark');
            this.dom.editingLogIdInput.value = ''; 
            if (this.dom.saveLogBtnText) this.dom.saveLogBtnText.textContent = 'Save Log';
        },
        renderSavedLogsList() { 
            const video = this.getVideoById(this.data.currentProjectId, this.data.currentVideoId);
            this.dom.savedLogsList.innerHTML = '';
            if (!video || !video.logs || video.logs.length === 0) {
                this.dom.savedLogsList.innerHTML = `<div class="empty-state" style="padding:20px; font-size:0.9em;">
                    <span class="icon">${getIcon('EMPTY_LOGS')}</span>
                    <p>No logs saved for this video yet.</p>
                </div>`;
                return;
            }
            const fragment = document.createDocumentFragment();
            const sortedLogs = [...video.logs].sort((a, b) => a.markIn - b.markIn);
            sortedLogs.forEach(log => {
                const item = document.createElement('article'); 
                item.className = 'log-item'; item.id = `log-item-${log.id}`;
                const ratingStars = Array(log.rating).fill(0).map(() => `<span class="star-display">${getIcon('STAR_FILLED')}</span>`).join('') +
                                  Array(5 - log.rating).fill(0).map(() => `<span class="star-display" style="color:var(--border-color);">${getIcon('STAR_EMPTY')}</span>`).join('');
                const keywordsString = log.keywords && log.keywords.length > 0 ? 
                    log.keywords.map(k => `<span>${this.utils.escapeHtml(k)}</span>`).join('') : 'None';

                item.innerHTML = `
                    <div class="log-item-header">
                        <span class="log-item-time">${this.utils.formatTime(log.markIn)} - ${this.utils.formatTime(log.markOut)}</span>
                        <div class="log-item-rating">${ratingStars}</div>
                    </div>
                    <p class="log-item-notes">${this.utils.escapeHtml(log.notes)}</p>
                    ${log.keywords && log.keywords.length > 0 ? `<p class="log-item-keywords">Keywords: ${keywordsString}</p>` : ''}
                    ${log.thumbnail ? `<img src="${log.thumbnail}" alt="Log thumbnail">` : ''}
                    <div class="card-actions" style="margin-top:10px; padding:0; flex-wrap:nowrap;">
                        <button class="button button-subtle button-small btn-go-to-log-time" data-time="${log.markIn}"><span class="icon">${getIcon('EYE')}</span> Go to</button>
                        <button class="button button-secondary button-small btn-edit-log" data-log-id="${log.id}"><span class="icon">${getIcon('EDIT')}</span> Edit</button>
                        <button class="button button-subtle button-small btn-delete-log" data-log-id="${log.id}"><span class="icon">${getIcon('TRASH')}</span> Delete</button>
                    </div>
                `;
                fragment.appendChild(item);
            });
            this.dom.savedLogsList.appendChild(fragment);

            this.dom.savedLogsList.querySelectorAll('.btn-go-to-log-time').forEach(btn => btn.addEventListener('click', (e) => this.goToLogTime(parseFloat(e.currentTarget.dataset.time))));
            this.dom.savedLogsList.querySelectorAll('.btn-edit-log').forEach(btn => btn.addEventListener('click', (e) => this.editLogEntry(e.currentTarget.dataset.logId)));
            this.dom.savedLogsList.querySelectorAll('.btn-delete-log').forEach(btn => btn.addEventListener('click', (e) => this.confirmDeleteLogOnScreen3(e.currentTarget.dataset.logId)));
        },
        async goToLogTime(time) { /* ... same ... */ },
        editLogEntry(logId, fromNavigation = false) { 
            const log = this.getLogById(this.data.currentProjectId, this.data.currentVideoId, logId);
            if (!log) return;
            this.dom.logNotes.value = log.notes;
            this.data.currentKeywords = Array.isArray(log.keywords) ? [...log.keywords] : []; this.renderKeywords();
            this.data.currentRating = log.rating; this.updateStarDisplay();
            this.data.markInTime = log.markIn; this.data.markOutTime = log.markOut;
            if (this.data.videoElement && this.data.videoElement.src && this.dom.videoFilePrompt.classList.contains('hidden')) { this.data.videoElement.currentTime = log.markIn; }
            this.data.markInBtn.innerHTML = `<span class="icon">${getIcon('MARK_IN')}</span> Mark In (${this.utils.formatTime(log.markIn, true)})`;
            this.data.markOutBtn.innerHTML = `<span class="icon">${getIcon('MARK_OUT')}</span> Mark Out (${this.utils.formatTime(log.markOut, true)})`;
            this.data.markInBtn.classList.remove('default-mark'); this.data.markOutBtn.classList.remove('default-mark');
            this.dom.editingLogIdInput.value = log.id; 
            if (this.dom.saveLogBtnText) this.dom.saveLogBtnText.textContent = 'Update Log';
            this.dom.logNotes.focus();
            const logFormCard = this.dom.logNotes.closest('article.card');
            if (logFormCard) logFormCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        },
        confirmDeleteLogOnScreen3(logId) { /* ... same ... */ },
        deleteLogOnScreen3(logId) { /* ... same ... */ },

        showModal(modalId) { 
            const modal = document.getElementById(modalId); 
            if (modal) {
                this.data.previouslyFocusedElement = document.activeElement;
                modal.style.display = 'flex'; // Use flex for centering
                requestAnimationFrame(() => modal.classList.add('active')); // For transition
                const firstFocusable = modal.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                if (firstFocusable) firstFocusable.focus();
            }
        },
        hideModal(modalId) { 
            const modal = document.getElementById(modalId); 
            if (modal) {
                modal.classList.remove('active');
                // Listen for transition end to set display:none, or just use timeout
                setTimeout(() => { modal.style.display = 'none'; }, 300); // Match animation duration
            }
            if (this.data.previouslyFocusedElement) {
                try { this.data.previouslyFocusedElement.focus(); } catch (e) { /* ignore */ }
                this.data.previouslyFocusedElement = null;
            }
        },
        showToast(message, type = 'info', duration = 3000, iconName = '') {
            if (!this.dom.toastContainer) { /* ... error handling ... */ return; }
            const toast = document.createElement('div');
            toast.className = `toast-message ${type}`;
            const iconHTML = iconName ? `<span class="icon">${getIcon(iconName)}</span>` : 
                             (type === 'success' ? `<span class="icon">${getIcon('CHECK')}</span>` : 
                             (type === 'error' || type === 'warning' ? `<span class="icon">${getIcon('ALERT_TRIANGLE')}</span>` :
                             `<span class="icon">${getIcon('INFO')}</span>`));
            toast.innerHTML = `${iconHTML} ${message}`;
            toast.setAttribute('role', 'alert');
            this.dom.toastContainer.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.parentNode === this.dom.toastContainer && this.dom.toastContainer.removeChild(toast), { once: true });
            }, duration);
        },
        showConfirmationModal(message, onConfirm, onCancel = null, confirmButtonText = 'Confirm', confirmButtonClass = 'button-danger', title = 'Confirm Action') {
            this.dom.modals.confirmAction.querySelector('.modal-title').textContent = title;
            this.dom.confirmActionMessage.innerHTML = message;
            this.dom.btnConfirmActionConfirm.textContent = confirmButtonText;
            this.dom.btnConfirmActionConfirm.className = `button ${confirmButtonClass}`; 
            this.dom.btnConfirmActionConfirm.onclick = () => { onConfirm(); this.hideModal('modal-confirm-action'); };
            this.dom.btnConfirmActionCancel.onclick = () => { if (onCancel) onCancel(); this.hideModal('modal-confirm-action'); };
            this.showModal('modal-confirm-action');
        },
    };

    document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
